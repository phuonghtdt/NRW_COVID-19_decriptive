---
title: "COVIMOD"
output:  
  html_document:
    toc: true
    toc_float: true
    theme: united
    fig_caption: yes
    toc_depth: 6
editor_options: 
  chunk_output_type: console
---

#set up
```{r Options, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(fig.retina = 1, fig.height = 7, fig.width = 7,
                      echo = FALSE, message = FALSE, warning = FALSE,
                      results='hide')
Sys.setlocale("LC_TIME", "C")
BEGIN_RMD <- Sys.time() # Keeping track of running time
USER <- "Phuong"
set.seed(75876342)
options(warn = 1) # If warn is one, warnings are printed as they occur.

path_figures <- "C:/Users/huynh/sciebo/NRW_descriptive/results/covimod_NRW_valid code"

# current_file <- "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/old_questionnaire/complete wave 13_anonymised.RData"
# current_file <- "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/new_questionnaire/complete wave 32_anonymised.RData"
# load(current_file, .GlobalEnv)
a_wave <-32


```

```{r}
#at which number should group contacts be truncated?
truncate <- 100 #question 100 ?
truncate_lshtm <- 50 #
current_wave <-32


```

#library

Date: <b>`r format(Sys.Date(), "%B %d, %Y")`</b>

All computations were performed with `r R.Version()$version.string`.

```{r Packages}
# {r Packages, echo = TRUE, message = TRUE, warning = TRUE, results='markup', comment=""}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(epiDisplay)
library(socialmixr)
library(data.table)
library(Hmisc)
library(epiDisplay)
library(summarytools)
library(patchwork)
# library(ggthemr)# no package possible
library(gtsummary)
library(table1)
library(readxl)
library(reshape2)
library(kableExtra)
library(DescTools)
library(randomcoloR)
library(table1)
library(expss)
library(Cairo)
library(cowplot)
library(oxcgrt)
library(dplyr)
library(scales)
library(ggpubr)
library(stringr)
library(lubridate)
library(openxlsx)

```

#Function

```{r Functions}
`%notin%` <- Negate(`%in%`)

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3, round.integers = F), 
       c("",
         "Mean (SD)"=sprintf("%s (%s)", MEAN, SD), 
         "Median (Min, Max)"=sprintf("%s [%s, %s]", MEDIAN, MIN, MAX),
         "Median (P25, P75)"=sprintf("%s [%s, %s]", MEDIAN, q25, q75)))
}

hh_contact_number <- function(x, new_id, wave) {
  dummy_hh <- data.table(x)
  dummy_hh <- dummy_hh %>% 
    filter(dummy_hh$hh_met_this_day == "Yes") # only hh member actually met!!!
  if(sum(is.na(dummy_hh$new_id)) > 0) { message("new_id has NAs!") }
  dummy_hh <- dummy_hh %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(hh_contact_n = n())
  return(dummy_hh)
}

non_hh_contact_number <- function(x, new_id, wave) {
  dummy_outside <- data.table(x)
  if(sum(is.na(dummy_outside$new_id)) > 0) { message("new_id has NAs!") }
  dummy_outside <- dummy_outside %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(non_hh_contact_n = n())
  
  dummy_work <- data.table(x)
  dummy_work <- dummy_work %>% 
    filter(place_work == "Yes")
  dummy_work <- dummy_work %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(work_contact_n = n())
  dummy_all <- merge(dummy_outside, dummy_work, by = c("new_id", "wave"), all = T)
  rm(dummy_outside, dummy_work)
  
  dummy_homeown <- data.table(x)
  dummy_homeown <- dummy_homeown %>% 
    filter(place_home_own == "Yes")
  dummy_homeown <- dummy_homeown %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(home_own_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_homeown, by = c("new_id", "wave"), all = T)
  rm(dummy_homeown)
  
  dummy_homeelse <- data.table(x)
  dummy_homeelse <- dummy_homeelse %>% 
    filter(place_home_else == "Yes")
  dummy_homeelse <- dummy_homeelse %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(home_else_contact_n = n())
  dummy_all <- merge(dummy_all, dummy_homeelse, by = c("new_id", "wave"), all = T)
  rm(dummy_homeelse)
  
  dummy_worship <- data.table(x)
  dummy_worship <- dummy_worship %>% 
    filter(place_worship=="Yes")
  dummy_worship <- dummy_worship %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(worship_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_worship, by = c("new_id", "wave"), all = T)
  rm(dummy_worship)
  
  dummy_transport <- data.table(x)
  dummy_transport <- dummy_transport %>% 
    filter(place_transport=="Yes")
  dummy_transport <- dummy_transport %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(transport_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_transport, by = c("new_id", "wave"), all = T)
  rm(dummy_transport)
  
  dummy_school <- data.table(x)
  dummy_school <- dummy_school %>% 
    filter(place_school=="Yes")
  dummy_school <- dummy_school %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(school_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_school, by = c("new_id", "wave"), all = T)
  rm(dummy_school)
  
  dummy_shop_essential <- data.table(x)
  dummy_shop_essential <- dummy_shop_essential %>% 
    filter(place_shop_essential=="Yes")
  dummy_shop_essential <- dummy_shop_essential %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(shop_essential_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_shop_essential, by = c("new_id", "wave"), all = T)
  rm(dummy_shop_essential)
  
  dummy_shop_non_essential <- data.table(x)
  dummy_shop_non_essential <- dummy_shop_non_essential %>% 
    filter(place_shop_non_essential=="Yes")
  dummy_shop_non_essential <- dummy_shop_non_essential %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(shop_non_essential_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_shop_non_essential, by = c("new_id", "wave"), all = T)
  rm(dummy_shop_non_essential)
  
  dummy_entertainment <- data.table(x)
  dummy_entertainment <- dummy_entertainment %>% 
    filter(place_entertainment=="Yes")
  dummy_entertainment <- dummy_entertainment %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(entertainment_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_entertainment, by = c("new_id", "wave"), all = T)
  rm(dummy_entertainment)
  
  dummy_sport <- data.table(x)
  dummy_sport <- dummy_sport %>% 
    filter(place_sport=="Yes")
  dummy_sport <- dummy_sport %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(sport_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_sport, by = c("new_id", "wave"), all = T)
  rm(dummy_sport)
  
  dummy_park <- data.table(x)
  dummy_park <- dummy_park %>% 
    filter(place_park=="Yes") 
  dummy_park <- dummy_park %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(park_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_park, by = c("new_id", "wave"), all = T)
  rm(dummy_park)
  
  dummy_healthcare <- data.table(x)
  dummy_healthcare <- dummy_healthcare %>% 
    filter(place_healthcare=="Yes") 
  dummy_healthcare <- dummy_healthcare %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(healthcare_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_healthcare, by = c("new_id", "wave"), all = T)
  rm(dummy_healthcare)
  
  dummy_beauty <- data.table(x)
  dummy_beauty <- dummy_beauty %>% 
    filter(place_beauty=="Yes") 
  dummy_beauty <- dummy_beauty %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(beauty_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_beauty, by = c("new_id", "wave"), all = T)
  rm(dummy_beauty)
  
  dummy_multiple <- data.table(x)
  dummy_multiple <- dummy_multiple %>% 
    filter(place_multiple==1) 
  dummy_multiple <- dummy_multiple %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(multiple_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_multiple, by = c("new_id", "wave"), all = T)
  rm(dummy_multiple)
  
  dummy_other <- data.table(x)
  dummy_other <- dummy_other %>%
    filter(!is.na(place_oth))
  dummy_other <- dummy_other %>%
    group_by(new_id, wave) %>%
    dplyr::summarise(oth_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_other, by = c("new_id", "wave"), all = T)
  rm(dummy_other)
  
  dummy_not_specified <- data.table(x)
  dummy_not_specified <- dummy_not_specified %>%
  filter(
    (place_home_own!="Yes" |is.na(place_home_own)) &
      (place_home_else!="Yes" |is.na(place_home_else)) &
      (place_work!="Yes" |is.na(place_work)) &
      (place_worship!="Yes" |is.na(place_worship)) &
      (place_transport!="Yes" |is.na(place_transport)) &
      (place_school!="Yes" |is.na(place_school)) &
      (place_shop_essential!="Yes" |is.na(place_shop_essential)) &
      (place_shop_non_essential!="Yes" |is.na(place_shop_non_essential)) &
      (place_entertainment!="Yes" |is.na(place_entertainment)) &
      (place_sport!="Yes" |is.na(place_sport)) &
      (place_park!="Yes" |is.na(place_park)) &
      (place_healthcare!="Yes" |is.na(place_healthcare)) &
      (place_beauty!="Yes" |is.na(place_beauty)) &
      (place_oth!=1 | is.na(place_oth))
        )
  dummy_not_specified <- dummy_not_specified %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(not_specified_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_not_specified, by = c("new_id", "wave"), all = T)
  rm(dummy_not_specified)
  
  
dummy_leisure <- data.table(dt_outside_all)
dummy_leisure <- dummy_leisure %>% 
  filter(place_home_own=="Yes" | place_home_else=="Yes" | place_worship=="Yes" | 
           place_shop_non_essential=="Yes" | place_entertainment=="Yes" | place_sport=="Yes" | place_park=="Yes" | place_beauty=="Yes") 
dummy_leisure <- dummy_leisure %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(leisure_contact_n=n())
dummy_all <- merge(dummy_all, dummy_leisure, by = c("new_id", "wave"), all = T)
rm(dummy_leisure)

dummy_other_combined<- data.table(dt_outside_all)
dummy_other_combined <- dummy_other_combined %>% 
  filter(place_transport=="Yes" | place_healthcare=="Yes" | place_oth==1 | place_shop_essential=="Yes") 
dummy_other_combined <- dummy_other_combined %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(other_combined_contact_n=n())
dummy_all <- merge(dummy_all, dummy_other_combined, by = c("new_id", "wave"), all = T)
rm(dummy_other_combined) 

  return(dummy_all)
}

my.bar.charts.incl.hh <- function(x) {
  dataset_long <- x
  p1 <- ggplot(dataset_long, 
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p1)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type,",
                      "data = dataset_long,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
  
  p2 <- ggplot(dataset_long,
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    facet_wrap( ~ age_group) +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "none",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p2)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type + age_group,",
                      "data = dataset_long,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
}

my.bar.charts.excl.hh <- function(x, exclude_hh_phrase) {
  dataset_long <- x
  p1 <- ggplot(subset(dataset_long, contact_type != exclude_hh_phrase), 
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p1)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type,",
                      "data = subset(dataset_long, contact_type != '", exclude_hh_phrase, "'),",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
  
  p2 <- ggplot(subset(dataset_long, contact_type != exclude_hh_phrase),
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    facet_wrap( ~ age_group) +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "none",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p2)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type + age_group,",
                      "data = subset(dataset_long, contact_type != '", exclude_hh_phrase, "'),",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
}

my.boxplots <- function(x, current_contact_variable, TITLE) {
  WORK <- grep("work", current_contact_variable)
  SCHOOL <- grep("school", current_contact_variable)
  
  if(length(WORK) > 0) {
    dataset_wide <- subset(x, job %in% has_work_contacts)
  } else if(length(SCHOOL) > 0) {
    dataset_wide <- subset(x, job == "Student/Pupil" | school %in% has_school_contacts)
  } else {
    dataset_wide <- x
  }
  
  dummy_N <- dataset_wide[, c("wave", current_contact_variable)]
  # # NOT RUN: Table 1 shows N per group
  # dummy_N <- dummy_N %>% 
  #   group_by(wave) %>% 
  #   dplyr::summarise(N_ID=n())
  # levels(dataset_wide[, "wave"]) <- paste0(dummy_N$wave, " (n =",
  #                                          dummy_N$N_ID, ")")
  # rm(dummy_N)
  
  p1 <- ggplot(dataset_wide, aes_string(x = "wave", y = current_contact_variable)) +  
    geom_boxplot() + 
    scale_y_continuous(trans=scales::pseudo_log_trans(base = 10))+ 
    xlab("Date") +
    ylab("Number of contacts") +
    ggtitle(TITLE) +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p1)
  
  text2eval <- paste0("table1::table1(~ ",
                      current_contact_variable,
                      " | wave, data = dataset_wide,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
  
  names(dummy_N) <- c("wave", "contact_n")
  dummy_N <- dummy_N %>%
    group_by(wave) %>%
    summarise(MEAN = mean(contact_n),
              SD = sd(contact_n),
              MEDIAN = median(contact_n),
              MIN = min(contact_n),
              MAX = max(contact_n),
              IQR = IQR(contact_n))

  p2 <- ggplot(data = dummy_N) +  
    geom_point(aes_string(x = "wave", y = "MEAN"), colour = "red", size = 1.25, shape = 15) +
    geom_line(aes_string(x = "wave", y = "MEAN"), colour = "red", group = "wave") +
    geom_point(aes_string(x = "wave", y = "MEDIAN"), colour = "blue", size = 1.25, shape = 17) +
    geom_line(aes_string(x = "wave", y = "MEDIAN"), colour = "blue", group = "wave") +
    scale_y_continuous(limits = c(0, max(c(1, dummy_N$MEAN, dummy_N$MEDIAN)))) + 
    xlab("Date") +
    ylab("Mean contacts (red squares) /\nMedian number of contacts (blue circles)") +
    ggtitle(TITLE) +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p2)
  
  p3 <- ggplot(dataset_wide, aes_string(x = "wave", y = current_contact_variable)) +  
    geom_boxplot() + 
    facet_wrap( ~ age_group) +
    # stat_summary(fun=mean, geom="point", shape=20, size=5, color="red", fill="red") +
    scale_y_continuous(trans=scales::pseudo_log_trans(base = 10))+ 
    xlab("Date") +
    ylab("Number of contacts") +
    ggtitle(TITLE) +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p3)
  
  text2eval <- paste0("table1::table1(~ ",
                      current_contact_variable,
                      " | wave + age_group, data = dataset_wide,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
}
```

#Wave label

```{r Vectors to use}
WAVES <- c("30.04.–06.05. (W01)",
           "14.05.–21.05. (W02)",
           "28.05.–04.06. (W03)",
           "11.06.–22.06. (W04)",
           "26.06.–01.07. (W05)",
           "09.07.–16.07. (W06)",
           "24.07.–29.07. (W07)",
           "07.08.–11.08. (W08)",
           "04.09.–09.09. (W09)",
           "30.09.–05.10. (W10)",
           "14.10.–21.10. (W11)",
           "29.10.–03.11. (W12)",
           "05.11.–10.11. (W13)", 
           "25.11.-30.11. (W14)",
           "09.12.-15.12. (W15)",
           "23.12.-30.12. (W16)", 
           "28.01.-02.02. (W17)", 
           "24.02.-03.03. (W18)", 
           "17.03.-26.03. (W19)",
           "07.04.-15.04. (W20)",
           "12.05.-24.05. (W21)",
           "26.05.-03.06. (W22)", 
           "09.06.-22.06. (W23)", 
           "07.07.-19.07. (W24)", 
           "04.08.-13.08. (W25)", 
           "01.09.-14.09. (W26)",
           "22.09.-06.10. (W27)", 
           "08.10.-20.10. (W28)", 
           "22.10.-02.11. (W29)",
           "03.11.-09.11. (W30)", 
           "17.11.-23.11. (W31)",
           "tobe_filled. (W32)")




places <- c("place_home_own",
            "place_home_else",
            "place_work",
            "place_worship",
            "place_transport",
            "place_school",
            "place_shop_essential", 
            "place_shop_non_essential",
            "place_entertainment",
            "place_sport",
            "place_park",
            "place_healthcare",
            "place_beauty",
            "place_oth")
LABEL_PLACES <- c("Own home",
                  "Somebody else's home",
                  "Work",
                  "Worship",
                  "Transport",
                  "School/Uni/Kindergarten",
                  "Essential shopping",
                  "Non-essential shopping",
                  "Entertainment",
                  "Sport",
                  "Park",
                  "Healthcare",
                  "Beauty",
                  "Other",
                  "Not specified",
                  "Multiple locations")
CONTACT_N <- sub("place_", "", places)
CONTACT_N <- paste0(CONTACT_N, "_contact_n")

WEIGHTING <- c("Unweighted", "Weights age & household size")
HH_OUTSIDE <- c()

base_size <- 10
palette <- c("#003366", "#336699", "#CCFFFF", "#028482", "#663399", "#990033", "#FF3333", "#FF9900", 
             "#266A2E", "#55D43F", "#404040", "#C87533", "#DCDCDC", "#FFDE00", "#F1B2E1", "#FF717E")
print(palette)
scales::show_col(palette)

```

#data input
##old questionaire

```{r Data information old questionnaire, i.e. wave 1 to 13, results='markup', comment=""}

# DATA <- list.files(path = "C:/Users/jaeger/Desktop/vom server/COVID_Polymod/Data/anonymized/currently_analysed/old_questionnaire/",
#                    pattern = "RData",
#                    full.names = TRUE)

DATA <- list.files(path = "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/old_questionnaire",
                   pattern = "RData",
                   full.names = TRUE)

# all files must have the same structure:
## d_self_anonymised
## dt_hh_anonymised
## dt_outside_anonymised
counter <- 0
for(current_file in DATA) {
  counter <- counter + 1
  load(current_file, .GlobalEnv) # , verbose=TRUE)
  WAVE <- current_file
# WAVE <- sub(paste0("C[:]/Users/", USER, "/sciebo/Contact[-]a[-]thon/COVIMOD/COVIMOD_WAVE "),
#            "", WAVE)
  WAVE <- sub("C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/old_questionnaire/complete wave ", "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))  
  
  # for(current_variable in names(d_self_anonymised)) {
  #   if(class(d_self_anonymised[, current_variable])[1] %in% c("factor", "haven_labelled")) { 
  #     d_self_anonymised[, current_variable] <- unclass(d_self_anonymised[, current_variable])
  #   }
  # }
  
#  d_self_anonymised <- d_self_anonymised %>% select(new_id,wave_0, date_DD_0, date_MM_0, date_YYYY_0,gender_0, sex, age_0, age_group,job, school, student_nursery, student_school, student_college, student_university, bundesland_0, hh_type_0, hh_p_excl_0, (starts_with("Q7"))) ####CAVE to do => later also include date, sex, Q74
  
  d1 <- as.data.frame(names(d_self_anonymised))
  names(d1) <- "variable"
  d1$wave <- WAVE
  d1$dataset <- "d_self"
  d1$included <- NA_character_
  d_self_anonymised$hh_p_excl_0 <- as.integer(as.character(d_self_anonymised$hh_p_excl_0))
  for(current_column in 1:length(names(d_self_anonymised))) {
    d1$included[current_column] <- paste0(class(d_self_anonymised[, current_column]),
                                          collapse = ", ")
  }  
  
  # place_12 = "An einem anderen Ort (bitte angeben)" -> renamed place_oth
  dt_hh_anonymised$place_12 <- NULL  
  # for(current_variable in names(dt_hh_anonymised)) {
  #   if(class(dt_hh_anonymised[, current_variable])[1] %in% c("factor", "haven_labelled")) { 
  #     dt_hh_anonymised[, current_variable] <- unclass(dt_hh_anonymised[, current_variable])
  #   }
  # }
  
  
#dt_hh_anonymised <- dt_hh_anonymised %>% select(new_id,contact_id, age_group, sex, job, school, starts_with("student_"), time_before_COV, skin, starts_with("place_"), time_hh, time_mm, hh_met_this_day)
  
d2 <- as.data.frame(names(dt_hh_anonymised))
names(d2) <- "variable"
d2$wave <- WAVE
d2$dataset <- "dt_hh"
d2$included <- NA_character_
for(current_column in 1:length(names(dt_hh_anonymised))) {
  d2$included[current_column] <- paste0(class(dt_hh_anonymised[, current_column]),
                                          collapse = ", ")
}  
  
#dt_outside_anonymised <- dt_outside_anonymised %>% select(new_id,contact_id, age_group, sex, relation, time_before_COV, skin, starts_with("place_"), time_hh, time_mm)

  # place_12 = "An einem anderen Ort (bitte angeben)" -> renamed place_oth
  dt_outside_anonymised$place_12 <- NULL
  # for(current_variable in names(dt_outside_anonymised)) {
  #   if(class(dt_outside_anonymised[, current_variable])[1] %in% c("factor", "haven_labelled")) { 
  #     dt_outside_anonymised[, current_variable] <- unclass(dt_outside_anonymised[, current_variable])
  #   }
  # }
  
  d3 <- as.data.frame(names(dt_outside_anonymised))
  names(d3) <- "variable"
  d3$wave <- WAVE
  d3$dataset <- "dt_outside"
  d3$included <- NA_character_
  for(current_column in 1:length(names(dt_outside_anonymised))) {
    d3$included[current_column] <- paste0(class(dt_outside_anonymised[, current_column]),
                                          collapse = ", ")
  }  
  
  aux <- merge(d1, d2, all = TRUE)
  aux <- merge(aux, d3, all = TRUE)
  
  if(counter == 1) {
    info_long <- aux
  } else {
    info_long <- merge(info_long, aux, all = TRUE)
  }
  rm(d1, d2, d3, aux, d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

info_wide <- spread(info_long, wave, included)

```

##new questionaire

```{r Data information new questionnaire, i.e. wave 14 onwards, results='markup', comment=""}
# 
# DATA_new <- list.files(path = "C:/Users/jaeger/Desktop/vom server/COVID_Polymod/Data/anonymized/currently_analysed/new_questionnaire/",
#                    pattern = "RData",
#                    full.names = TRUE)

DATA_new <- list.files(path = "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/new_questionnaire",
                       pattern = "RData",
                       full.names = TRUE)

# all files must have the same structure:
## d_self_anonymised
## dt_hh_anonymised
## dt_outside_anonymised
counter <- 0
for(current_file in DATA_new) {
  counter <- counter + 1
  load(current_file, .GlobalEnv) # , verbose=TRUE)
  WAVE <- current_file
  
  # WAVE <- sub("C:/Users/jaeger/Desktop/vom server/COVID_Polymod/Data/anonymized/currently_analysed/new_questionnaire/complete wave ", "", WAVE)
  
  WAVE <- sub("C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/new_questionnaire/complete wave ", "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))
  print(WAVE)
  
  #  d_self_anonymised <- d_self_anonymised %>% select(new_id,wave_0, date_DD_0, date_MM_0, date_YYYY_0,gender_0, sex, age_0, age_group,job, school, bundesland_0, hh_p_incl_0, starts_with("Q7"), starts_with("Q8")) ####CAVE to do => later also include date, sex, Q74, etc
  
  d1 <- as.data.frame(names(d_self_anonymised))
  names(d1) <- "variable"
  d1$wave <- WAVE
  d1$dataset <- "d_self"
  d1$included <- NA_character_
  for(current_column in 1:length(names(d_self_anonymised))) {
    d1$included[current_column] <- paste0(class(d_self_anonymised[, current_column]),
                                          collapse = ", ")
  }
  
  dt_hh_anonymised$place_12 <- NULL
  # dt_hh_anonymised <- dt_hh_anonymised %>% select(new_id,contact_id, age_group, sex, job, school, starts_with("student_"), time_before_COV, starts_with("skin"), starts_with("place_"), con_time, hh_met_this_day)
  
  
  
  d2 <- as.data.frame(names(dt_hh_anonymised))
  names(d2) <- "variable"
  d2$wave <- WAVE
  d2$dataset <- "dt_hh"
  d2$included <- NA_character_
  for(current_column in 1:length(names(dt_hh_anonymised))) {
    d2$included[current_column] <- paste0(class(dt_hh_anonymised[, current_column]),
                                          collapse = ", ")
  }
  
  # place_12 = "An einem anderen Ort (bitte angeben)" -> renamed place_oth
  dt_outside_anonymised$place_12 <- NULL
  
  #  dt_outside_anonymised2 <- dt_outside_anonymised %>% select(new_id,contact_id, age_group, sex, relation, relation_child, time_before_COV, starts_with("skin"), starts_with("place_"), con_time)
  
  d3 <- as.data.frame(names(dt_outside_anonymised))
  names(d3) <- "variable"
  d3$wave <- WAVE
  d3$dataset <- "dt_outside"
  d3$included <- NA_character_
  for(current_column in 1:length(names(dt_outside_anonymised))) {
    d3$included[current_column] <- paste0(class(dt_outside_anonymised[, current_column]),
                                          collapse = ", ")
  }
  
  aux <- merge(d1, d2, all = TRUE)
  aux <- merge(aux, d3, all = TRUE)
  
  if(counter == 1) {
    info_long_new <- aux
  } else {
    info_long_new <- merge(info_long_new, aux, all = TRUE)
  }
  rm(d1, d2, d3, aux, d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

info_wide_new <- spread(info_long_new, wave, included)

```

#merge data
## wave 1 to 13

```{r Read and merge wave 1 to 13 data, comment="", include=FALSE, results='markup'}
# not the same class across waves:
# contact_id / dt_hh
# contact_id / dt_outside

counter <- 0
for(current_file in DATA) {
  counter <- counter + 1
  
  ##for each wave check manually
  # current_file <- "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/data_anonymised/old_questionnaire/complete wave 8_anonymised.RData"
  
  load(current_file, .GlobalEnv)
  WAVE <- current_file
  WAVE <- sub("C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/old_questionnaire/complete wave ", "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))  
  
  print(WAVE)
  print(sum(is.na(d_self_anonymised$new_id)))
  d_self_anonymised$wave <- WAVE
  d_self_anonymised$questionnaire <- "old"
  #  d_self_anonymised <- d_self_anonymised %>% select(new_id,wave, date_DD_0, date_MM_0, date_YYYY_0,gender_0, sex, age_0, age_group,job, school, student_nursery, student_school, student_college, student_university, bundesland_0, hh_type_0, hh_p_excl_0, (starts_with("Q7")), questionnaire) ####CAVE to do => later also include date, sex, Q74
  
  d_self_anonymised$hh_p_excl_0 <- as.integer(as.character(d_self_anonymised$hh_p_excl_0))
  d_self_anonymised$hh_p_excl_0[which(d_self_anonymised$hh_p_excl_0 > 11)] <- 11
  d_self_anonymised$contact_id <- as.integer(as.character(d_self_anonymised$contact_id))
  d_self_anonymised$Q21 <- as.integer(as.character(d_self_anonymised$Q21))
  
  # Q74_0 gets additional label ("I did not have any contacts") during waves
  # 1        I individually included every person I had contact with.
  # 2 I did not individually include every person I had contact with.
  # 3                                    I did not have any contacts.
  if(WAVE >= 3) { # new variable in wave 3
    d_self_anonymised$Q74_0 <- as.integer(as.character(d_self_anonymised$Q74_0)) 
  }
  for(current_variable in names(d_self_anonymised)) {
    if(class(d_self_anonymised[, current_variable])[1] %in% c("factor")) { 
      d_self_anonymised[, current_variable] <- as.character(d_self_anonymised[, current_variable])
    }
    if(class(d_self_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      d_self_anonymised[, current_variable] <- as.integer(d_self_anonymised[, current_variable])
    }
  }
  
  dt_hh_anonymised$wave <- WAVE
  dt_hh_anonymised$questionnaire <- "old"
  #  dt_hh_anonymised <- dt_hh_anonymised %>% select(new_id,wave, contact_id, age_group, sex, job, school, starts_with("student_"), time_before_COV, skin, starts_with("place_"), time_hh, time_mm, hh_met_this_day)
  dt_hh_anonymised$place_12 <- NULL
  dt_hh_anonymised$contact_id <- as.double(as.character(dt_hh_anonymised$contact_id))
  for(current_variable in names(dt_hh_anonymised)) {
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_hh_anonymised[, current_variable] <- as.character(dt_hh_anonymised[, current_variable])
    }
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_hh_anonymised[, current_variable] <- as.integer(dt_hh_anonymised[, current_variable])
    }
  }
  
  dt_outside_anonymised$wave <- WAVE
  dt_outside_anonymised$questionnaire <- "old"
  #  dt_outside_anonymised <- dt_outside_anonymised %>% select(new_id,contact_id, wave, age_group, sex, relation, time_before_COV, skin, starts_with("place_"), time_hh, time_mm)
  dt_outside_anonymised$place_12 <- NULL
  dt_outside_anonymised$contact_id <- as.integer(as.character(dt_outside_anonymised$contact_id))
  for(current_variable in names(dt_outside_anonymised)) {
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_outside_anonymised[, current_variable] <- as.character(dt_outside_anonymised[, current_variable])
    }
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_outside_anonymised[, current_variable] <- as.integer(dt_outside_anonymised[, current_variable])
    }
  }  
  
  # rename datasets and combine all waves
  if(counter == 1) { # first wave
    d_self_all <- d_self_anonymised
    dt_hh_all <- dt_hh_anonymised
    dt_outside_all <- dt_outside_anonymised
  } else { # missing columns will be filled with NA
    d_self_all <- bind_rows(d_self_all, d_self_anonymised)
    dt_hh_all <- bind_rows(dt_hh_all, dt_hh_anonymised)
    dt_outside_all <- bind_rows(dt_outside_all, dt_outside_anonymised)
  }
  rm(d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

```

## wave 14 to 28

```{r Read and merge wave 14 to 28 data, comment="", include=FALSE, results='markup'}
#not the same class across waves:
# contact_id / dt_hh
# contact_id / dt_outside

counter <- 0
for(current_file in DATA_new) {
  counter <- counter + 1
  # #for each wave check manually
  # current_file <- "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/data_anonymised/new_questionnaire/complete wave 27_anonymised.RData"
 
  load(current_file, .GlobalEnv)
  WAVE <- current_file
  WAVE <- sub("C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/wave 1 to 32/new_questionnaire/complete wave ", "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))  
  
  print(WAVE)
  print(sum(is.na(d_self_anonymised$new_id)))
  d_self_anonymised$wave <- WAVE
  d_self_anonymised$questionnaire<-"new"
  ######################### on/off
  # d_self_anonymised <- d_self_anonymised %>% select(new_id,wave, date_DD_0, date_MM_0, date_YYYY_0,gender_0, sex, age_0, age_group,job, school, bundesland_0, hh_p_incl_0, starts_with("Q7"), starts_with("Q8"), questionnaire) ####CAVE to do => later also include date, sex, Q74, etc
  #########################

  #FOR NOW!!! NEED TO CHANGE THAT!!!
  #d_self_anonymised2 <- d_self_anonymised %>% select(new_id, wave, date_DD_0, date_MM_0, date_YYYY_0,gender_0, sex, age_0, age_group,job, school, bundesland_0, hh_p_incl_0, starts_with("Q7"), starts_with("Q8"), number_d, questionnaire) ####CAVE to do => later also include date, sex, Q74, etc
  
  
  for(current_variable in names(d_self_anonymised)) {
    if(class(d_self_anonymised[, current_variable])[1] %in% c("factor")) { 
      d_self_anonymised[, current_variable] <- as.character(d_self_anonymised[, current_variable])
    }
    if(class(d_self_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      d_self_anonymised[, current_variable] <- as.integer(d_self_anonymised[, current_variable])
    }
  }
  
  dt_hh_anonymised$wave <- WAVE
  dt_hh_anonymised$questionnaire<-"new"
  
  ################################# on/off
 # dt_hh_anonymised <- dt_hh_anonymised %>% select(new_id,contact_id, wave, age_group, sex, job,  school, starts_with("student_"), time_before_COV, starts_with("skin"), starts_with("place_"), con_time, hh_met_this_day)
  ##############################

  dt_hh_anonymised$place_12 <- NULL
  dt_hh_anonymised$contact_id <- as.double(as.character(dt_hh_anonymised$contact_id))
 
  for(current_variable in names(dt_hh_anonymised)) {
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_hh_anonymised[, current_variable] <- as.character(dt_hh_anonymised[, current_variable])
    }
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_hh_anonymised[, current_variable] <- as.integer(dt_hh_anonymised[, current_variable])
    }
  }
  
  dt_outside_anonymised$wave <- WAVE
  dt_outside_anonymised$questionnaire<-"new"
  ###########################on/off
 # dt_outside_anonymised2 <- dt_outside_anonymised %>% select(new_id,contact_id, wave, age_group, sex, relation, relation_child, time_before_COV, starts_with("skin"), starts_with("place_"), con_time)
 ###############################

  dt_outside_anonymised$place_12 <- NULL
  dt_outside_anonymised$contact_id <- as.integer(as.character(dt_outside_anonymised$contact_id))

  for(current_variable in names(dt_outside_anonymised)) {
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_outside_anonymised[, current_variable] <- as.character(dt_outside_anonymised[, current_variable])
    }
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_outside_anonymised[, current_variable] <- as.integer(dt_outside_anonymised[, current_variable])
    }
  }  

skin_integer <- c("skin_skin_to_skin","skin_kept_dist_2m" ,"skin_kept_dist_1m", "skin_dist_less_1m", "skin_wore_mask", "skin_washsan_bef" , "skin_washsan_aft", "skin_prefer_not_to_say", "skin_none_of_these", "skin_dont_know")
  
  dt_hh_anonymised$contact_id <- as.integer(dt_hh_anonymised$contact_id)#in all data set is numeric, but it does not affect...
  
  dt_outside_anonymised$contact_id <- as.integer(dt_outside_anonymised$contact_id)
  dt_outside_anonymised$contact <- as.integer(dt_outside_anonymised$contact)

  # all variables below is NAs?????
  d_self_anonymised$q79a <- as.integer(d_self_anonymised$q79a)
  d_self_anonymised$q79c <- as.integer(d_self_anonymised$q79c)
  d_self_anonymised$Q80a <- as.integer(d_self_anonymised$Q80a)
  d_self_anonymised$Q80c <- as.integer(d_self_anonymised$Q80c)
  d_self_anonymised$Q81a <- as.integer(d_self_anonymised$Q81a)
  d_self_anonymised$Q81c <- as.integer(d_self_anonymised$Q81c)
  d_self_anonymised$Q21_scale <- as.character(d_self_anonymised$Q21_scale)
  
     d_self_all <- bind_rows(d_self_all, d_self_anonymised)
    dt_hh_all <- bind_rows(dt_hh_all, dt_hh_anonymised)
    dt_outside_all <- bind_rows(dt_outside_all, dt_outside_anonymised)




  rm(d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

```

##NRW
Variable: bundesland_0 == "Nordrhein-Westfalen"

```{r}
d_self_all<- d_self_all%>%filter(bundesland_0 == "Nordrhein-Westfalen")
obs_wave_upto21 <- 1560+1356+1081+1890+1615+1496+1207+1022+869+739+1499+1500+1500+1490+1500+1499+997+1499+1498+1493+2468+2441+2485+2468+2480+2502+2492+2493+2487+2487+2489+2490 # 32 wave 


```


# translate group contacts

```{r translate the group contacts from wave 14 to 22 into wave 3 to 13 style}
# names wave 3-13   new names wave 14 onwards
# Q75_u18_work	    Q79_age_met_work_u18
# Q75_1864_work	    Q79_age_met_work_1864
# Q75_o64_work	    Q79_age_met_work_o64
# Q75_u18_school  	Q80a_age_met_uni_u18
# Q75_1864_school 	Q80a_age_met_uni_1864
# Q75_o64_school  	Q80a_age_met_uni_o64
# Q75_u18_else	    Q81a_age_met_else_u18
# Q75_1864_else	    Q81a_age_met_else_1864
# Q75_o64_else    	Q81a_age_met_else_o64
# Q76_u18_work    	Q79c_age_phys_work_u18
# Q76_1864_work   	Q79c_age_phys_work_1864
# Q76_o64_work    	Q79c_age_phys_work_o64
# Q76_u18_school  	Q80c_age_phys_uni_u18
# Q76_1864_school 	Q80c_age_phys_uni_1864
# Q76_o64_school  	Q80c_age_phys_uni_o64
# Q76_u18_else	    Q81c_age_phys_else_u18
# Q76_1864_else	    Q81c_age_phys_else_1864
# Q76_o64_else	    Q81c_age_phys_else_o64


d_self_all <- d_self_all %>% mutate (Q75_u18_work = ifelse(questionnaire=="new", Q79a_age_met_work_u18, Q75_u18_work))
d_self_all <- d_self_all %>% mutate (Q75_1864_work = ifelse(questionnaire=="new", Q79a_age_met_work_1864, Q75_1864_work))
d_self_all <- d_self_all %>% mutate (Q75_1864_work = ifelse(questionnaire=="new", Q79a_age_met_work_o64, Q75_o64_work))
d_self_all <- d_self_all %>% mutate (Q75_u18_school = ifelse(questionnaire=="new", Q80a_age_met_uni_u18, Q75_u18_school))
d_self_all <- d_self_all %>% mutate (Q75_1864_school = ifelse(questionnaire=="new", Q80a_age_met_uni_1864, Q75_1864_school))
d_self_all <- d_self_all %>% mutate (Q75_o64_school = ifelse(questionnaire=="new", Q80a_age_met_uni_o64, Q75_o64_school))
d_self_all <- d_self_all %>% mutate (Q75_u18_else = ifelse(questionnaire=="new", Q81a_age_met_else_u18, Q75_u18_else))
d_self_all <- d_self_all %>% mutate (Q75_1864_else = ifelse(questionnaire=="new", Q81a_age_met_else_1864, Q75_1864_else))
d_self_all <- d_self_all %>% mutate (Q75_o64_else = ifelse(questionnaire=="new", Q81a_age_met_else_o64, Q75_o64_else))
d_self_all <- d_self_all %>% mutate (Q76_u18_work = ifelse(questionnaire=="new", Q79c_age_phys_work_u18, Q76_u18_work))
d_self_all <- d_self_all %>% mutate (Q76_1864_work = ifelse(questionnaire=="new", Q79c_age_phys_work_1864, Q76_1864_work))
d_self_all <- d_self_all %>% mutate (Q76_o64_work = ifelse(questionnaire=="new", Q79c_age_phys_work_o64, Q76_o64_work))
d_self_all <- d_self_all %>% mutate (Q76_u18_school = ifelse(questionnaire=="new", Q80c_age_phys_uni_u18, Q76_u18_school))
d_self_all <- d_self_all %>% mutate (Q76_1864_school = ifelse(questionnaire=="new", Q80c_age_phys_uni_1864, Q76_1864_school))
d_self_all <- d_self_all %>% mutate (Q76_o64_school = ifelse(questionnaire=="new", Q80c_age_phys_uni_o64, Q76_o64_school))
d_self_all <- d_self_all %>% mutate (Q76_u18_else = ifelse(questionnaire=="new", Q81c_age_phys_else_u18, Q76_u18_else))
d_self_all <- d_self_all %>% mutate (Q76_1864_else = ifelse(questionnaire=="new", Q81c_age_phys_else_1864, Q76_1864_else))
d_self_all <- d_self_all %>% mutate (Q76_o64_else = ifelse(questionnaire=="new", Q81c_age_phys_else_o64, Q76_o64_else))

table1(~Q75_u18_work + Q75_1864_work + Q75_1864_work +
       Q75_u18_school + Q75_1864_school+ Q75_o64_school + Q75_u18_else +Q75_1864_else +Q75_o64_else | as.factor(wave), data=d_self_all)
  
```


#Cleaning data 
# remove work contacts from <15 year olds

```{r remove work contacts from <15 year olds}

#Set the work contacts of the < 15 year olds to 0
dummy <- d_self_all %>% select(new_id, wave, age_group, age_0)
dummynames<-c("new_id", "wave","age_group_participant", "age_0_participant")
colnames(dummy) <- dummynames

######################################
dt_outside_all<-  dt_outside_all[dt_outside_all$new_id %in% d_self_all$new_id, ] # subset NRW
######################################

dummy <- merge(dummy, dt_outside_all, by=c("new_id", "wave"), all.y=T) #check vaidity ??? what is contact_id?

dummy$place_work[(dummy$age_group_participant=="Under 1" | 
                                     dummy$age_group_participant=="1-4" |
                                     dummy$age_group_participant=="5-9" | 
                                     dummy$age_group_participant=="10-14") & 
                         dummy$place_work==1 ] <- 0


dt_outside_all <- dummy %>% select(-c(age_group_participant, age_0_participant)) # merge step above~subset NRW

rm(dummy)

```

#count multiple contact

```{r Count multiple contacts}
#########################################
dt_hh_all<- dt_hh_all[dt_hh_all$new_id %in% d_self_all$new_id, ] # subset NRW
########################################
dt_hh_all <- dt_hh_all %>% dplyr::mutate(place_multiple = rowSums(select(.,place_home_own:place_oth) == "Yes", na.rm=TRUE))
table(dt_hh_all$place_multiple)

dt_hh_all$place_multiple <- as.integer(dt_hh_all$place_multiple >= 2) # sum of at least 2 places

dt_outside_all <- dt_outside_all %>% dplyr::mutate(place_multiple = rowSums(select(.,place_home_own:place_oth) == "Yes", na.rm=TRUE))

table(dt_outside_all$place_multiple)

dt_outside_all$place_multiple <- as.integer(dt_outside_all$place_multiple >= 2)


```

# contacts per ID and wave

```{r Summarize number of contacts per ID and wave}
# All contacts (inside and outside)
hh_contacts <- hh_contact_number(dt_hh_all, new_id, wave)
outside_contacts <- non_hh_contact_number(dt_outside_all, new_id, wave)

nrow(d_self_all)
nrow(hh_contacts)      # must be <= nrow(d_self_all)
nrow(outside_contacts) # must be <= nrow(d_self_all)

d_all_wide <- merge(d_self_all, hh_contacts, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, outside_contacts, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }

# Inside contacts
aux_hh <- dt_hh_all %>% filter(place_inside=="Yes")
hh_contacts <- hh_contact_number(aux_hh, new_id, wave)

aux_outside <- dt_outside_all %>% filter(place_inside=="Yes")
outside_contacts <- non_hh_contact_number(aux_outside, new_id, wave)

nrow(d_self_all)
nrow(hh_contacts)      # must be <= nrow(d_self_all)
nrow(outside_contacts) # must be <= nrow(d_self_all)

# rename
names(hh_contacts) <- sub("_contact_n", "_contact_n_inside", names(hh_contacts))
names(outside_contacts) <- sub("_contact_n", "_contact_n_inside", names(outside_contacts))

d_all_wide <- merge(d_all_wide, hh_contacts, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, outside_contacts, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }

names(d_all_wide)


# Outside contacts
aux_hh <- dt_hh_all %>% filter(place_outside=="Yes")
hh_contacts <- hh_contact_number(aux_hh, new_id, wave)

aux_outside <- dt_outside_all %>% filter(place_outside=="Yes")
outside_contacts <- non_hh_contact_number(aux_outside, new_id, wave)

nrow(d_self_all)
nrow(hh_contacts)      # must be <= nrow(d_self_all)
nrow(outside_contacts) # must be <= nrow(d_self_all)

# rename
names(hh_contacts) <- sub("_contact_n", "_contact_n_outside", names(hh_contacts))
names(outside_contacts) <- sub("_contact_n", "_contact_n_outside", names(outside_contacts))

d_all_wide <- merge(d_all_wide, hh_contacts, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, outside_contacts, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }

# any NA in _contact_n means zero contacts in that setting
for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
  d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
}


# all contacts
d_all_wide$all_contact_n <- 
  d_all_wide$hh_contact_n + d_all_wide$non_hh_contact_n
d_all_wide$all_contact_n_inside <- 
  d_all_wide$hh_contact_n_inside + d_all_wide$non_hh_contact_n_inside
d_all_wide$all_contact_n_outside <- 
  d_all_wide$hh_contact_n_outside + d_all_wide$non_hh_contact_n_outside



# # duration of contact (ONLY NON-HH)
# #first categorise
# dt_outside_all$contact_duration_minutes <- dt_outside_all$time_hh * 60 + dt_outside_all$time_mm
# dt_outside_all$contact_duration_minutes[which(dt_outside_all$contact_duration_minutes > 24 * 60)] <- 24 * 60
# dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes<5]<-"<5"
# dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>4 & dt_outside_all$contact_duration_minutes<15]<-">=5 & <15"
# dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>14 & dt_outside_all$contact_duration_minutes<60]<-">=15 & <60"
# dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>59 & dt_outside_all$contact_duration_minutes<240]<-">=60 & <240"
# dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>239]<-">=240"
# 
# dt_outside_all$contact_duration_minutes_cat <- factor(dt_outside_all$contact_duration_minutes_cat, levels = c('<5','>=5 & <15','>=15 & <60','>=60 & <240','>=240'))
# 
# aux_dur_5 <- dt_outside_all %>% filter(contact_duration_minutes_cat=="<5")
# dur_5_contacts <- non_hh_contact_number(aux_dur_5, new_id, wave)
# aux_dur_5_15 <- dt_outside_all %>% filter(contact_duration_minutes_cat==">=5 & <15")
# dur_5_15_contacts <- non_hh_contact_number(aux_dur_5_15, new_id, wave)
# aux_dur_15_60 <- dt_outside_all %>% filter(contact_duration_minutes_cat==">=15 & <60")
# dur_15_60_contacts <- non_hh_contact_number(aux_dur_15_60, new_id, wave)
# aux_dur_60_240 <- dt_outside_all %>% filter(contact_duration_minutes_cat==">=60 & <240")
# dur_60_240_contacts <- non_hh_contact_number(aux_dur_60_240, new_id, wave)
# aux_dur_240 <- dt_outside_all %>% filter(contact_duration_minutes_cat==">=240")
# dur_240_contacts <- non_hh_contact_number(aux_dur_240, new_id, wave)
# 
# nrow(d_self_all)
# nrow(dur_5_contacts) # must be <= nrow(d_self_all)
# nrow(dur_5_15_contacts) # must be <= nrow(d_self_all)
# nrow(dur_15_60_contacts) # must be <= nrow(d_self_all)
# nrow(dur_60_240_contacts) # must be <= nrow(d_self_all)
# nrow(dur_240_contacts) # must be <= nrow(d_self_all)
# 
# # rename
# names(dur_5_contacts) <- sub("_contact_n", "_contact_n_dur_5", names(dur_5_contacts))
# names(dur_5_15_contacts) <- sub("_contact_n", "_contact_n_dur_5_15", names(dur_5_15_contacts))
# names(dur_15_60_contacts) <- sub("_contact_n", "_contact_n_dur_15_60", names(dur_15_60_contacts))
# names(dur_60_240_contacts) <- sub("_contact_n", "_contact_n_dur_60_240", names(dur_60_240_contacts))
# names(dur_240_contacts) <- sub("_contact_n", "_contact_n_dur_240", names(dur_240_contacts))
# 
# d_all_wide <- merge(d_all_wide, dur_5_contacts, by=c("new_id", "wave"), all=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dur_5_15_contacts, by=c("new_id", "wave"), all=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dur_15_60_contacts, by=c("new_id", "wave"), all=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dur_60_240_contacts, by=c("new_id", "wave"), all=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dur_240_contacts, by=c("new_id", "wave"), all=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# 
# 
# # any NA in _contact_n means zero contacts in that setting
# for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
#   d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
# }


#################################################################################################
#################################################################################################
# Contact duration in non-hh contacts for bar chart
#first categorise
dt_outside_all$contact_duration_minutes <- dt_outside_all$time_hh * 60 + dt_outside_all$time_mm
dt_outside_all$contact_duration_minutes[which(dt_outside_all$contact_duration_minutes > 24 * 60)] <- 24 * 60
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes<5]<-"<5"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>4 & dt_outside_all$contact_duration_minutes<15]<-">=5 & <15"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>14 & dt_outside_all$contact_duration_minutes<60]<-">=15 & <60"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>59 & dt_outside_all$contact_duration_minutes<240]<-">=60 & <240"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>239]<-">=240"

dt_outside_all$contact_duration_minutes_cat <- as.character(dt_outside_all$contact_duration_minutes_cat, levels = c('<5','>=5 & <15','>=15 & <60','>=60 & <240','>=240'))


# from wave 14 onwards contact duration is recorded as Less than 5 minutes, etc. Need to take the values of the variable ""
dt_outside_all$con_time[dt_outside_all$con_time=="Less than 5 minutes"] <- "<5"
dt_outside_all$con_time[dt_outside_all$con_time==" Less than 5 minutes"] <- "<5"
dt_hh_all$con_time[dt_hh_all$con_time=="Less than 5 minutes"] <- "<5"
dt_hh_all$con_time[dt_hh_all$con_time==" Less than 5 minutes"] <- "<5"
dt_outside_all$con_time[dt_outside_all$con_time=="5 minutes or more, but less than 15 minutes"] <- ">=5 & <15"
dt_hh_all$con_time[dt_hh_all$con_time=="5 minutes or more, but less than 15 minutes"] <- ">=5 & <15"
dt_outside_all$con_time[dt_outside_all$con_time=="15 minutes or more, but less than 1 hour"] <- ">=15 & <60"
dt_hh_all$con_time[dt_hh_all$con_time=="15 minutes or more, but less than 1 hour"] <- ">=15 & <60"
dt_outside_all$con_time[dt_outside_all$con_time=="1 hour or more, but less than 4 hours"] <- ">=60 & <240"
dt_hh_all$con_time[dt_hh_all$con_time=="1 hour or more, but less than 4 hours"] <- ">=60 & <240"
dt_outside_all$con_time[dt_outside_all$con_time=="4 hours or more"] <- ">=240"
dt_hh_all$con_time[dt_hh_all$con_time=="4 hours or more"] <- ">=240"
dt_outside_all$con_time[dt_outside_all$con_time=="Don’t know"] <- NA
dt_hh_all$con_time[dt_hh_all$con_time=="Don’t know"] <- NA


dt_outside_all <- dt_outside_all %>% mutate (contact_duration_minutes_cat = case_when(questionnaire=="new" ~ con_time, TRUE ~ contact_duration_minutes_cat))



dummy_0_4 <- dt_outside_all %>% 
  filter(contact_duration_minutes_cat=="<5") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_duration_0_4_contact_n=n())

dummy_5_14 <- dt_outside_all %>% 
  filter(contact_duration_minutes_cat==">=5 & <15") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_duration_5_14_contact_n=n())

dummy_15_59 <- dt_outside_all %>% 
  filter(contact_duration_minutes_cat==">=15 & <60") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_duration_15_59_contact_n=n())

dummy_60_239 <- dt_outside_all %>% 
  filter(contact_duration_minutes_cat==">=60 & <240") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_duration_60_239_contact_n=n())

dummy_240 <- dt_outside_all %>% 
  filter(contact_duration_minutes_cat==">=240") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_duration_240_contact_n=n())


# merge with d_all_wide
d_all_wide <- merge(d_all_wide, dummy_0_4, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, dummy_5_14, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, dummy_15_59, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, dummy_60_239, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, dummy_240, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }


# any NA in _contact_n means zero contacts in that setting
for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
  d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
}

rm(dummy_0_4, dummy_5_14, dummy_15_59, dummy_60_239, dummy_240)
#################################################################################################
#################################################################################################



###WORK IN PROGRESS
#################################################################################################
#relation for bar chart
# combine relation and relation_child (wave 14 onwards)
dt_outside_all$relation_2 <- dt_outside_all$relation
dt_outside_all <- dt_outside_all %>% mutate(relation_2 = case_when(is.na(relation) ~ relation_child, TRUE ~ relation))

dt_outside_all$relation_2[dt_outside_all$relation_2=="School/Uni"] <- "School"
dt_outside_all$relation_2[dt_outside_all$relation_2=="Kindergarden/School/Uni"] <- "School"
dt_outside_all$relation_2[dt_outside_all$relation_2=="Spouse/Significant other"] <- "Family (not in household)"
dt_outside_all$relation_2[dt_outside_all$relation_2=="Babysitter"] <- "Other"
dt_outside_all$relation_2[dt_outside_all$relation_2=="Client"] <- "Other"
dt_outside_all$relation_2[dt_outside_all$relation_2=="Don't want to answer" | dt_outside_all$relation_2=="Prefer not to answer" | dt_outside_all$relation_2=="Prefer not to say"] <- NA

###### CAVE Still need to adapt once we also have the relation of children, i.e. QP question
#### NEED TO UPDATE WORK IN PROGRESS


# Contact relation in non-hh contacts
relation_family <- dt_outside_all %>%
  filter(relation_2=="Family (not in household)") %>%
  group_by(new_id, wave) %>%
  summarise(non_hh_relation_family_contact_n=n())

relation_friend <- dt_outside_all %>%
  filter(relation_2=="Friend") %>%
  group_by(new_id, wave) %>%
  summarise(non_hh_relation_friend_contact_n=n())

relation_other <- dt_outside_all %>%
  filter(relation_2=="Other") %>%
  group_by(new_id, wave) %>%
  summarise(non_hh_relation_other_contact_n=n())

relation_school <- dt_outside_all %>%
  filter(relation_2=="School") %>%
  group_by(new_id, wave) %>%
  summarise(non_hh_relation_school_contact_n=n())

relation_work <- dt_outside_all %>%
  filter(relation_2=="Work") %>%
  group_by(new_id, wave) %>%
  summarise(non_hh_relation_work_contact_n=n())


# merge with d_all_wide
d_all_wide <- merge(d_all_wide, relation_family, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, relation_friend, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, relation_other, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, relation_school, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, relation_work, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }


# any NA in _contact_n means zero contacts in that setting
for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
  d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
}

rm(relation_family, relation_friend, relation_other, relation_school, relation_work)

table1::table1(~non_hh_relation_family_contact_n + non_hh_relation_friend_contact_n + non_hh_relation_other_contact_n + non_hh_relation_school_contact_n + non_hh_relation_work_contact_n | wave, data=d_all_wide)

#################################################################################################
#################################################################################################




#################################################################################################
#how often before COVID for bar chart
dt_outside_all$time_before_COV_2 <- dt_outside_all$time_before_COV
dt_outside_all$time_before_COV_2[dt_outside_all$time_before_COV=="Prefer not to answer" | dt_outside_all$time_before_COV=="Don’t know"] <- NA

# How regularly met before COVID in non-hh contacts
before_once_week <- dt_outside_all %>% 
  filter(time_before_COV_2=="About once or twice a week") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_before_onceweek_contact_n=n())

before_once_month <- dt_outside_all %>% 
  filter(time_before_COV_2=="About once per month") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_before_oncemonth_contact_n=n())

before_2_weeks <- dt_outside_all %>% 
  filter(time_before_COV_2=="Every 2-3 weeks") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_before_2weeks_contact_n=n())

before_every_day <- dt_outside_all %>% 
  filter(time_before_COV_2=="Every day or almost every day") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_before_everyday_contact_n=n())

before_less_month <- dt_outside_all %>% 
  filter(time_before_COV_2=="Less often than once per month") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_before_lessmonth_contact_n=n())

before_never <- dt_outside_all %>% 
  filter(time_before_COV_2=="Never met them before") %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(non_hh_before_never_contact_n=n())


# merge with d_all_wide
d_all_wide <- merge(d_all_wide, before_once_week, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, before_once_month, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, before_2_weeks, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, before_every_day, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, before_less_month, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, before_never, by=c("new_id", "wave"), all=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }

# any NA in _contact_n means zero contacts in that setting
for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
  d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
}

rm(before_once_week, before_once_month, before_2_weeks, before_every_day, before_less_month, before_never)

table1::table1(~non_hh_before_onceweek_contact_n + non_hh_before_oncemonth_contact_n + non_hh_before_2weeks_contact_n + non_hh_before_everyday_contact_n + non_hh_before_lessmonth_contact_n + non_hh_before_never_contact_n | wave, data=d_all_wide)

```

#create age group

```{r create age groups, weekday, etc}
d_all_wide$date <- ymd(paste0(d_all_wide$date_YYYY_0, "/", d_all_wide$date_MM_0, "/", d_all_wide$date_DD_0))
d_all_wide$weekday <- lubridate::wday(d_all_wide$date, week_start = 7) # week starts on Sunday
d_all_wide$weekday <- factor(d_all_wide$weekday, labels = c("Sun", "Mon", "Tue", "Wed","Thu", "Fri", "Sat"))
d_all_wide$weekday <- factor(d_all_wide$weekday, levels = c("Mon", "Tue", "Wed","Thu", "Fri", "Sat", "Sun"))
table(d_all_wide$date, d_all_wide$weekday)

#weekday for which contacts recorded, i.e. weekday - 1
 d_all_wide$weekday_2[d_all_wide$weekday=="Mon"] <- "Sun"
 d_all_wide$weekday_2[d_all_wide$weekday=="Tue"] <- "Mon"
 d_all_wide$weekday_2[d_all_wide$weekday=="Wed"] <- "Tue"
 d_all_wide$weekday_2[d_all_wide$weekday=="Thu"] <- "Wed"
 d_all_wide$weekday_2[d_all_wide$weekday=="Fri"] <- "Thu"
 d_all_wide$weekday_2[d_all_wide$weekday=="Sat"] <- "Fri"
 d_all_wide$weekday_2[d_all_wide$weekday=="Sun"] <- "Sat"
 d_all_wide$weekday_2 <- factor(d_all_wide$weekday_2, levels=c("Mon","Tue","Wed","Thu", "Fri", "Sat", "Sun"))
 d_all_wide$weekend_weekday[d_all_wide$weekday_2=="Mon" | d_all_wide$weekday_2=="Tue" |  d_all_wide$weekday_2=="Wed" |  d_all_wide$weekday_2=="Thu" | d_all_wide$weekday_2=="Fri"] <- "weekday"
 d_all_wide$weekend_weekday[d_all_wide$weekday_2=="Sat" | d_all_wide$weekday_2=="Sun"] <- "weekend"


#####CAVE, CAVE, CAVE - there is still an issue with wave 14. hh_p_incl_0 ranges from 0 to 11 instead of 1 to 12. Email to Sara send.
# household size
#wave 14 onwards already has variable hh_p_incl_0 => must add 1 to hh_p_excl_0 from waves 1 to 13
d_all_wide <- d_all_wide %>% mutate(hh_p_incl_0 = ifelse(questionnaire=="old", (hh_p_excl_0+1), hh_p_incl_0))
d_all_wide <- d_all_wide %>% mutate(hh_p_incl_0 = ifelse(wave==14, (hh_p_incl_0+1), hh_p_incl_0))
table1::table1(~hh_p_incl_0 + as.factor(hh_p_incl_0) | as.factor(wave), data=d_all_wide)

d_all_wide$hh_p_incl_0_2[d_all_wide$hh_p_incl_0=="1"] <- "1"
d_all_wide$hh_p_incl_0_2[d_all_wide$hh_p_incl_0>1 & d_all_wide$hh_p_incl_0<5] <- "2-4"
d_all_wide$hh_p_incl_0_2[d_all_wide$hh_p_incl_0>4 & d_all_wide$hh_p_incl_0<10] <- "5-9"
d_all_wide$hh_p_incl_0_2[d_all_wide$hh_p_incl_0>9] <- "10+"
d_all_wide$hh_p_incl_0_2 <- factor(d_all_wide$hh_p_incl_0_2, levels=c("1","2-4","5-9","10+"))

d_all_wide$hh_p_incl_0_3[d_all_wide$hh_p_incl_0=="1"] <- "1"
d_all_wide$hh_p_incl_0_3[d_all_wide$hh_p_incl_0==2] <- "2"
d_all_wide$hh_p_incl_0_3[d_all_wide$hh_p_incl_0>2 & d_all_wide$hh_p_incl_0<6] <- "3-5"
d_all_wide$hh_p_incl_0_3[d_all_wide$hh_p_incl_0>5] <- "6+"
d_all_wide$hh_p_incl_0_3 <- factor(d_all_wide$hh_p_incl_0_3, levels=c("6+","3-5","2","1"))


# age groups
# from wave 14 onwards a category exists 85 years or older => put into 85+
d_all_wide$age_group[d_all_wide$age_group=="85 years or older"] <- "85+"

#groups <- sort(unique(d_all_wide$age_group))
#groups <- setdiff(groups,c("Don’t know","Prefer not to answer","<1"))
d_all_wide$age_group_2[d_all_wide$age_group=="Under 1" | d_all_wide$age_group=="1-4" | d_all_wide$age_group=="5-9"| d_all_wide$age_group=="10-14" | d_all_wide$age_group=="15-19"] <- "0-19"
d_all_wide$age_group_2[d_all_wide$age_group=="20-24" | d_all_wide$age_group=="25-34" ] <- "20-34"
d_all_wide$age_group_2[d_all_wide$age_group=="35-44" | d_all_wide$age_group=="45-54"] <- "35-54"
d_all_wide$age_group_2[ d_all_wide$age_group=="55-64" ] <- "55-64"
d_all_wide$age_group_2[ d_all_wide$age_group=="65-69"] <- "65-69"
d_all_wide$age_group_2[ d_all_wide$age_group=="70-74" | d_all_wide$age_group=="75-79" | d_all_wide$age_group=="80-84" | d_all_wide$age_group=="85+"] <- "70+"

#sex2
d_all_wide$sex2 [d_all_wide$sex=="Female"] <- "Female"
d_all_wide$sex2[d_all_wide$sex=="Male"] <- "Male"

```

# add Q75/76

```{r Add Q75 / Q76 contacts AND truncate Q contacts at 50}
# Bitte jede Kategorie einzeln checken. I.e. Q75_u18_work mit Q76_u18_work abgleichen und falls nötig ersetzten und das halt für jede Kategorie. So habe ichs bisher gemacht und Victoria hat das dann von mir übernommen.




# Bitte geben Sie die Anzahl an Kontakten für jede Altersgruppe und jedes Umfeld an.
# ROWS
# Unter 18 Jahre 
# 18 bis 64 Jahre
# 65 Jahre und älter
# COLUMNS
# Am Arbeitsplatz -> add to work_contact_n (no info about inside/outside!)
v <- which(d_all_wide$Q76_u18_work > d_all_wide$Q75_u18_work)
d_all_wide$Q75_u18_work[v] <- d_all_wide$Q76_u18_work[v]

v <- which(d_all_wide$Q76_1864_work > d_all_wide$Q75_1864_work)
d_all_wide$Q75_1864_work[v] <- d_all_wide$Q76_1864_work[v]

v <- which(d_all_wide$Q76_o64_work > d_all_wide$Q75_o64_work)
d_all_wide$Q75_o64_work[v] <- d_all_wide$Q76_o64_work[v]

d_all_wide$Q75_work_sum <- rowSums(d_all_wide[, c("Q75_u18_work",
                                                  "Q75_1864_work",
                                                  "Q75_o64_work")],
                                   na.rm = TRUE)
d_all_wide$dummy_Q75_work_youngage<-0
d_all_wide$dummy_Q75_work_youngage[d_all_wide$age_group=="Under 1" | 
                                     d_all_wide$age_group=="1-4" |
                                     d_all_wide$age_group=="5-9" |
                                     d_all_wide$age_group=="10-14"] <- 
  d_all_wide$Q75_work_sum[d_all_wide$age_group=="Under 1" | 
                                     d_all_wide$age_group=="1-4" |
                                     d_all_wide$age_group=="5-9" |
                                     d_all_wide$age_group=="10-14"]

d_all_wide$Q75_work_sum[d_all_wide$age_group=="Under 1" | 
                                     d_all_wide$age_group=="1-4" |
                                     d_all_wide$age_group=="5-9" |
                                     d_all_wide$age_group=="10-14"] <- 0


##### truncate at "truncate" before adding to work contacts
d_all_wide$Q75_work_sum[d_all_wide$Q75_work_sum>truncate] <- truncate

## add the work Q contacts to the overall work contacts
d_all_wide$work_contact_n_Q75 <- d_all_wide$work_contact_n + d_all_wide$Q75_work_sum



# In der Schule oder einer anderen Lehranstalt -> add to school_contact_n
v <- which(d_all_wide$Q76_u18_school > d_all_wide$Q75_u18_school)
d_all_wide$Q75_u18_school[v] <- d_all_wide$Q76_u18_school[v]

v <- which(d_all_wide$Q76_1864_school > d_all_wide$Q75_1864_school)
d_all_wide$Q75_1864_school[v] <- d_all_wide$Q76_1864_school[v]

v <- which(d_all_wide$Q76_o64_school > d_all_wide$Q75_o64_school)
d_all_wide$Q75_o64_school[v] <- d_all_wide$Q76_o64_school[v]

d_all_wide$Q75_school_sum <- rowSums(d_all_wide[, c("Q75_u18_school",
                                                    "Q75_1864_school",
                                                    "Q75_o64_school")],
                                     na.rm = TRUE)

##### truncate at "truncate" before adding to school contacts
d_all_wide$Q75_school_sum[d_all_wide$Q75_school_sum>truncate] <- truncate

# add the Q school contacts to the other school contacts
d_all_wide$school_contact_n_Q75 <- d_all_wide$school_contact_n + d_all_wide$Q75_school_sum





# Anderswo -> add to not_specified_contact_n
v <- which(d_all_wide$Q76_u18_else > d_all_wide$Q75_u18_else)
d_all_wide$Q75_u18_else[v] <- d_all_wide$Q76_u18_else[v]

v <- which(d_all_wide$Q76_1864_else > d_all_wide$Q75_1864_else)
d_all_wide$Q75_1864_else[v] <- d_all_wide$Q76_1864_else[v]

v <- which(d_all_wide$Q76_o64_else > d_all_wide$Q75_o64_else)
d_all_wide$Q75_o64_else[v] <- d_all_wide$Q76_o64_else[v]

d_all_wide$Q75_else_sum <- rowSums(d_all_wide[, c("Q75_u18_else",
                                                  "Q75_1864_else",
                                                  "Q75_o64_else")],
                                   na.rm = TRUE)

#add the Q75 work contacts from the below 15 year olds
d_all_wide$Q75_else_sum <-d_all_wide$Q75_else_sum + d_all_wide$dummy_Q75_work_youngage


##### truncate at "truncate" before adding to not specified contacts
d_all_wide$Q75_else_sum[d_all_wide$Q75_else_sum>truncate] <- truncate

#add the Q "else" contacts to the not specified contacts
d_all_wide$not_specified_contact_n_Q75 <- d_all_wide$not_specified_contact_n + d_all_wide$Q75_else_sum


```

# add Q75/76 to non-hh

```{r Add Q75 / Q76 contacts to non-hh contacts}


# also add to all non_hh_
d_all_wide$non_hh_contact_n_Q75 <- d_all_wide$non_hh_contact_n + 
  d_all_wide$Q75_work_sum + 
  d_all_wide$Q75_school_sum + 
  d_all_wide$Q75_else_sum


# also add to all_
d_all_wide$all_contact_n_Q75 <- d_all_wide$all_contact_n + 
  d_all_wide$Q75_work_sum + 
  d_all_wide$Q75_school_sum + 
  d_all_wide$Q75_else_sum

```

# add Q75/76 to non-hh truncated overall at 50

```{r Add Q75 / Q76 contacts to non-hh contacts truncated overall at 50, i.e. like lshtm does it not based on categories}

d_all_wide$Q75_combined <- d_all_wide$Q75_work_sum + d_all_wide$Q75_school_sum + d_all_wide$Q75_else_sum
d_all_wide$Q75_combined[d_all_wide$Q75_combined>truncate_lshtm] <- truncate_lshtm



# also add to all non_hh_
d_all_wide$lshtm_non_hh_contact_n_Q75 <- d_all_wide$non_hh_contact_n + 
  d_all_wide$Q75_combined

# also add to all_
d_all_wide$lshtm_all_contact_n_Q75 <- d_all_wide$all_contact_n + 
  d_all_wide$Q75_combined

```

#data checks and labelling

```{r Some data checks and labelling}
d_all_wide$wave <- as.factor(d_all_wide$wave)
levels(d_all_wide$wave) <- WAVES[as.integer(levels(d_all_wide$wave))]

summary(d_all_wide$age_0)
# age_0 is never below 18 because it is only known for the respondent
# if age is needed, then use age_group!

# d_all_wide$age_group <- droplevels(d_all_wide$age_group)
table(d_all_wide$age_group, d_all_wide$wave)
d_all_wide$age_group[which(d_all_wide$age_group == "Under 1")] <- "<1"
# levels(d_all_wide$age_group)[1] <- "<1"

d_all_wide <- subset(d_all_wide, !is.na(new_id))

# sum of place_ contacts (incl. oth_contact_n) must not be greater than non_hh_contact_n
# CAVE: multiple sites
d_all_wide$sum_place_contact_n <- rowSums(d_all_wide[, 
                                                     c(CONTACT_N,
                                                       "not_specified_contact_n")])
table(d_all_wide$non_hh_contact_n - d_all_wide$sum_place_contact_n,
      d_all_wide$multiple_contact_n,
      useNA = "ifany")
```

# barchart
```{r Long format for bar chart of settings}
# All
keycol <- "contact_type"
valuecol <- "contact_n"
gathercols <- c(CONTACT_N, "not_specified_contact_n", "hh_contact_n",
                sub("_contact_n", 
                    "_contact_n_inside", 
                    c(CONTACT_N, "not_specified_contact_n", "hh_contact_n")),
                sub("_contact_n", 
                    "_contact_n_outside", 
                    c(CONTACT_N, "not_specified_contact_n", "hh_contact_n")))



d_all_long <- gather_(d_all_wide, keycol, valuecol, gathercols, factor_key=TRUE)
levels(d_all_long$contact_type) <- c(setdiff(LABEL_PLACES, "Multiple locations"), "Household",
                                     paste0(c(setdiff(LABEL_PLACES, "Multiple locations"),
                                              "Household"),
                                            " (inside)"),
                                     paste0(c(setdiff(LABEL_PLACES, "Multiple locations"),
                                              "Household"),
                                            " (outside)"))
table(d_all_long$contact_type)

```


```{r, results='asis'}
#library(ComplexHeatmap)

## Define ggtheme
ggthemr('grape')


######DONT FORGET TO CHANGE IF MORE WAVES ARE ADDED!!!!

## Prepare function to get all contacts
get_contacts <- function(data,waves=c(1:current_wave),min.waves=length(waves),include.group = F) {
  
  x <- data
  waves <- levels(x$wave)[waves]
  IDS <- x %>%
    filter(wave %in% waves) %>%
    mutate(wave = droplevels(wave))%>%
    group_by(new_id) %>%
    dplyr::summarise(n_waves = n()) %>%
    filter(n_waves >= min.waves) %>% dplyr::select(new_id) %>% pull
  
  dat <- x %>%
    filter(wave %in% waves) %>%
    mutate(wave = droplevels(wave)) %>%
    filter(new_id %in% IDS)
  
  return(dat)
}



# Prepare function to get random rows. Used to highlight random slopes in spaghetti plot
random_subset <- function(x) {
  id <- sample(1:length(x), length(x)/10, replace=T)
  x[id] <- 1
  x[-id] <- 0
  x <- as.numeric(x)
  return(x)
}

# Function to compute change relative to previous wave
relative.change <- function(x) { c(0,diff(x[1:length(x)],differences=1))}


# Function to prepare spaghetti plots
spaghetti.plot <- function(data,waves=levels(data$wave),relative=F,log=F,alpha=.1,title="only participants with observations in at least two time-points") {

  if(relative == T) {data <- data %>% group_by(new_id) %>% mutate(contacts = relative.change(contacts))}
  
  p <- data %>%
        filter(wave %in% waves) %>%
        mutate(random = as.factor(random_subset(contacts))) %>%
        ggplot(aes(x=wave,y=contacts)) +
        geom_line(aes(group=new_id),alpha=alpha) + 
        geom_point(alpha=alpha) +
        theme(legend.position = "none",
              axis.text.x = element_text(angle = 90)) +
        ggtitle(paste0(title))
  
  if(log==T) {p <- p +   scale_y_log10() + ylab("contacts[logscale]") }
  
  print(p)

}

# Function to prepare boxplots
my.boxplot <- function(x,waves=levels(x$wave),relative=F,log=F,title="only participants with observations in at least two time-points") {

  if(relative == T) {x <- x %>% group_by(new_id) %>% mutate(contacts = relative.change(contacts))}
  
  p <- x %>%
        filter(wave %in% waves) %>%
        ggplot(aes(x=wave,y=contacts)) +
        geom_boxplot() + 
        stat_summary(fun=mean, geom="point", shape=20,col="black",size=1, fill="red",aes(shape="mean")) +
        stat_summary(fun=mean,group=1, geom="line",col="black",size=1,linetype="dashed") +
        theme(legend.position = "none",
              axis.text.x = element_text(angle = 90)) +
        ggtitle(paste0(title))
  
  if(log==T) {p <- p +   scale_y_log10() + ylab("contacts[logscale]") }
  
  print(p)

}

##########################
#### Make UpSet plots ####
##########################


plot.upset <- function(x) {
  
#x <- x %>% filter(contacts>0)

m <- table(x$new_id,x$wave) %>%
  make_comb_mat()

ht <- UpSet(m,
      comb_order = order(comb_size(m),decreasing = T),
      set_order = order(set_size(m)),
      row_names_side = "right",
      right_annotation = NULL,
      comb_col = "#3B3B3B",
      left_annotation = rowAnnotation(
        "Set size" = anno_barplot(set_size(m), 
                                  axis_param = list(direction = "reverse"),
                                  border = FALSE, 
                                  #gp = gpar(fill = mypal,col="white"), 
                                  width = unit(2, "cm")
        )))

print(ht)

}


###############################
#### Mean change over time ####
###############################
library(boot)

#sample_mean <- function(x,i) {
#  return(mean(x[i]))
#}

sample_mean <- function(x,i,j) {
  d <- x[i]
  w <- j[i]
  return(weighted.mean(d,w))
}

boot_mean <- function(x,w) {
  set.seed(1234567)
  bo <- boot(x,sample_mean,R=1000,j=w)
  ci <- boot.ci(bo, conf=0.95,type="perc")
  out <- data.frame("mean" = bo$t0,
              "lower" = ci$perc[4],
              "upper" = ci$perc[5])
  return(out)
}

plot.mean <- function(x,waves=levels(x$wave),weighted=F,R=1000,title="Bootstraped mean value with 95% percentile CI - R = 1000 ") {

if(weighted==T) {
plot_df <- x %>%
  filter(wave %in% waves) %>%
  dplyr::group_by(wave) %>%
  do(boot_mean(.$contacts,w=.$weight)) %>%
  ungroup 
} else {
plot_df <- x %>%
  filter(wave %in% waves) %>%
  dplyr::group_by(wave) %>%
  do(boot_mean(.$contacts,w=rep(1,nrow(x)))) %>%
  ungroup  
  
}
}

n_overall.table <- function(x) {
  table(x) %>% as_tibble() %>% rename("Number of waves" = x, "Number of participants" = n) %>% t() %>% kable %>% kable_styling()
}

n.table <- function(x) {
  table(x) %>% as_tibble() %>% rename(Wave = x, Observations = n) %>% t() %>% kable %>% kable_styling()
}

```

# Number of participants per wave

## all participants  included regardless of number of waves contributed
```{r,results="asis"}
min_number_waves=1
df <- get_contacts(d_all_wide,min.waves=min_number_waves)

df_dummy <- df %>% group_by(new_id) %>% dplyr::summarise(wave_n=n()) ## add dplyr::, no longer error
df_dummy$num_wave_included<-min_number_waves
df_dummy$wave_n_factor <- as.factor(df_dummy$wave_n)
df_dummy$wave_n_cat <- as.factor(ifelse(df_dummy$wave_n < 2, '1',
                     ifelse(df_dummy$wave_n < 5, '2-4', 
                     ifelse(df_dummy$wave_n < 10, '5-9', 
                     ifelse(df_dummy$wave_n < 15, '10-14', 
                     ifelse(df_dummy$wave_n < 20, '15-19', 
                     ifelse(df_dummy$wave_n < 25, '20-24', 
                            '>=25')))))))
df_dummy$wave_n_cat <- factor(df_dummy$wave_n_cat, levels=c("1", "2-4", "5-9", "10-14", "15-19", "20-24",">=25"))

table1::table1(~num_wave_included + wave_n + wave_n_factor + wave_n_cat, data=df_dummy)
#n_overall.table(df_dummy$wave_n)
table1::table1(~all_contact_n_Q75 + all_contact_n | wave, data=df)

```


## participants with 2 or more waves included
```{r,results="asis"}
min_number_waves=2
df <- get_contacts(d_all_wide,min.waves=min_number_waves)

df_dummy <- df %>% group_by(new_id) %>% dplyr::summarise(wave_n=n()) 
df_dummy$num_wave_included<-min_number_waves
df_dummy$wave_n_factor <- as.factor(df_dummy$wave_n)
table1::table1(~num_wave_included + wave_n + wave_n_factor , data=df_dummy)
#n_overall.table(df_dummy$wave_n)
table1::table1(~all_contact_n_Q75 + all_contact_n | wave, data=df)
```


## participants with 3 or more waves included
```{r,results="asis"}
min_number_waves=3
df <- get_contacts(d_all_wide,min.waves=min_number_waves)

df_dummy <- df %>% group_by(new_id) %>% dplyr::summarise(wave_n=n()) 
df_dummy$num_wave_included<-min_number_waves
df_dummy$wave_n_factor <- as.factor(df_dummy$wave_n)
table1::table1(~num_wave_included + wave_n + wave_n_factor , data=df_dummy)
#n_overall.table(df_dummy$wave_n)
table1::table1(~all_contact_n_Q75 + all_contact_n | wave, data=df)
```


```{r}
min_number_waves=1
df <- get_contacts(d_all_wide,min.waves=min_number_waves)

```

From now on all participants who participated in at least `r min_number_waves` wave(s) are included.

# UNWEIGHTED

```{r descriptive_table}

#label for table ## add package table1, no longer error
 table1::label(df$sex2)<-"Sex"
#label(df$weekend_weekday)<-"Weekday/Weekend"
 table1::label(df$age_group_2)<-"Age in years"
 table1::label(df$hh_p_incl_0_2)<-"Household size"


my.render.cat <- function(x) {
  c("", sapply(stats.default(x), function(y) with(y,
                                                  sprintf("%d (%0.0f%%)", FREQ, PCTnoNA))))
}

#table1::table1(~ weekend_weekday + sex2 + age_group_2 + hh_p_incl_0_2| wave, data=df,  render.categorical=my.render.cat,overall=F)

df_unweighted <- df
```

```{r}
number_part <- df_unweighted %>% group_by(wave) %>% dplyr::summarise(wave_n=n())
df_unweighted$wave_num <- as.numeric(df_unweighted$wave)

number_of_participants <- ggplot(df_unweighted, aes(x=wave_num))+
      geom_histogram(binwidth=1, fill="grey", colour="black")+
theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) + 
  scale_x_continuous(breaks = seq(1, current_wave, 1))
number_of_participants

#Warning: Removed 535 rows containing non-finite values (stat_bin)

#auto save
participants <- paste0(path_figures, "/number_of_participants", ".png")
ggsave(participants, width=10, height=7)

```

#Age and sex distribution

```{r}
table1(~age_group_2 + sex2 + hh_p_incl_0|wave, data=df_unweighted)

#Age Group
df_unweighted_histo <- df_unweighted %>% select(new_id, wave, age_group_2, wave_num)
df_unweighted_histo <- df_unweighted_histo %>% group_by(wave_num, age_group_2) %>% dplyr::summarise(age_group_2_n=n())

age_per_wave <- ggplot(df_unweighted_histo, 
               aes_string(x = "wave_num", y = "age_group_2_n", fill = "age_group_2")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
age_per_wave
age_groups_part <- paste0(path_figures, "/age_groups_part", ".png")
ggsave(age_groups_part, width=10, height=7)


#Sex
df_unweighted_histo <- df_unweighted %>% select(new_id, wave, sex2, wave_num)
df_unweighted_histo <- df_unweighted_histo %>% group_by(wave_num, sex2) %>% dplyr::summarise(sex2_n=n())

sex_per_wave <- ggplot(df_unweighted_histo, 
               aes_string(x = "wave_num", y = "sex2_n", fill = "sex2")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
sex_per_wave
sex_part <- paste0(path_figures, "/sex_part", ".png")
ggsave(sex_part, width=10, height=7)


#HH Size
df_unweighted_histo <- df_unweighted %>% select(new_id, wave, hh_p_incl_0_3, wave_num)
df_unweighted_histo <- df_unweighted_histo %>% group_by(wave_num, hh_p_incl_0_3) %>% dplyr::summarise(hh_p_incl_0_3_n=n())

hh_per_wave <- ggplot(df_unweighted_histo, 
               aes_string(x = "wave_num", y = "hh_p_incl_0_3_n", fill = "hh_p_incl_0_3")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
hh_per_wave
hh_part <- paste0(path_figures, "/hh_part", ".png")
ggsave(hh_part, width=10, height=7)

```

## Bundesland
```{r}
table1(~bundesland_0|wave, data=df_unweighted)
table1(~bundesland_0, data=df_unweighted)

```


## Distribution of contacts

```{r distribution all contacts with Q}
ggplot(d_all_wide, aes(x=all_contact_n_Q75))+
geom_histogram( binwidth=1)+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) +
  scale_x_continuous(limits=c(NA,50)) +
  scale_y_continuous(expand=c(0,0), limits=c(0, NA)) +
  facet_wrap(~wave, ncol=4) + 
  theme(strip.text = element_text(face="bold", size=16,lineheight=5.0, colour="black"))

Distribution_panel_FILENAME <- paste0(path_figures, "/distribution_all_contact_n_Q75_",truncate, ".png")
ggsave(Distribution_panel_FILENAME, width=10, height=10)

```


```{r distribution all contacts WITHOUT Q}
ggplot(d_all_wide, aes(x=all_contact_n))+
geom_histogram( binwidth=1)+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) +
  scale_x_continuous(limits=c(NA,50)) +
  scale_y_continuous(expand=c(0,0), limits=c(0, NA)) +
  facet_wrap(~wave, ncol=4) + 
  theme(strip.text = element_text(face="bold", size=16,lineheight=5.0, colour="black"))

Distribution_panel_FILENAME <- paste0(path_figures, "/distribution_all_contact_n_",truncate, ".png")
ggsave(Distribution_panel_FILENAME, width=10, height=10)

```


```{r distribution hh contacts WITHOUT Q}
ggplot(d_all_wide, aes(x=hh_contact_n))+
geom_histogram(binwidth=1)+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) +
  scale_x_continuous(limits=c(NA,NA)) +
  scale_y_continuous(expand=c(0,0), limits=c(0, NA)) +
  facet_wrap(~wave, ncol=4) + 
  theme(strip.text = element_text(face="bold", size=16,lineheight=5.0, colour="black"))

Distribution_panel_FILENAME <- paste0(path_figures, "/distribution_hh_contact_n_",truncate, ".png")
ggsave(Distribution_panel_FILENAME, width=10, height=10)

```



```{r distribution non_hh contacts WITHOUT Q}
ggplot(d_all_wide, aes(x=non_hh_contact_n))+
geom_histogram(binwidth=1)+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) +
  scale_x_continuous(limits=c(NA,50)) +
  scale_y_continuous(expand=c(0,0), limits=c(0, NA)) +
  facet_wrap(~wave, ncol=4) + 
  theme(strip.text = element_text(face="bold", size=16,lineheight=5.0, colour="black"))

Distribution_panel_FILENAME <- paste0(path_figures, "/distribution_non_hh_contact_n_WITHOUT_Q_",truncate, ".png")
ggsave(Distribution_panel_FILENAME, width=10, height=10)

```


```{r distribution non_hh contacts WIT Q}
ggplot(d_all_wide, aes(x=non_hh_contact_n_Q75))+
geom_histogram(binwidth=1)+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) +
  scale_x_continuous(limits=c(NA,50)) +
  scale_y_continuous(expand=c(0,0), limits=c(0, NA)) +
  facet_wrap(~wave, ncol=4) + 
  theme(strip.text = element_text(face="bold", size=16,lineheight=5.0, colour="black"))

Distribution_panel_FILENAME <- paste0(path_figures, "/distribution_non_hh_contact_n_WITH_Q_",truncate, ".png")
ggsave(Distribution_panel_FILENAME, width=10, height=10)

```


## All contacts without group contacts

```{r,results="asis"}
# #All contacts WItHOUT Q contacts!
# df$contacts<-df$all_contact_n
# 
# n.table(df$wave)
# 
# plot_df<-plot.mean(df)
```

### All contacts without group contacts per age group

```{r, cache=F,results="asis"}
df$contacts<-df$all_contact_n

# for(i in seq_along(groups)) {
#   cat(paste0("#### Age group: ",groups[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group %in% groups[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
# 
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```


### All inside contacts without group contacts

```{r cache=TRUE, results='asis'}
# #All contacts WItHOUT Q contacts!
# df$contacts<- df$all_contact_n_inside
# 
# n.table(df$wave)
# plot.mean(df)

```

### All inside contacts without group contacts per age group
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```


### All outside contacts without group contacts
```{r, results='asis',cache=T}
# #All contacts WItHOUT Q contacts!
# df$contacts<- df$all_contact_n_outside
# 
# n.table(df$wave)
# plot.mean(df)

```

### All outside contacts without group contacts per age group

```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```

## All non-household contacts without group contacts

```{r, results='asis',cache=T}
# #All contacts WItHOUT Q contacts!
# df$contacts<- df$non_hh_contact_n
# 
# n.table(df$wave)
# plot.mean(df)

```

### All non-household contacts without group contacts per age group 

```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```


### All non-household inside contacts without group contacts

```{r, results='asis',cache=T}
#All contacts WItHOUT Q contacts!
# df$contacts<- df$non_hh_contact_n_inside
# 
# n.table(df$wave)
# plot.mean(df)

```

### All non-household inside contacts without group contacts per age group

```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```


### All non-household outside contacts without group contacts
```{r, results='asis',cache=T}
# #All contacts WItHOUT Q contacts!
# df$contacts<- df$non_hh_contact_n_outside
# 
# n.table(df$wave)
# plot.mean(df)
```

### All non-household outside contacts without group contacts per age group

```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```

## All household contacts 

```{r, cache=TRUE, results='asis'}
# df$contacts<- df$hh_contact_n
# 
# n.table(df$wave)
# plot.upset(df)
# plot.mean(df)
```

### All household contacts per age group
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```


### Only inside household contacts
```{r, cache=TRUE, results='asis'}
# df$contacts<- df$hh_contact_n_inside
# 
# n.table(df$wave)
# plot.mean(df)
```

### Only inside household contacts per age group
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```

### Only outside household contacts 
```{r}
# df$contacts<- df$hh_contact_n_outside
# 
# n.table(df$wave)
# plot.upset(df)
# plot.mean(df)
```


### Only outside household contacts per age group
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```

## All contacts incl. group contacts

```{r}
# df$contacts<- df$all_contact_n_Q75
# 
# n.table(df$wave)
# plot_df<-plot.mean(df)
```

### All contacts incl. group contacts per age group
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```
### All contacts incl. group contacts per age group - cut at 50 contacts
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```


### All contacts incl. group contacts 
```{r}
# df$contacts<- ifelse(df$all_contact_n_Q75 > 100,100,df$all_contact_n_Q75)
# 
# n.table(df$wave)
# plot.upset(df)
# plot.mean(df)
```

### All contacts incl. group contacts per age group 
```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```

### All contacts incl. group contacts - cut at 200 contacts
```{r, cache=TRUE, results='asis'}
# df$contacts<-  ifelse(df$all_contact_n_Q75 > 200,200,df$all_contact_n_Q75)
# 
# n.table(df$wave)
# plot.upset(df)
# plot.mean(df)
```


### All contacts incl. group contacts per age group - cut at 200 contacts

```{r, cache=TRUE, results='asis'}
# # for(i in seq_along(groups)) {
# #   cat(paste0("#### Age group: ",groups[i],"\n\n"))
# #   
# #   current_df <- df %>% filter(age_group %in% groups[i])
# #   print(n.table(current_df$wave))
# # 
# #   tryCatch({plot.mean(current_df)},
# #            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",groups[i],".","\n\n")))
# #  
# #   cat("\n\n")
# # 
# # }
# 
# for(i in seq_along(group2_2)) {
#   cat(paste0("#### Age group: ",group2_2[i],"\n\n"))
#   
#   current_df <- df %>% filter(age_group_2 %in% group2_2[i])
#   print(n.table(current_df$wave))
#   tryCatch({plot.mean(current_df)},
#            error = function(e) cat(paste0(" \n\n ### Wave without enough observation in age group ",group2_2[i],".","\n\n")))
#  
#   cat("\n\n")
# 
# }
```

## Other settings

- work settings are based on contacts that reported employment (full-time,part-time,self employment)
- school settings are based on contacts that reported to be pupils (nursery or pre-school,school,higher education/university) and job = "pupil"

```{r,cache=F,results='asis'}
# names <- df %>% dplyr::select(contains("contact_n")) %>% colnames()
# names <- setdiff(names,c("all_contact_n","all_contact_n_Q75","hh_contact_n_outside",
#                         "hh_contact_n_inside","hh_contact_n","non_hh_contact_n_outside",
#                         "non_hh_contact_n_inside","non_hh_contact_n","all_contact_n_inside","all_contact_n_outside"))
# 
# work_setting <- df %>% dplyr::select(contains("contact_n")) %>% dplyr::select(contains("work")) %>% colnames()
# school_setting <- df %>% dplyr::select(contains("contact_n")) %>% dplyr::select(contains("school")) %>% colnames()
# 
# working <- c("Employed full-time (34 hours or more)",
#                        "Employed part-time (less than 34 hours)",
#                        "Self employed")
# pupil <- c("Nursery or pre-school", "School", "Higher education, e.g. university")
# 
# FILE <- paste0("C:/Users/", USER, "/sciebo/Contact-a-thon/COVIMOD/",
#                "annotation_Nicole.csv")
# ann <- read_csv((FILE)) %>% dplyr::select(name,label_variable)
# 
# 
# current_df <- df
# 
# for(i in seq_along(names)) {
#   
#   if(names[i] %in% ann$name) {
#     cat(paste0("### ", ann[ann$name==names[i],2],"\n\n"))
#   } else {
#     cat(paste0("### ",names[i],"\n\n"))
#   }
#   current_df <- df
#   current_df$contacts <- current_df[,names[[i]]]
#   
#   if(names[[i]] %in% work_setting) {current_df <- current_df %>% filter(job %in% working)}
#   if(names[[i]] %in% school_setting) {current_df <- current_df %>% filter(school %in% pupil & job == "Student/Pupil")}
#   
#   print(n.table(current_df$wave))
#   plot.mean(current_df)
#   
#   cat("\n\n")
# 
# }
```


# WEIGHTED

```{r weighting_1}

# Load Zensus data
Zensus <- read_csv("C:/Users/jaeger/Desktop/vom server/COVID_Polymod/Data/Zensus pro Bundesland by age_cat_10 sex hh_size.csv")

# Discard aggregated information
Zensus <- subset(Zensus,
                       age_cat_10 != "Insgesamt" & hh_p != "Insgesamt" & sex != "Insgesamt")

# Discard NA information
Zensus <- subset(Zensus, !is.na(group_size_population))

# Adjust age categories
Zensus$age_cat_10[which(Zensus$age_cat_10 == "Unter 10")] <- "00-09"
Zensus$age_cat_10[which(Zensus$age_cat_10 == "80 and older")] <- "80+"
Zensus$age_cat_10 <- gsub(" ", "", Zensus$age_cat_10)
Zensus$age_cat_10 <- as.factor(Zensus$age_cat_10)
levels(Zensus$age_cat_10)

# Create the same age groups as given in Zensus data
d_all_wide$age_group_zensus <- cut(d_all_wide$age_0,
                                   breaks = c(-Inf, seq(10, 80, 10), Inf),
                                   right = FALSE)

# Rename the levels as in census data
levels(d_all_wide$age_group_zensus) <- levels(Zensus$age_cat_10)

# Convert factor to character string
d_all_wide$age_group_zensus <- as.character(d_all_wide$age_group_zensus)

# Create categories for people without exact age information (people < 18)
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "<1")] <- "00-09"
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "01-04")] <- "00-09"
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "1-4")] <- "00-09"  # Bei mir ist die Kategorie so benannt?
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "05-09")] <- "00-09"
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "5-9")] <- "00-09"  # Bei mir ist die Kategorie so benannt?
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "10-14")] <- "10-19"
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "15-19")] <- "10-19"
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "20-24")] <- "20-29" #??
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "65-69")] <- "60-69" #??
d_all_wide$age_group_zensus[which(d_all_wide$age_group == "85 years or older")] <- "80+" #??

table(d_all_wide$age_group_zensus, d_all_wide$age_group, useNA = "ifany")

# Use only observations with valid age group and gender information
d_all_wide <- subset(d_all_wide, !is.na(age_group_zensus))
d_all_wide <- subset(d_all_wide, sex %in% c("Female", "Male"))

```


```{r Zensus data - household size}
#table(Zensus$hh_p)
Zensus$hh_p <- as.factor(Zensus$hh_p)

#table(d_all_wide$hh_p)
d_all_wide$hh_p_zensus <- cut(d_all_wide$hh_p_incl_0,
                              breaks = c(-Inf, seq(2, 6, 1), Inf),
                              right = FALSE)
table(d_all_wide$hh_p_zensus, useNA = "ifany")
levels(d_all_wide$hh_p_zensus) <- levels(Zensus$hh_p)
```


```{r weighting_2}
d_all_wide$strata_cat <- paste0(d_all_wide$bundesland_0, " / ",
                                d_all_wide$age_group_zensus, " / ",
                                d_all_wide$sex, " / ",
                                d_all_wide$hh_p_zensus)
Zensus$strata_cat <- paste0(Zensus$Bundesland, " / ",
                            Zensus$age_cat_10, " / ",
                            Zensus$sex, " / ",
                            Zensus$hh_p)
#table(d_all_wide$strata_cat)
#table(Zensus$strata_cat)



# some strata are not in d_all_wide -> will be ignored during weighting
X <- d_all_wide$strata_cat[which(d_all_wide$strata_cat %notin% unique(Zensus$strata_cat))]
v <- which(d_all_wide$strata_cat == X) # Strata in sample absent from population
if(length(v) > 0) { d_all_wide <- d_all_wide[-v, ] }
#Zensus$strata_cat[which(Zensus$strata_cat %notin% unique(d_all_wide$strata_cat))]

Zensus_strata <- Zensus %>% 
  group_by(strata_cat) %>% 
  dplyr::summarise(Freq = sum(group_size_population))

d_all_wide$population_size <- sum(Zensus_strata$Freq, na.rm = TRUE)
  
```


```{r calculate_weights}
###### INCLUDE ALL PARTICIPANTS REGARDLESS OF NUMBER OF WAVES 
df <- get_contacts(d_all_wide,min.waves=1)

# Function to calculate weights based on strata -  wave stratified datasets will be passed to this function
get_weights <- function(data) {
  d <- data %>% 
    group_by(strata_cat) %>%
    mutate(strat_samplesize = n()) %>%
    ungroup() %>%
    mutate(weight_bl_age_sex_hh = round(pop_strat_size/strat_samplesize,0))  # Calculate weights. Rounded to ensure full integer values
  return(d)
}

####FUNCTION TO CALCULATE WEIGHTS#################
calc.weights <- function(data){
  data <- data %>%
    left_join(Zensus_strata) %>% # Join strata population size and rename
    mutate(pop_strat_size = Freq,.keep="unused") %>% # rename variabe
    group_by(wave) %>% # create wave-stratified datasets
    tidyr::nest() %>%
    mutate(new_dat = lapply(data,get_weights)) %>% # apply weighting function to create new datasets containing weight variables
    dplyr::select(wave,new_dat) %>% # select only new dataset
    unnest(cols = new_dat) %>% # unnest = combine into one data.frame
    dplyr::select(new_id,wave,everything()) %>% # reorder
    arrange(new_id,wave) %>% # sort for better overview
    filter(!is.na(weight_bl_age_sex_hh)) %>%
    ungroup %>%
    return()
}
##################################################




#####CALCULATE WEIGHTS########################################
df <- calc.weights(df)
#####CALCULAtE WEIGHTS FOR WEEKDAY/WEEKEND
df <- df %>% mutate(dayweight = case_when(weekend_weekday=="weekend"~ 2/7,
                            weekend_weekday=="weekday"~5/7))
#####COMBINE BOTH WEIGHTS
df$weight <- df$weight_bl_age_sex_hh*df$dayweight
##############################################################




plot.mean.df <- function(x,waves=levels(x$wave),weighted=F,R=1000,title="Bootstraped mean value with 95% percentile CI - R = 1000 ") {
set.seed(12345678)
plot_df <- x %>%
  filter(wave %in% waves) %>%
  dplyr::group_by(wave) %>%
  do(boot_mean(.$contacts,w=.$weight)) %>%
  ungroup 
}


change.waves <- function(x){
x$wave_2 <- as.numeric(x$wave)+100
x$wave_2[x$wave_2==101]<-1
x$wave_2[x$wave_2==102]<-3
x$wave_2[x$wave_2==103]<-5
x$wave_2[x$wave_2==104]<-7
x$wave_2[x$wave_2==105]<-9
x$wave_2[x$wave_2==106]<-11
x$wave_2[x$wave_2==107]<-13
x$wave_2[x$wave_2==108]<-15
x$wave_2[x$wave_2==109]<-19
x$wave_2[x$wave_2==110]<-23
x$wave_2[x$wave_2==111]<-25
x$wave_2[x$wave_2==112]<-27
x$wave_2[x$wave_2==113]<-28
x$wave_2[x$wave_2==114]<-31
x$wave_2[x$wave_2==115]<-33
x$wave_2[x$wave_2==116]<-35
x$wave_2[x$wave_2==117]<-40
x$wave_2[x$wave_2==118]<-44
x$wave_2[x$wave_2==119]<-47
x$wave_2[x$wave_2==120]<-50
x$wave_2[x$wave_2==121]<-55
x$wave_2[x$wave_2==122]<-57
x$wave_2[x$wave_2==123]<-59
x$wave_2[x$wave_2==124]<-63
x$wave_2[x$wave_2==125]<-67
x$wave_2[x$wave_2==126]<-71
x$wave_2[x$wave_2==127]<-74
x$wave_2[x$wave_2==128]<-76
x$wave_2[x$wave_2==129]<-78
x$wave_2[x$wave_2==130]<-80
x$wave_2[x$wave_2==131]<-82
return(x)
}

```


```{r}
# #new age groups
# groups <- sort(unique(df$age_group))
# groups <- setdiff(groups,c("Don’t know","Prefer not to answer","<1"))
# df$age_group_2[df$age_group=="<1" | df$age_group=="1-4" | df$age_group=="5-9"| df$age_group=="10-14" | df$age_group=="15-19"] <- "0-19"
# df$age_group_2[df$age_group=="20-24" | df$age_group=="25-34" ] <- "20-34"
# df$age_group_2[df$age_group=="35-44" | df$age_group=="45-54"] <- "35-54"
# df$age_group_2[ df$age_group=="55-64" ] <- "55-64"
# df$age_group_2[ df$age_group=="65-69"] <- "65-69"
# df$age_group_2[ df$age_group=="70-74" | df$age_group=="75-79" | df$age_group=="80-84" | df$age_group=="85+"] <- "70+"
# group2_2 <- sort(unique(df$age_group_2))


#generate max number of contacts for y-axis
df$contacts<-df$all_contact_n_Q75
plot_df<-plot.mean.df(df)
max_y_axis<-max(plot_df$upper)

# define labels
label_17waves <- c("30.04.-06.05.", "14.05.–21.05.", "28.05.–04.06.", "11.06.–22.06.", "26.06.-01.07.", "09.07.-16.07.", "24.07-29.07.", "07.08-11.08.",
                   "04.09.-09.09.", "30.09.-05.10.","14.10.-21.10.", "29.10.-03.11.", "05.11.-10.11.", "25.11.-30.11.", "09.12.-15.12.",
                   "23.12.-30.12.", "28.01.-02.02.", "24.02.-03.03.", "17.03.-26.03.", "07.04.-15.04.", "12.05.-24.05.", 
                   "26.05.-03.06.", "09.06.-22.06", "07.07.-19.07.", "04.08.-13.08.", "01.09.-14.09.", "22.09.-06.10.", "08.10.-20.10.", 
                   "22.10.-02.11.", "03.11-09.11.", "17.11.-23.11.")
label_16waves <- c("30.04.-06.05.", "14.05.–21.05.", "28.05.–04.06.", "11.06.–22.06.", "26.06.-01.07.", "09.07.-16.07.", "24.07-29.07.", "07.08-11.08.", "04.09.-09.09.", "30.09.-05.10.",
                              "14.10.-21.10.", "29.10.-03.11.", "05.11.-10.11.", "25.11.-30.11.", "09.12.-15.12.", 
                              "23.12.-30.12.")
#define breaks
breaks_17waves <- c(1,3,5,7,9,11,13,15,19,23,25,27,28, 31, 33, 35, 40, 44, 47, 50, 55, 57, 59, 63, 67, 71, 74, 76, 78, 80, 82)
breaks_16waves <- c(1,3,5,7,9,11,13,15,19,23,25,27,28, 31, 33, 35)
```

## Mask wearing
```{r}
table1(~mask_0 + transportno_0|wave, data=df)

#Mask 

df_histo <- df %>% select(new_id, wave, mask_0)
df_histo$wave_num <- as.numeric(df_histo$wave)
df_histo <- df_histo %>% group_by(wave_num, mask_0) %>% dplyr::summarise(mask_0_n=n())


                      
mask_per_wave <- ggplot(df_histo, 
               aes_string(x = "wave_num", y = "mask_0_n", fill = "mask_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#663399", "#028482"),
                      name = "Mask use",
                      labels = c("No", "Yes")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

mask_per_wave
mask_per_wave_all <- paste0(path_figures, "/mask_all", ".png")
ggsave(mask_per_wave_all, width=10, height=7)




#Mask restricted to those with at least one non-hh contact 
df_histo <- df %>% filter(non_hh_contact_n_Q75>0) %>% select(new_id, wave, mask_0)
df_histo$wave_num <- as.numeric(df_histo$wave)
df_histo <- df_histo %>% group_by(wave_num, mask_0) %>% dplyr::summarise(mask_0_n=n())

mask_per_wave_restricted <- ggplot(df_histo, 
               aes_string(x = "wave_num", y = "mask_0_n", fill = "mask_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#663399", "#028482"),
                      name = "Mask use",
                      labels = c("No", "Yes")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

mask_per_wave_restricted
mask_per_wave_restricted <- paste0(path_figures, "/mask_restricted", ".png")
ggsave(mask_per_wave_restricted, width=10, height=7)

```

## Transport Use

```{r}

#Transport
##remember No means yes, used public transport
table1(~ transportno_0|wave, data=df)

df_histo <- df %>% select(new_id, wave, transportno_0)
df_histo$wave_num <- as.numeric(df_histo$wave)
df_histo <- df_histo %>% group_by(wave_num, transportno_0) %>% dplyr::summarise(transportno_0_n=n())


                      
transport_all <- ggplot(df_histo, 
               aes_string(x = "wave_num", y = "transportno_0_n", fill = "transportno_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#990033", "#336699"),
                      name = "Transport use",
                      labels = c("Yes", "No")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

transport_all
transport_per_wave_all <- paste0(path_figures, "/transport_all", ".png")
ggsave(transport_per_wave_all, width=10, height=7)
```




## Percent people having no non-hh contact
```{r}

df_histo <- df %>% select(new_id, wave, non_hh_contact_n_Q75)
df_histo$wave_num <- as.numeric(df_histo$wave)
df_histo$non_hh_contacts_over_0[df_histo$non_hh_contact_n_Q75==0] <- "No"
df_histo$non_hh_contacts_over_0[df_histo$non_hh_contact_n_Q75>0] <- "Yes"
table1(~ non_hh_contacts_over_0 + as.factor(non_hh_contact_n_Q75)|wave, data=df_histo)
df_histo <- df_histo %>% group_by(wave_num, non_hh_contacts_over_0) %>% dplyr::summarise(non_hh_contacts_over_0_n=n())


no_non_hh_contact <- ggplot(df_histo, 
               aes_string(x = "wave_num", y = "non_hh_contacts_over_0_n", fill = "non_hh_contacts_over_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#663399", "#028482"),
                      name = "Non household\ncontacts",
                      labels = c("No", "Yes")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

no_non_hh_contact
no_non_hh_contact_name <- paste0(path_figures, "/no_non_hh_contact", ".png")
ggsave(no_non_hh_contact_name, width=10, height=7)



```




### Only inside household contacts 
```{r}
df$contacts<-df$hh_contact_n_inside
plot.mean(df,weighted = T,title="Weighted bootstraped mean with 95% percentile CI - R = 1000 ")
#n.table(df$wave)

```


### Only outside household contacts 
```{r}
df$contacts<-df$hh_contact_n_outside
plot.mean(df,weighted = T,title="Weighted bootstraped mean with 95% percentile CI - R = 1000 ")
#n.table(df$wave)

```


## All contacts incl. group contacts 
```{r all_with_Q}
df$contacts<-df$all_contact_n_Q75
#plot.mean(df,weighted = T,title="")
#n.table(df$wave)
plot_df<-plot.mean.df(df)
plot_df <- change.waves(plot_df)
plot_df_all_contacts_Q <- plot_df

all_contacts_Q<- ggplot(aes(x=wave_2,y=mean),data=plot_df) +
  labs(x = "Date", y= "Mean contacts") +
  theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) +
  scale_x_continuous(breaks=breaks_17waves,labels = label_17waves, expand=c(0,0)) +
  geom_line(group=1, color = "#028482", size=1) +
  geom_point(colour = "#028482") +
  geom_ribbon(aes(ymin=lower,ymax=upper), linetype=2, alpha=0.1,group=1, fill = "#028482") +
  scale_y_continuous(expand=c(0,0), limits=c(0, max_y_axis))

all_contacts_Q

Setting_panel_FILENAME <- paste0(path_figures, "/Weighted mean contacts with Q_",truncate, ".png")
ggsave(Setting_panel_FILENAME, width=10, height=7)

```


