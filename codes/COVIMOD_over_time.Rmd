---
title: "Contact survey (COVIMOD) in NRW"
author: "Thi Phuong Huynh"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true # able of contents to the left, visible even when the document is scrolled
---

# set up

Date: <b>`r format(Sys.Date(), "%B %d, %Y")`</b>

All computations were performed with `r R.Version()$version.string`.

This work is adapted from Veronika's codes

```{r set up, include=FALSE}

rm(list = ls())
knitr::opts_chunk$set(fig.retina = 1, fig.height = 7, fig.width = 14,
                      echo = FALSE, message = FALSE, warning = FALSE,
                      results='hide')

Sys.setlocale("LC_TIME", "C")
BEGIN_RMD <- Sys.time() # Keeping track of running time
set.seed(75876342)
options(warn = 1) # If warn is one, warnings are printed as they occur.

path_covimod <- "C:/Users/huynh/sciebo/NRW_descriptive/COVIMOD/all_waves"
path_mobility <- "C:/Users/huynh/sciebo/NRW_descriptive/data/mobility"
path_figures <- "C:/Users/huynh/sciebo/NRW_descriptive/results/covimod"
path_contact_pattern <- "C:/Users/huynh/sciebo/NRW_descriptive/results/covimod/contact_pattern"


# library loading
library(dplyr)
library(ggplot2)
library(tidyverse)
library(epiDisplay)
library(socialmixr)
library(data.table)
library(Hmisc)
library(epiDisplay)
library(summarytools)
library(patchwork)
library(gtsummary)
library(table1)
library(readxl)
library(reshape2)
library(kableExtra)
library(DescTools)
library(randomcoloR)
library(table1)
library(expss)
library(Cairo)
library(cowplot)
library(oxcgrt)
library(dplyr)
library(scales)
library(ggpubr)
library(stringr)
library(lubridate)
library(openxlsx)
library(tidyselect)


library(socialmixr)
# https://cran.r-project.org/web/packages/socialmixr/vignettes/introduction.html
library(RColorBrewer) # used to customize (heatmap) color
library(ggmosaic)
library(gridExtra)
library(grid)
library(Rmisc)
library(gtable)
library(zoo)

# socialmixr::contact_matrix # to see source of function

```

#changeable variables

```{r}
#at which number should group contacts be truncated?
truncate <- 100 #question 100 ?
truncate_lshtm <- 50 #
current_wave <-33
base_size <- 10 # size of the font in plot


```

#Function

```{r Functions}
`%notin%` <- Negate(`%in%`)

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=3, round.integers = F), 
       c("",
         "Mean (SD)"=sprintf("%s (%s)", MEAN, SD), 
         "Median (Min, Max)"=sprintf("%s [%s, %s]", MEDIAN, MIN, MAX),
         "Median (P25, P75)"=sprintf("%s [%s, %s]", MEDIAN, q25, q75)))
}

hh_contact_number <- function(x, new_id, wave) {
  dummy_hh <- data.table(x)
  dummy_hh <- dummy_hh %>% 
    filter(dummy_hh$hh_met_this_day == "Yes") # only hh member actually met!!!
  if(sum(is.na(dummy_hh$new_id)) > 0) { message("new_id has NAs!") }
  dummy_hh <- dummy_hh %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(hh_contact_n = n())
  return(dummy_hh)
}

non_hh_contact_number <- function(x, new_id, wave) {
  dummy_outside <- data.table(x)
  if(sum(is.na(dummy_outside$new_id)) > 0) { message("new_id has NAs!") }
  dummy_outside <- dummy_outside %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(non_hh_contact_n = n())
  
  dummy_work <- data.table(x)
  dummy_work <- dummy_work %>% 
    filter(place_work == "Yes")
  dummy_work <- dummy_work %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(work_contact_n = n())
  dummy_all <- merge(dummy_outside, dummy_work, by = c("new_id", "wave"), all = T)
  rm(dummy_outside, dummy_work)
  
  dummy_homeown <- data.table(x)
  dummy_homeown <- dummy_homeown %>% 
    filter(place_home_own == "Yes")
  dummy_homeown <- dummy_homeown %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(home_own_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_homeown, by = c("new_id", "wave"), all = T)
  rm(dummy_homeown)
  
  dummy_homeelse <- data.table(x)
  dummy_homeelse <- dummy_homeelse %>% 
    filter(place_home_else == "Yes")
  dummy_homeelse <- dummy_homeelse %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(home_else_contact_n = n())
  dummy_all <- merge(dummy_all, dummy_homeelse, by = c("new_id", "wave"), all = T)
  rm(dummy_homeelse)
  
  dummy_worship <- data.table(x)
  dummy_worship <- dummy_worship %>% 
    filter(place_worship=="Yes")
  dummy_worship <- dummy_worship %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(worship_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_worship, by = c("new_id", "wave"), all = T)
  rm(dummy_worship)
  
  dummy_transport <- data.table(x)
  dummy_transport <- dummy_transport %>% 
    filter(place_transport=="Yes")
  dummy_transport <- dummy_transport %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(transport_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_transport, by = c("new_id", "wave"), all = T)
  rm(dummy_transport)
  
  dummy_school <- data.table(x)
  dummy_school <- dummy_school %>% 
    filter(place_school=="Yes")
  dummy_school <- dummy_school %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(school_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_school, by = c("new_id", "wave"), all = T)
  rm(dummy_school)
  
  dummy_shop_essential <- data.table(x)
  dummy_shop_essential <- dummy_shop_essential %>% 
    filter(place_shop_essential=="Yes")
  dummy_shop_essential <- dummy_shop_essential %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(shop_essential_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_shop_essential, by = c("new_id", "wave"), all = T)
  rm(dummy_shop_essential)
  
  dummy_shop_non_essential <- data.table(x)
  dummy_shop_non_essential <- dummy_shop_non_essential %>% 
    filter(place_shop_non_essential=="Yes")
  dummy_shop_non_essential <- dummy_shop_non_essential %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(shop_non_essential_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_shop_non_essential, by = c("new_id", "wave"), all = T)
  rm(dummy_shop_non_essential)
  
  dummy_entertainment <- data.table(x)
  dummy_entertainment <- dummy_entertainment %>% 
    filter(place_entertainment=="Yes")
  dummy_entertainment <- dummy_entertainment %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(entertainment_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_entertainment, by = c("new_id", "wave"), all = T)
  rm(dummy_entertainment)
  
  dummy_sport <- data.table(x)
  dummy_sport <- dummy_sport %>% 
    filter(place_sport=="Yes")
  dummy_sport <- dummy_sport %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(sport_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_sport, by = c("new_id", "wave"), all = T)
  rm(dummy_sport)
  
  dummy_park <- data.table(x)
  dummy_park <- dummy_park %>% 
    filter(place_park=="Yes") 
  dummy_park <- dummy_park %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(park_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_park, by = c("new_id", "wave"), all = T)
  rm(dummy_park)
  
  dummy_healthcare <- data.table(x)
  dummy_healthcare <- dummy_healthcare %>% 
    filter(place_healthcare=="Yes") 
  dummy_healthcare <- dummy_healthcare %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(healthcare_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_healthcare, by = c("new_id", "wave"), all = T)
  rm(dummy_healthcare)
  
  dummy_beauty <- data.table(x)
  dummy_beauty <- dummy_beauty %>% 
    filter(place_beauty=="Yes") 
  dummy_beauty <- dummy_beauty %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(beauty_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_beauty, by = c("new_id", "wave"), all = T)
  rm(dummy_beauty)
  
  dummy_multiple <- data.table(x)
  dummy_multiple <- dummy_multiple %>% 
    filter(place_multiple==1) 
  dummy_multiple <- dummy_multiple %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(multiple_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_multiple, by = c("new_id", "wave"), all = T)
  rm(dummy_multiple)
  
  dummy_other <- data.table(x)
  dummy_other <- dummy_other %>%
    filter(!is.na(place_oth))
  dummy_other <- dummy_other %>%
    group_by(new_id, wave) %>%
    dplyr::summarise(oth_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_other, by = c("new_id", "wave"), all = T)
  rm(dummy_other)
  
  dummy_not_specified <- data.table(x)
  dummy_not_specified <- dummy_not_specified %>%
  filter(
    (place_home_own!="Yes" |is.na(place_home_own)) &
      (place_home_else!="Yes" |is.na(place_home_else)) &
      (place_work!="Yes" |is.na(place_work)) &
      (place_worship!="Yes" |is.na(place_worship)) &
      (place_transport!="Yes" |is.na(place_transport)) &
      (place_school!="Yes" |is.na(place_school)) &
      (place_shop_essential!="Yes" |is.na(place_shop_essential)) &
      (place_shop_non_essential!="Yes" |is.na(place_shop_non_essential)) &
      (place_entertainment!="Yes" |is.na(place_entertainment)) &
      (place_sport!="Yes" |is.na(place_sport)) &
      (place_park!="Yes" |is.na(place_park)) &
      (place_healthcare!="Yes" |is.na(place_healthcare)) &
      (place_beauty!="Yes" |is.na(place_beauty)) &
      (place_oth!=1 | is.na(place_oth))
        )
  dummy_not_specified <- dummy_not_specified %>% 
    group_by(new_id, wave) %>% 
    dplyr::summarise(not_specified_contact_n=n())
  dummy_all <- merge(dummy_all, dummy_not_specified, by = c("new_id", "wave"), all = T)
  rm(dummy_not_specified)
  
  
dummy_leisure <- data.table(dt_outside_all)
dummy_leisure <- dummy_leisure %>% 
  filter(place_home_own=="Yes" | place_home_else=="Yes" | place_worship=="Yes" | 
           place_shop_non_essential=="Yes" | place_entertainment=="Yes" | place_sport=="Yes" | place_park=="Yes" | place_beauty=="Yes") 
dummy_leisure <- dummy_leisure %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(leisure_contact_n=n())
dummy_all <- merge(dummy_all, dummy_leisure, by = c("new_id", "wave"), all = T)
rm(dummy_leisure)

dummy_other_combined<- data.table(dt_outside_all)
dummy_other_combined <- dummy_other_combined %>% 
  filter(place_transport=="Yes" | place_healthcare=="Yes" | place_oth==1 | place_shop_essential=="Yes") 
dummy_other_combined <- dummy_other_combined %>% 
  group_by(new_id, wave) %>% 
  dplyr::summarise(other_combined_contact_n=n())
dummy_all <- merge(dummy_all, dummy_other_combined, by = c("new_id", "wave"), all = T)
rm(dummy_other_combined) 

  return(dummy_all)
}

my.bar.charts.incl.hh <- function(x) {
  dataset_long <- x
  p1 <- ggplot(dataset_long, 
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p1)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type,",
                      "data = dataset_long,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
  
  p2 <- ggplot(dataset_long,
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    facet_wrap( ~ age_group) +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "none",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p2)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type + age_group,",
                      "data = dataset_long,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
}

my.bar.charts.excl.hh <- function(x, exclude_hh_phrase) {
  dataset_long <- x
  p1 <- ggplot(subset(dataset_long, contact_type != exclude_hh_phrase), 
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p1)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type,",
                      "data = subset(dataset_long, contact_type != '", exclude_hh_phrase, "'),",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
  
  p2 <- ggplot(subset(dataset_long, contact_type != exclude_hh_phrase),
               aes_string(x = "wave", y = "contact_n", fill = "contact_type")) + 
    geom_bar(position = "fill", stat = "identity") +
    facet_wrap( ~ age_group) +
    scale_y_continuous(labels = scales::percent_format()) + 
    scale_fill_manual(values = palette,
                      name = "Setting") +
    xlab("Date") +
    ylab("Percent of overall contacts") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "none",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p2)
  
  text2eval <- paste0("table1::table1(~ ",
                      "contact_n",
                      " | contact_type + age_group,",
                      "data = subset(dataset_long, contact_type != '", exclude_hh_phrase, "'),",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
}

my.boxplots <- function(x, current_contact_variable, TITLE) {
  WORK <- grep("work", current_contact_variable)
  SCHOOL <- grep("school", current_contact_variable)
  
  if(length(WORK) > 0) {
    dataset_wide <- subset(x, job %in% has_work_contacts)
  } else if(length(SCHOOL) > 0) {
    dataset_wide <- subset(x, job == "Student/Pupil" | school %in% has_school_contacts)
  } else {
    dataset_wide <- x
  }
  
  dummy_N <- dataset_wide[, c("wave", current_contact_variable)]
  # # NOT RUN: Table 1 shows N per group
  # dummy_N <- dummy_N %>% 
  #   group_by(wave) %>% 
  #   dplyr::summarise(N_ID=n())
  # levels(dataset_wide[, "wave"]) <- paste0(dummy_N$wave, " (n =",
  #                                          dummy_N$N_ID, ")")
  # rm(dummy_N)
  
  p1 <- ggplot(dataset_wide, aes_string(x = "wave", y = current_contact_variable)) +  
    geom_boxplot() + 
    scale_y_continuous(trans=scales::pseudo_log_trans(base = 10))+ 
    xlab("Date") +
    ylab("Number of contacts") +
    ggtitle(TITLE) +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p1)
  
  text2eval <- paste0("table1::table1(~ ",
                      current_contact_variable,
                      " | wave, data = dataset_wide,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
  
  names(dummy_N) <- c("wave", "contact_n")
  dummy_N <- dummy_N %>%
    group_by(wave) %>%
    summarise(MEAN = mean(contact_n),
              SD = sd(contact_n),
              MEDIAN = median(contact_n),
              MIN = min(contact_n),
              MAX = max(contact_n),
              IQR = IQR(contact_n))

  p2 <- ggplot(data = dummy_N) +  
    geom_point(aes_string(x = "wave", y = "MEAN"), colour = "red", size = 1.25, shape = 15) +
    geom_line(aes_string(x = "wave", y = "MEAN"), colour = "red", group = "wave") +
    geom_point(aes_string(x = "wave", y = "MEDIAN"), colour = "blue", size = 1.25, shape = 17) +
    geom_line(aes_string(x = "wave", y = "MEDIAN"), colour = "blue", group = "wave") +
    scale_y_continuous(limits = c(0, max(c(1, dummy_N$MEAN, dummy_N$MEDIAN)))) + 
    xlab("Date") +
    ylab("Mean contacts (red squares) /\nMedian number of contacts (blue circles)") +
    ggtitle(TITLE) +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p2)
  
  p3 <- ggplot(dataset_wide, aes_string(x = "wave", y = current_contact_variable)) +  
    geom_boxplot() + 
    facet_wrap( ~ age_group) +
    # stat_summary(fun=mean, geom="point", shape=20, size=5, color="red", fill="red") +
    scale_y_continuous(trans=scales::pseudo_log_trans(base = 10))+ 
    xlab("Date") +
    ylab("Number of contacts") +
    ggtitle(TITLE) +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = base_size, 
                                     angle = 45, hjust = 1, vjust = 1),
          axis.text.y = element_text(colour = "black", size = base_size),
          axis.title = element_text(colour = "black", size = base_size),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "bottom",
          legend.text = element_text(colour = "black", size = base_size),
          legend.title = element_text(colour = "black", size = base_size, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold")
    )
  print(p3)
  
  text2eval <- paste0("table1::table1(~ ",
                      current_contact_variable,
                      " | wave + age_group, data = dataset_wide,",
                      "render.categorical='FREQ (PCTnoNA%)',",
                      "render.continuous=my.render.cont,",
                      "overall = NULL)")
  print(eval(parse(text = text2eval)))
}

########################################
#These function below for descriptive table, figures ,etc
#######################################

######DONT FORGET TO CHANGE IF MORE WAVES ARE ADDED!!!!

## Prepare function to get all contacts
get_contacts <- function(data,waves=c(1:n),min.waves= NULL,include.group = F) {
  
  x <- data
  waves <- levels(x$wave)[waves]
  IDS <- x %>%
    filter(wave %in% waves) %>%
    mutate(wave = droplevels(wave))%>%
    group_by(new_id) %>%
    dplyr::summarise(n_waves = n()) %>% # count number of waves a participant join
    filter(n_waves >= min.waves) %>%  # filter a participant with at least joining n waves
    dplyr::select(new_id) %>% pull  # create a list of participants selected above 
  
  dat <- x %>%
    filter(wave %in% waves) %>%
    mutate(wave = droplevels(wave)) %>%
    filter(new_id %in% IDS) # select participant in IDS list only
  
  return(dat)
}



# Prepare function to get random rows. Used to highlight random slopes in spaghetti plot
random_subset <- function(x) {
  id <- sample(1:length(x), length(x)/10, replace=T)
  x[id] <- 1
  x[-id] <- 0
  x <- as.numeric(x)
  return(x)
}

# Function to compute change relative to previous wave
relative.change <- function(x) { c(0,diff(x[1:length(x)],differences=1))}


# Function to prepare spaghetti plots
spaghetti.plot <- function(data,waves=levels(data$wave),relative=F,log=F,alpha=.1,title="only participants with observations in at least two time-points") {

  if(relative == T) {data <- data %>% group_by(new_id) %>% mutate(contacts = relative.change(contacts))}
  
  p <- data %>%
        filter(wave %in% waves) %>%
        mutate(random = as.factor(random_subset(contacts))) %>%
        ggplot(aes(x=wave,y=contacts)) +
        geom_line(aes(group=new_id),alpha=alpha) + 
        geom_point(alpha=alpha) +
        theme(legend.position = "none",
              axis.text.x = element_text(angle = 90)) +
        ggtitle(paste0(title))
  
  if(log==T) {p <- p +   scale_y_log10() + ylab("contacts[logscale]") }
  
  print(p)

}

# Function to prepare boxplots
my.boxplot <- function(x,waves=levels(x$wave),relative=F,log=F,title="only participants with observations in at least two time-points") {

  if(relative == T) {x <- x %>% group_by(new_id) %>% mutate(contacts = relative.change(contacts))}
  
  p <- x %>%
        filter(wave %in% waves) %>%
        ggplot(aes(x=wave,y=contacts)) +
        geom_boxplot() + 
        stat_summary(fun=mean, geom="point", shape=20,col="black",size=1, fill="red",aes(shape="mean")) +
        stat_summary(fun=mean,group=1, geom="line",col="black",size=1,linetype="dashed") +
        theme(legend.position = "none",
              axis.text.x = element_text(angle = 90)) +
        ggtitle(paste0(title))
  
  if(log==T) {p <- p +   scale_y_log10() + ylab("contacts[logscale]") }
  
  print(p)

}


##########################
#### Make UpSet plots ####
##########################


plot.upset <- function(x) {
  
#x <- x %>% filter(contacts>0)

m <- table(x$new_id,x$wave) %>%
  make_comb_mat()

ht <- UpSet(m,
      comb_order = order(comb_size(m),decreasing = T),
      set_order = order(set_size(m)),
      row_names_side = "right",
      right_annotation = NULL,
      comb_col = "#3B3B3B",
      left_annotation = rowAnnotation(
        "Set size" = anno_barplot(set_size(m), 
                                  axis_param = list(direction = "reverse"),
                                  border = FALSE, 
                                  #gp = gpar(fill = mypal,col="white"), 
                                  width = unit(2, "cm")
        )))

print(ht)

}


###############################
#### Mean change over time ####
###############################
library(boot)

#sample_mean <- function(x,i) {
#  return(mean(x[i]))
#}

sample_mean <- function(x,i,j) {
  d <- x[i]
  w <- j[i]
  return(weighted.mean(d,w))
}

boot_mean <- function(x,w) {
  set.seed(1234567)
  bo <- boot(x,sample_mean,R=1000,j=w)
  ci <- boot.ci(bo, conf=0.95,type="perc")
  out <- data.frame("mean" = bo$t0,
              "lower" = ci$perc[4],
              "upper" = ci$perc[5])
  return(out)
}

plot.mean <- function(x,waves=levels(x$wave),weighted=F,R=1000,title="Bootstraped mean value with 95% percentile CI - R = 1000 ") {

if(weighted==T) {
plot_df <- x %>%
  filter(wave %in% waves) %>%
  dplyr::group_by(wave) %>%
  do(boot_mean(.$contacts,w=.$weight)) %>%
  ungroup 
} else {
plot_df <- x %>%
  filter(wave %in% waves) %>%
  dplyr::group_by(wave) %>%
  do(boot_mean(.$contacts,w=rep(1,nrow(x)))) %>%
  ungroup  
  
}
}

n_overall.table <- function(x) {
  table(x) %>% as_tibble() %>% rename("Number of waves" = x, "Number of participants" = n) %>% t() %>% kable %>% kable_styling()
}

n.table <- function(x) {
  table(x) %>% as_tibble() %>% rename(Wave = x, Observations = n) %>% t() %>% kable %>% kable_styling()
}

```

#wave label

```{r Vectors to use}
 wave_label <- c("30.04.–06.05.(W01)",
           "14.05.–21.05. (W02)",
           "28.05.–04.06. (W03)",
           "11.06.–22.06. (W04)",
           "26.06.–01.07. (W05)",
           "09.07.–16.07. (W06)",
           "24.07.–29.07. (W07)",
           "07.08.–11.08. (W08)",
           "04.09.–09.09. (W09)",
           "30.09.–05.10. (W10)",
           "14.10.–21.10. (W11)",
           "29.10.–03.11. (W12)",
           "05.11.–10.11. (W13)", 
           "25.11.-30.11. (W14)",
           "09.12.-15.12. (W15)",
           "23.12.-30.12. (W16)", 
           "28.01.-02.02. (W17)", 
           "24.02.-03.03. (W18)", 
           "17.03.-26.03. (W19)",
           "07.04.-15.04. (W20)",
           "12.05.-24.05. (W21)",
           "26.05.-03.06. (W22)", 
           "09.06.-22.06. (W23)", 
           "07.07.-19.07. (W24)", 
           "04.08.-13.08. (W25)", 
           "01.09.-14.09. (W26)",
           "22.09.-06.10. (W27)", 
           "08.10.-20.10. (W28)", 
           "22.10.-02.11. (W29)",
           "03.11.-09.11. (W30)", 
           "17.11.-23.11. (W31)",
           "08.12.-17.12 (W32)",
           "24.12.31.12 (W33)")

 wave_date <- c("30.04.2020",
           "14.05.2020",
           "28.05.2020",
           "11.06.2020",
           "26.06.2020",
           "09.07.2020",
           "24.07.2020",
           "07.08.2020",
           "04.09.2020",
           "30.09.2020",
           "14.10.2020",
           "29.10.2020",
           "05.11.2020", 
           "25.11.2020",
           "09.12.2020",
           "23.12.2020", 
           "28.01.2021", 
           "24.02.2021", 
           "17.03.2021",
           "07.04.2021",
           "12.05.2021",
           "26.05.2021", 
           "09.06.2021", 
           "07.07.2021", 
           "04.08.2021", 
           "01.09.2021",
           "22.09.2021", 
           "08.10.2021", 
           "22.10.2021",
           "03.11.2021", 
           "17.11.2021",
           "08.12.2021",
           "24.12.2021") 
 
places <- c("place_home_own",
            "place_home_else",
            "place_work",
            "place_worship",
            "place_transport",
            "place_school",
            "place_shop_essential", 
            "place_shop_non_essential",
            "place_entertainment",
            "place_sport",
            "place_park",
            "place_healthcare",
            "place_beauty",
            "place_oth")
LABEL_PLACES <- c("Own home",
                  "Somebody else's home",
                  "Work",
                  "Worship",
                  "Transport",
                  "School/Uni/Kindergarten",
                  "Essential shopping",
                  "Non-essential shopping",
                  "Entertainment",
                  "Sport",
                  "Park",
                  "Healthcare",
                  "Beauty",
                  "Other",
                  "Not specified",
                  "Multiple locations")
CONTACT_N <- sub("place_", "", places) # delete 'place_' pattern in each element of vector places
CONTACT_N <- paste0(CONTACT_N, "_contact_n")

WEIGHTING <- c("Unweighted", "Weights age & household size")
HH_OUTSIDE <- c()

palette <- c("#003366", "#336699", "#CCFFFF", "#028482", "#663399", "#990033", "#FF3333", "#FF9900", 
             "#266A2E", "#55D43F", "#404040", "#C87533", "#DCDCDC", "#FFDE00", "#F1B2E1", "#FF717E")
# print(palette)
# scales::show_col(palette)

```

# Data overview

Each wave contain 3 datasets: d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised.

##old questionaire

```{r Data information old questionnaire, i.e. wave 1 to 13, results='markup', comment=""}

DATA <- list.files(path = paste0(path_covimod,"/old_questionnaire"),
                   pattern = "RData",
                   full.names = TRUE)

# all files must have the same structure:
counter <- 0
for(current_file in DATA) {
  counter <- counter + 1
  load(current_file, .GlobalEnv) # , verbose=TRUE)
  WAVE <- current_file
  WAVE <- sub(paste0(path_covimod,"/old_questionnaire/complete wave "), "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))  

  #dataset1:d_self-
  d1 <- as.data.frame(names(d_self_anonymised))
  names(d1) <- "variable"
  d1$wave <- WAVE
  d1$dataset <- "d_self"
  d1$included <- NA_character_
  d_self_anonymised$hh_p_excl_0 <- as.integer(as.character(d_self_anonymised$hh_p_excl_0))
  for(current_column in 1:length(names(d_self_anonymised))) {
    d1$included[current_column] <- paste0(class(d_self_anonymised[, current_column]),collapse = ", ")
  }  
  
  # place_12 = "An einem anderen Ort (bitte angeben)" -> renamed place_oth
  # dt_hh_anonymised$place_12 <- NULL  
  
  d2 <- as.data.frame(names(dt_hh_anonymised))
  names(d2) <- "variable"
  d2$wave <- WAVE
  d2$dataset <- "dt_hh"
  d2$included <- NA_character_
  for(current_column in 1:length(names(dt_hh_anonymised))) {
    d2$included[current_column] <- paste0(class(dt_hh_anonymised[, current_column]),collapse = ", ")
  }  
  
#dataset3:dt_outside
  # place_12 = "An einem anderen Ort (bitte angeben)" -> renamed place_oth
  # dt_outside_anonymised$place_12 <- NULL
  d3 <- as.data.frame(names(dt_outside_anonymised))
  names(d3) <- "variable"
  d3$wave <- WAVE
  d3$dataset <- "dt_outside"
  d3$included <- NA_character_
  for(current_column in 1:length(names(dt_outside_anonymised))) {
    d3$included[current_column] <- paste0(class(dt_outside_anonymised[, current_column]),
                                          collapse = ", ")
  }  
  
  aux <- merge(d1, d2, all = TRUE)
  aux <- merge(aux, d3, all = TRUE)
  aux$n_variable <- dim(d1)[1] # to know how many questions/variables in each wave
  
  if(counter == 1) {
    info_long <- aux
  } else {
    info_long <- merge(info_long, aux, all = TRUE)
  }
  rm(d1, d2, d3, aux, d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

info_long1 = info_long %>% filter(variable=="age_0")#any variable possible
info_long <- info_long %>% select (-c(n_variable)) # delete n_variable created above
info_wide <- spread(info_long, wave, included)


# write.csv(info_wide,paste0(path_covimod,"/info_wave_1-13.csv"))

```

##new questionaire

```{r Data information new questionnaire, i.e. wave 14 onwards}

DATA_new <- list.files(path = paste0(path_covimod,"/new_questionnaire"),
                   pattern = "RData",
                   full.names = TRUE)

# all files must have the same structure:
counter <- 0
for(current_file in DATA_new) {
  counter <- counter + 1
  load(current_file, .GlobalEnv) # , verbose=TRUE)
  WAVE <- current_file
  
  WAVE <- sub(paste0(path_covimod,"/new_questionnaire/complete wave "), "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))
  print(WAVE)
 
  #dataset1: d_self
  d1 <- as.data.frame(names(d_self_anonymised))
  names(d1) <- "variable"
  d1$wave <- WAVE
  d1$dataset <- "d_self"
  d1$included <- NA_character_
  for(current_column in 1:length(names(d_self_anonymised))) {
    d1$included[current_column] <- paste0(class(d_self_anonymised[, current_column]),
                                          collapse = ", ")
  }
  
  

  #dataset2:dt_hh
  dt_hh_anonymised$place_12 <- NULL # to be deleted?
  d2 <- as.data.frame(names(dt_hh_anonymised))
  names(d2) <- "variable"
  d2$wave <- WAVE
  d2$dataset <- "dt_hh"
  d2$included <- NA_character_
  for(current_column in 1:length(names(dt_hh_anonymised))) {
    d2$included[current_column] <- paste0(class(dt_hh_anonymised[, current_column]),collapse = ", ")
  }
  

  
  #dataset3:dt_outside_
    # # place_12 = "An einem anderen Ort (bitte angeben)" -> renamed place_oth
  dt_outside_anonymised$place_12 <- NULL
  d3 <- as.data.frame(names(dt_outside_anonymised))
  names(d3) <- "variable"
  d3$wave <- WAVE
  d3$dataset <- "dt_outside"
  d3$included <- NA_character_
  for(current_column in 1:length(names(dt_outside_anonymised))) {
    d3$included[current_column] <- paste0(class(dt_outside_anonymised[, current_column]),collapse = ", ")
  }
  
  aux <- merge(d1, d2, all = TRUE)
  aux <- merge(aux, d3, all = TRUE)
  aux$n_variable <- dim(d1)[1] # to know how many questions/variables in each wave
  
  if(counter == 1) {
    info_long_new <- aux
  } else {
    info_long_new <- merge(info_long_new, aux, all = TRUE)
  }
  rm(d1, d2, d3, aux, d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

info_long_new1 = info_long_new %>% filter(variable=="age_0")#any variable possible
info_long_new <- info_long_new %>% select (-c(n_variable)) # delete n_variable created above
info_wide_new <- spread(info_long_new, wave, included)

####
# info_long_all1 <- merge(info_long_new1,info_long1, all = TRUE)
# ggplot(info_long_all1,aes(wave, n_variable))+
#   geom_point()+
#   ggtitle("Number of variables in each wave (d_self dataset)")+
#   theme(plot.title = element_text(face = "bold",hjust = 0.5))

# write.csv(info_wide_new,paste0(path_covimod,"/info_wave_14-32.csv"))

```

# Merge data and subset to NRW

##wave 1 to 13

```{r Read and merge wave 1 to 13 data, comment="", include=FALSE, results='markup'}
# not the same class across waves:
# contact_id / dt_hh
# contact_id / dt_outside

counter <- 0
for(current_file in DATA) {
  counter <- counter + 1
  load(current_file, .GlobalEnv)
  WAVE <- current_file
  WAVE <- sub(paste0(path_covimod,"/old_questionnaire/complete wave "), "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))  
  
 #dataset1: d_self
  d_self_anonymised$wave <- WAVE
  d_self_anonymised$questionnaire <- "old"

  d_self_anonymised$hh_p_excl_0 <- as.integer(as.character(d_self_anonymised$hh_p_excl_0))
  d_self_anonymised$hh_p_excl_0[which(d_self_anonymised$hh_p_excl_0 > 11)] <- 11 ##hh contact is less likely >11
  d_self_anonymised$contact_id <- as.integer(as.character(d_self_anonymised$contact_id))
  #Q21: hh member name #why it is all 1S
  d_self_anonymised$Q21 <- as.integer(as.character(d_self_anonymised$Q21))# origin is integer
  if(WAVE >= 3) { # new variable in wave 3
    d_self_anonymised$Q74_0 <- as.integer(as.character(d_self_anonymised$Q74_0))
  }
  
  for(current_variable in names(d_self_anonymised)) {
    if(class(d_self_anonymised[, current_variable])[1] %in% c("factor")) { 
      d_self_anonymised[, current_variable] <- as.character(d_self_anonymised[, current_variable])
    }
    if(class(d_self_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      d_self_anonymised[, current_variable] <- as.integer(d_self_anonymised[, current_variable])
    }
  }
  #dataset2:dt_hh
  dt_hh_anonymised$wave <- WAVE
  dt_hh_anonymised$questionnaire <- "old"
  # dt_hh_anonymised$place_12 <- NULL
  
  dt_hh_anonymised$contact_id <- as.double(as.character(dt_hh_anonymised$contact_id))
  for(current_variable in names(dt_hh_anonymised)) {
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_hh_anonymised[, current_variable] <- as.character(dt_hh_anonymised[, current_variable])
    }
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_hh_anonymised[, current_variable] <- as.integer(dt_hh_anonymised[, current_variable])
    }
  }
  
  #dataset3:dt_outside
  dt_outside_anonymised$wave <- WAVE
  dt_outside_anonymised$questionnaire <- "old"
  # dt_outside_anonymised$place_12 <- NULL
  
  dt_outside_anonymised$contact_id <- as.integer(as.character(dt_outside_anonymised$contact_id))
  for(current_variable in names(dt_outside_anonymised)) {
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_outside_anonymised[, current_variable] <- as.character(dt_outside_anonymised[, current_variable])
    }
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_outside_anonymised[, current_variable] <- as.integer(dt_outside_anonymised[, current_variable])
    }
  }  
  
  # rename datasets and combine all waves
  if(counter == 1) { # first wave
    d_self_all <- d_self_anonymised
    dt_hh_all <- dt_hh_anonymised
    dt_outside_all <- dt_outside_anonymised
  } else { # missing columns will be filled with NA
    d_self_all <- bind_rows(d_self_all, d_self_anonymised)
    dt_hh_all <- bind_rows(dt_hh_all, dt_hh_anonymised)
    dt_outside_all <- bind_rows(dt_outside_all, dt_outside_anonymised)
  }
  rm(d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

```

##wave 14 to 28

```{r Read and merge wave 14 to 28 data, comment="", include=FALSE, results='markup'}
#not the same class across waves:
# contact_id / dt_hh
# contact_id / dt_outside

counter <- 0
for(current_file in DATA_new) {
  counter <- counter + 1
  load(current_file, .GlobalEnv)
  WAVE <- current_file
  WAVE <- sub(paste0(path_covimod,"/new_questionnaire/complete wave "), "", WAVE)
  WAVE <- as.integer(sub("_anonymised[.]RData", "", WAVE))  
  
 #dataset1:d_self
  d_self_anonymised$wave <- WAVE
  d_self_anonymised$questionnaire<-"new"
  
  ##class not the same across wave
  for(current_variable in names(d_self_anonymised)) {
    if(class(d_self_anonymised[, current_variable])[1] %in% c("factor")) { 
      d_self_anonymised[, current_variable] <- as.character(d_self_anonymised[, current_variable])
    }
    if(class(d_self_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      d_self_anonymised[, current_variable] <- as.integer(d_self_anonymised[, current_variable])
    }
  }
  
  #dataset2:dt_hh
  dt_hh_anonymised$wave <- WAVE
  dt_hh_anonymised$questionnaire<-"new"
  # dt_hh_anonymised$place_12 <- NULL #why add this variable?
  
  ##class not the same across wave
  dt_hh_anonymised$contact_id <- as.double(as.character(dt_hh_anonymised$contact_id))
  for(current_variable in names(dt_hh_anonymised)) {
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_hh_anonymised[, current_variable] <- as.character(dt_hh_anonymised[, current_variable])
    }
    if(class(dt_hh_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_hh_anonymised[, current_variable] <- as.integer(dt_hh_anonymised[, current_variable])
    }
  }
  
  #dataset3:dt_outside
  dt_outside_anonymised$wave <- WAVE
  dt_outside_anonymised$questionnaire<-"new"
  # dt_outside_anonymised$place_12 <- NULL
  
  ##class not the same across wave
  dt_outside_anonymised$contact_id <- as.integer(as.character(dt_outside_anonymised$contact_id))
  dt_hh_anonymised$contact_id <- as.integer(dt_hh_anonymised$contact_id)#in all data set is numeric, but it does not affect...
  dt_outside_anonymised$contact_id <- as.integer(dt_outside_anonymised$contact_id)
  dt_outside_anonymised$contact <- as.integer(dt_outside_anonymised$contact)
  # why all variables below is NAs?????
  d_self_anonymised$q79a <- as.integer(d_self_anonymised$q79a)
  d_self_anonymised$q79c <- as.integer(d_self_anonymised$q79c)
  d_self_anonymised$Q80a <- as.integer(d_self_anonymised$Q80a)
  d_self_anonymised$Q80c <- as.integer(d_self_anonymised$Q80c)
  d_self_anonymised$Q81a <- as.integer(d_self_anonymised$Q81a)
  d_self_anonymised$Q81c <- as.integer(d_self_anonymised$Q81c)
  d_self_anonymised$Q21_scale <- as.character(d_self_anonymised$Q21_scale)
  
  for(current_variable in names(dt_outside_anonymised)) {
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("factor")) { 
      dt_outside_anonymised[, current_variable] <- as.character(dt_outside_anonymised[, current_variable])
    }
    if(class(dt_outside_anonymised[, current_variable])[1] %in% c("haven_labelled")) { 
      dt_outside_anonymised[, current_variable] <- as.integer(dt_outside_anonymised[, current_variable])
    }
  }  

skin_integer <- c("skin_skin_to_skin","skin_kept_dist_2m" ,"skin_kept_dist_1m", "skin_dist_less_1m", "skin_wore_mask", "skin_washsan_bef" , "skin_washsan_aft", "skin_prefer_not_to_say", "skin_none_of_these", "skin_dont_know")
  
  
  
    d_self_all <- bind_rows(d_self_all, d_self_anonymised)
    dt_hh_all <- bind_rows(dt_hh_all, dt_hh_anonymised)
    dt_outside_all <- bind_rows(dt_outside_all, dt_outside_anonymised)

  rm(d_self_anonymised, dt_hh_anonymised, dt_outside_anonymised)
}

```

##NRW
Variable: bundesland_0 == "Nordrhein-Westfalen"
d_self_all: 

```{r}

d_self_all<- d_self_all%>%filter(bundesland_0 == "Nordrhein-Westfalen")#upto wave 32:12360 obs
dt_outside_all<-  dt_outside_all[dt_outside_all$new_id %in% d_self_all$new_id, ] # subset NRW
dt_outside_all <- dt_outside_all[,c(1,27,2:26,28:42)]# move wave(27) in front for quick visualization
dt_hh_all<- dt_hh_all[dt_hh_all$new_id %in% d_self_all$new_id, ] # subset NRW
dt_hh_all<- dt_hh_all[,c(1,162,2:161,163:215) ] #move wave(162) in front


# obs_wave_upto32 <- 1560+1356+1081+1890+1615+1496+1207+1022+869+739+1499+1500+1500+1490+1500+1499+997+1499+1498+1493+2468+2441+2485+2468+2480+2502+2492+2493+2487+2487+2489+2490 # 32 wave

# https://www.citypopulation.de/en/germany/nordrheinwestfalen/
# https://www.destatis.de/EN/Home/_node.html (origin data)

```

#Cleaning and preparing data
## check dupliacte data
```{r}
#d_self_all
##In each wave, each participant (new_id) should be unique, check if it is true.
for (w in 1:current_wave){
  wave <- d_self_all %>% filter(wave == w)
  if(dim(wave)[1] !=  length(unique(wave$new_id))){
    n = dim(wave)[1] - length(unique(wave$new_id))
    print(paste("Warning:d_self_all: new_id is not unique in wave",w,",with",n,"differences"))
  }
}
#dt_oustdie_all
##In each wave and each participant(new_id), contact_id should be unique, check if it is true.
for (w in 1:current_wave){
  wave <- dt_outside_all %>% filter(wave == w)
  wave$new_id_contact_id <- paste0(wave$new_id,"_",wave$contact_id)
  if(dim(wave)[1] !=  length(unique(wave$new_id_contact_id))){
    n = dim(wave)[1] - length(unique(wave$new_id_contact_id))
    print(paste("Warning: dt_oustdie_all:contact_id is not unique in wave",w," in number of participants" ,",with",n,"differences"))
  }
}

#dt_hh_all
##In each wave and each participant(new_id), contact_id should be unique, check if it is true.
for (w in 1:current_wave){
  wave <- dt_hh_all %>% filter(wave == w)
  wave$new_id_contact_id <- paste0(wave$new_id,"_",wave$contact_id)
  if(dim(wave)[1] !=  length(unique(wave$new_id_contact_id))){
    n = dim(wave)[1] - length(unique(wave$new_id_contact_id))
    print(paste("Warning: dt_hh_all:contact_id is not unique in wave",w," in number of participants" ,",with",n,"differences"))
  }
}


```

## no contact place?

Check contacts without any contact place specified. If any, what possible reason?

hh_contacts: 4043/16943 = 23.86%
outside_contacts: 117/17506 = 1.01% ( 113/117 answered inside/outside, 4/117: completely no information)


```{r}

dt_outside_place <- dt_outside_all%>% select(new_id,wave, contains("place"))
dt_hh_place <- dt_hh_all%>% select(new_id,wave, contains("place"))
# convert place_oth into the same format "Yes", "No"
dt_hh_place$place_oth[which(dt_hh_place$place_oth== 1)] <- "Yes"
dt_outside_place$place_oth[which(dt_outside_place$place_oth== 1)] <- "Yes"

#hh contact
dt_hh_place <- dt_hh_place %>% dplyr::mutate(place_yes = rowSums(select(.,place_home_own:place_oth) == "Yes", na.rm=TRUE))
table(dt_hh_place$place_yes)
table(dt_hh_place$place_yes)[1]/sum(table(dt_hh_place$place_yes))
#futher check if inside/outside contact was answer
dt_hh_place <- dt_hh_place %>% dplyr::mutate(place_yes = rowSums(select(.,place_home_own:place_outside) == "Yes", na.rm=TRUE))
table(dt_hh_place$place_yes)

#outside_contact
dt_outside_place <- dt_outside_place %>% dplyr::mutate(place_yes = rowSums(select(.,place_home_own:place_oth) == "Yes", na.rm=TRUE)) #
table(dt_outside_place$place_yes)
table(dt_outside_place$place_yes)[1]/sum(table(dt_outside_place$place_yes))

#futher check if inside/outside contact was answer
dt_outside_place <- dt_outside_place %>% dplyr::mutate(place_yes = rowSums(select(.,place_home_own:place_outside) == "Yes", na.rm=TRUE)) #
table(dt_outside_place$place_yes)

```

## Group contacts

Q75: Wave 3-13

Q79: Wave 14- onward

The codes below to integrate group contact information across waves into Q.75 style. 

The group contact info mainly retrieved from Q75.However, if Q76 > Q75 -> use Q76 

From wave 14 onward, group contact question ( Q79-Q81) is formulated as a matrix table ( location X age group)


The missing answer in this question is very high (>85%). The possible reason is the respondent answered the individual contact question and don't care much about this question anymore.

*The missing mean not giving answer in that category ? 0 means no contact in that category

```{r results="asis"}
# names wave 3-13   new names wave 14 onwards
# Q75_u18_work	    Q79_age_met_work_u18
# Q75_1864_work	    Q79_age_met_work_1864
# Q75_o64_work	    Q79_age_met_work_o64
# Q75_u18_school  	Q80a_age_met_uni_u18
# Q75_1864_school 	Q80a_age_met_uni_1864
# Q75_o64_school  	Q80a_age_met_uni_o64
# Q75_u18_else	    Q81a_age_met_else_u18
# Q75_1864_else	    Q81a_age_met_else_1864
# Q75_o64_else    	Q81a_age_met_else_o64
# Q76_u18_work    	Q79c_age_phys_work_u18
# Q76_1864_work   	Q79c_age_phys_work_1864
# Q76_o64_work    	Q79c_age_phys_work_o64
# Q76_u18_school  	Q80c_age_phys_uni_u18
# Q76_1864_school 	Q80c_age_phys_uni_1864
# Q76_o64_school  	Q80c_age_phys_uni_o64
# Q76_u18_else	    Q81c_age_phys_else_u18
# Q76_1864_else	    Q81c_age_phys_else_1864
# Q76_o64_else	    Q81c_age_phys_else_o64


d_self_all <- d_self_all %>% mutate (Q75_u18_work = ifelse(questionnaire=="new", Q79a_age_met_work_u18, Q75_u18_work))
d_self_all <- d_self_all %>% mutate (Q75_1864_work = ifelse(questionnaire=="new", Q79a_age_met_work_1864, Q75_1864_work))
d_self_all <- d_self_all %>% mutate (Q75_1864_work = ifelse(questionnaire=="new", Q79a_age_met_work_o64, Q75_o64_work))
d_self_all <- d_self_all %>% mutate (Q75_u18_school = ifelse(questionnaire=="new", Q80a_age_met_uni_u18, Q75_u18_school))
d_self_all <- d_self_all %>% mutate (Q75_1864_school = ifelse(questionnaire=="new", Q80a_age_met_uni_1864, Q75_1864_school))
d_self_all <- d_self_all %>% mutate (Q75_o64_school = ifelse(questionnaire=="new", Q80a_age_met_uni_o64, Q75_o64_school))
d_self_all <- d_self_all %>% mutate (Q75_u18_else = ifelse(questionnaire=="new", Q81a_age_met_else_u18, Q75_u18_else))
d_self_all <- d_self_all %>% mutate (Q75_1864_else = ifelse(questionnaire=="new", Q81a_age_met_else_1864, Q75_1864_else))
d_self_all <- d_self_all %>% mutate (Q75_o64_else = ifelse(questionnaire=="new", Q81a_age_met_else_o64, Q75_o64_else))
d_self_all <- d_self_all %>% mutate (Q76_u18_work = ifelse(questionnaire=="new", Q79c_age_phys_work_u18, Q76_u18_work))
d_self_all <- d_self_all %>% mutate (Q76_1864_work = ifelse(questionnaire=="new", Q79c_age_phys_work_1864, Q76_1864_work))
d_self_all <- d_self_all %>% mutate (Q76_o64_work = ifelse(questionnaire=="new", Q79c_age_phys_work_o64, Q76_o64_work))
d_self_all <- d_self_all %>% mutate (Q76_u18_school = ifelse(questionnaire=="new", Q80c_age_phys_uni_u18, Q76_u18_school))
d_self_all <- d_self_all %>% mutate (Q76_1864_school = ifelse(questionnaire=="new", Q80c_age_phys_uni_1864, Q76_1864_school))
d_self_all <- d_self_all %>% mutate (Q76_o64_school = ifelse(questionnaire=="new", Q80c_age_phys_uni_o64, Q76_o64_school))
d_self_all <- d_self_all %>% mutate (Q76_u18_else = ifelse(questionnaire=="new", Q81c_age_phys_else_u18, Q76_u18_else))
d_self_all <- d_self_all %>% mutate (Q76_1864_else = ifelse(questionnaire=="new", Q81c_age_phys_else_1864, Q76_1864_else))
d_self_all <- d_self_all %>% mutate (Q76_o64_else = ifelse(questionnaire=="new", Q81c_age_phys_else_o64, Q76_o64_else))

# sumary table 
table1(~Q75_u18_work + Q75_1864_work + Q75_1864_work +
       Q75_u18_school + Q75_1864_school+ Q75_o64_school + Q75_u18_else +Q75_1864_else +Q75_o64_else | as.factor(wave), data=d_self_all)
  
```

## Remove work contacts from <15 year olds
The respondent < 15 year-old should not have work contact. Therefore, the work contact with those individuals (if any) should set to 0.

##

```{r results="asis"}


#Set the work contacts of the < 15 year olds to 0
dummy <- d_self_all %>% select(new_id, wave, age_group)
colnames(dummy) <- c("new_id", "wave","age_group_participant")
dummy <- merge(dummy, dt_outside_all, by=c("new_id", "wave"), all.y  =T) 

dummy$place_work[(dummy$age_group_participant=="Under 1" | 
                    dummy$age_group_participant=="1-4" |
                    dummy$age_group_participant=="5-9" | 
                    dummy$age_group_participant=="10-14") & 
                    dummy$place_work==1 ] <- 0

dt_outside_all <- dummy %>% select(-c(age_group_participant))# is neccesary to remove?

rm(dummy)

```

## Count multiple contact

place_.. variable is not consistent in format:

- most of variables are labeled ["Yes","No","NA], but **place_oth** contain[ NA, "1"].
=> should we replace place_oth by place_12 ? 

But, in the non_hh_contact_number function, the variable used is place_oth and the format used is correct. So this shouldn't be a problem!

**place_multiple**: 1 = 'Yes', 0 = 'No


```{r }

# hh data
dt_hh_all <- dt_hh_all %>% dplyr::mutate(place_multiple = rowSums(select(.,place_home_own:place_oth) == "Yes", na.rm=TRUE))

table(dt_hh_all$place_multiple)

#this code convert...to binary value: 0 (No), 1(Yes)
#Veronika's version is integer
dt_hh_all$place_multiple <- as.factor(as.integer(dt_hh_all$place_multiple >= 2))# if place_multiple >- 2 -> assign to 1 ( Yes), otherwise 0 (No)

table(dt_hh_all$place_multiple)

# non_hh data
dt_outside_all <- dt_outside_all %>% dplyr::mutate(place_multiple = rowSums(select(.,place_home_own:place_oth) == "Yes", na.rm=TRUE))

table(dt_outside_all$place_multiple)

dt_outside_all$place_multiple <- as.factor(as.integer(dt_outside_all$place_multiple >= 2))

table(dt_outside_all$place_multiple)

```

## Contact duration
```{r}
#################################################################################################
#################################################################################################
#  Contact durationin non-hh contacts for bar chart
#first categorise
dt_outside_all$contact_duration_minutes <- dt_outside_all$time_hh * 60 + dt_outside_all$time_mm
dt_outside_all$contact_duration_minutes[which(dt_outside_all$contact_duration_minutes > 24 * 60)] <- 24 * 60
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes<5]<-"<5"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>4 & dt_outside_all$contact_duration_minutes<15]<-">=5 & <15"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>14 & dt_outside_all$contact_duration_minutes<60]<-">=15 & <60"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>59 & dt_outside_all$contact_duration_minutes<240]<-">=60 & <240"
dt_outside_all$contact_duration_minutes_cat[dt_outside_all$contact_duration_minutes>239]<-">=240"

dt_outside_all$contact_duration_minutes_cat <- as.character(dt_outside_all$contact_duration_minutes_cat, levels = c('<5','>=5 & <15','>=15 & <60','>=60 & <240','>=240'))


# # from wave 14 onwards contact duration is recorded as Less than 5 minutes, etc. Need to take the values of the variable ""
##Phuong: the current dt_outside_all has been in the right format, so I switch these codes off.

# dt_outside_all$con_time[dt_outside_all$con_time=="Less than 5 minutes"] <- "<5"
# dt_outside_all$con_time[dt_outside_all$con_time==" Less than 5 minutes"] <- "<5"
# dt_hh_all$con_time[dt_hh_all$con_time=="Less than 5 minutes"] <- "<5"
# dt_hh_all$con_time[dt_hh_all$con_time==" Less than 5 minutes"] <- "<5"
# dt_outside_all$con_time[dt_outside_all$con_time=="5 minutes or more, but less than 15 minutes"] <- ">=5 & <15"
# dt_hh_all$con_time[dt_hh_all$con_time=="5 minutes or more, but less than 15 minutes"] <- ">=5 & <15"
# dt_outside_all$con_time[dt_outside_all$con_time=="15 minutes or more, but less than 1 hour"] <- ">=15 & <60"
# dt_hh_all$con_time[dt_hh_all$con_time=="15 minutes or more, but less than 1 hour"] <- ">=15 & <60"
# dt_outside_all$con_time[dt_outside_all$con_time=="1 hour or more, but less than 4 hours"] <- ">=60 & <240"
# dt_hh_all$con_time[dt_hh_all$con_time=="1 hour or more, but less than 4 hours"] <- ">=60 & <240"
# dt_outside_all$con_time[dt_outside_all$con_time=="4 hours or more"] <- ">=240"
# dt_hh_all$con_time[dt_hh_all$con_time=="4 hours or more"] <- ">=240"
# dt_outside_all$con_time[dt_outside_all$con_time=="Don’t know"] <- NA
# dt_hh_all$con_time[dt_hh_all$con_time=="Don’t know"] <- NA


#merge contact_duration_mininutes (before wave 13) and con_time (wave 14 onward)
dt_outside_all <- dt_outside_all %>% mutate (contact_duration_minutes_cat = case_when(questionnaire=="new" ~ con_time, TRUE ~ contact_duration_minutes_cat))



#Phuong: will double check codes below if necessary to keep or not! 

# dummy_0_4 <- dt_outside_all %>% 
#   filter(contact_duration_minutes_cat=="<5") %>% 
#   group_by(new_id, wave) %>% 
#   dplyr::summarise(non_hh_duration_0_4_contact_n=n())
# 
# dummy_5_14 <- dt_outside_all %>% 
#   filter(contact_duration_minutes_cat==">=5 & <15") %>% 
#   group_by(new_id, wave) %>% 
#   dplyr::summarise(non_hh_duration_5_14_contact_n=n())
# 
# dummy_15_59 <- dt_outside_all %>% 
#   filter(contact_duration_minutes_cat==">=15 & <60") %>% 
#   group_by(new_id, wave) %>% 
#   dplyr::summarise(non_hh_duration_15_59_contact_n=n())
# 
# dummy_60_239 <- dt_outside_all %>% 
#   filter(contact_duration_minutes_cat==">=60 & <240") %>% 
#   group_by(new_id, wave) %>% 
#   dplyr::summarise(non_hh_duration_60_239_contact_n=n())
# 
# dummy_240 <- dt_outside_all %>% 
#   filter(contact_duration_minutes_cat==">=240") %>% 
#   group_by(new_id, wave) %>% 
#   dplyr::summarise(non_hh_duration_240_contact_n=n())
# 
# 
# # merge with d_all_wide
# d_all_wide <- merge(d_all_wide, dummy_0_4, by=c("new_id", "wave"), all.x=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dummy_5_14, by=c("new_id", "wave"), all.x=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dummy_15_59, by=c("new_id", "wave"), all.x=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dummy_60_239, by=c("new_id", "wave"), all.x=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# d_all_wide <- merge(d_all_wide, dummy_240, by=c("new_id", "wave"), all.x=T)
# if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
# 
# 
# # any NA in _contact_n means zero contacts in that setting
# for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
#   d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
# }
# 
# rm(dummy_0_4, dummy_5_14, dummy_15_59, dummy_60_239, dummy_240)
# #################################################################################################
# #################################################################################################



```


#  Calculate contacts per ID and wave
This work create the "d_all_wide" data set


**These variables below are non_hh_contact**

place_home_own                       -> **home_own_contact_n**

place_home_else                      -> **home_else_contact_n**

place_work-> simmilar pattern

place_worship

place_transport

place_school

place_shop_essential

place_shop_non_essential

place_entertainment (e.g. restaurant, bar/pub, cinema)

place_sport

place_park

place_healthcare

place_beauty

place_oth 

**not_specified_contact_n** : the respondent did not chose any place above, except place_oth (i.e.the respondent ["27e7cde0"
, wave 23] report 15 contacts, 1 is place_oth_n => not_specified_contact_n is 14 ) # 

**leisure_contact_n** : contact at either home_own|home_else|worship|shop_non_essential|entertainment|sport|park|beauty

**other_combined_contact_n** ( the rest places) includes transport|healthcare|shop_essential|place_oth

**all_contact_n** includes hh_contacts_n and non_hh_contact_n

**all_contact_n_inside** includes hh_contacts_n_inside and non_hh_contact_n inside

**all_contact_n_outside** includes hh_contacts_n_outside and non_hh_contact_n outside

*work and school are not grouped into these variables

- It is possible that a respondent meet the same person at different places (i.e: meet at bar, and then go home together [ wave 6, 004eff99: non_hh_contact_n is 2 ,but has 1 home_own_contact_n
 and 2 entertainment_contact_n
])

A repeated respondent may report different Bundesland in different waves.

* Contact calculation at a specific place ~ count 'Yes' answer. Meaning that contact_place with 'NA' will be treated as 'No'.



```{r }


# All contacts (inside and outside)
## Function used here can be found in function chunk
hh_contacts <- hh_contact_number(dt_hh_all, new_id, wave)
outside_contacts <- non_hh_contact_number(dt_outside_all, new_id, wave)
nrow(d_self_all)
nrow(hh_contacts)      # must be <= nrow(d_self_all)
nrow(outside_contacts) # must be <= nrow(d_self_all)

#create new_id_wave contain new_id and wave information. This should be unique in d_self_all, hh_contacts , and  outside_contacts data set.All new_id_wave in hh_contacts and  outside_contacts should be in d_self_all. Check if this true!
hh_contacts$new_id_wave <- paste0(hh_contacts$new_id,"_",hh_contacts$wave)
outside_contacts$new_id_wave <- paste0(outside_contacts$new_id,"_",outside_contacts$wave)
d_self_all$new_id_wave <- paste0(d_self_all$new_id,"_",d_self_all$wave)
#checking
a <- summary(hh_contacts$new_id_wave %in% d_self_all$new_id_wave)
if (a[[3]] != dim(hh_contacts)[1]){
  print("Warning:some unique id (new_id & wave) in hh_contact may not be in d_sell_all")
}
b <- summary(outside_contacts$new_id_wave %in% d_self_all$new_id_wave)
if (a[[3]] != dim(outside_contacts)[1]){
  print("Warning:some unique id (new_id & wave) in outside_contacts may not be in d_sell_all")
}
rm(a,b)

# # subset to see what make the difference (if any)
# ##switch on when further investigation needed
# hh_contacts_diff <- hh_contacts[which(hh_contacts$new_id_wave %in% d_self_all$new_id_wave==FALSE),]
# outside_contacts_diff <- outside_contacts[which(outside_contacts$new_id_wave %in% d_self_all$new_id_wave==FALSE),]
# a <- d_self_all%>% filter (new_id == "71c9e526")
# a1 <- hh_contacts%>% filter (new_id == "71c9e526")
# ##the higher observations in hh_contacts than in d_self_all (NRW) suggest that a repeated respondent may report different Bundesland in different waves.


#integrate dataset

d_all_wide <- merge(d_self_all, hh_contacts, by=c("new_id", "wave"), all.x =T) 
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, outside_contacts, by=c("new_id", "wave"), all.x=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }


# Inside contacts
aux_hh <- dt_hh_all %>% filter(place_inside=="Yes") #1 = Yes, 0=No
hh_contacts <- hh_contact_number(aux_hh, new_id, wave)

aux_outside <- dt_outside_all %>% filter(place_inside=="No")
outside_contacts <- non_hh_contact_number(aux_outside, new_id, wave)

nrow(d_self_all)
nrow(hh_contacts)      # must be <= nrow(d_self_all)
nrow(outside_contacts) # must be <= nrow(d_self_all)

# rename
names(hh_contacts) <- sub("_contact_n", "_contact_n_inside", names(hh_contacts))
names(outside_contacts) <- sub("_contact_n", "_contact_n_inside", names(outside_contacts))

d_all_wide <- merge(d_all_wide, hh_contacts, by=c("new_id", "wave"), all.x=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }
d_all_wide <- merge(d_all_wide, outside_contacts, by=c("new_id", "wave"), all.x=T)
if(nrow(d_all_wide) != nrow(d_self_all)) { message("More rows than expected!") }

names(d_all_wide)


# Outside contacts
aux_hh <- dt_hh_all %>% filter(place_outside=="Yes")#1 = Yes, 0=No
hh_contacts <- hh_contact_number(aux_hh, new_id, wave)

aux_outside <- dt_outside_all %>% filter(place_outside=="NO")
outside_contacts <- non_hh_contact_number(aux_outside, new_id, wave)

nrow(d_self_all)
nrow(hh_contacts)      # must be <= nrow(d_self_all)
nrow(outside_contacts) # must be <= nrow(d_self_all)

# rename
names(hh_contacts) <- sub("_contact_n", "_contact_n_outside", names(hh_contacts))
names(outside_contacts) <- sub("_contact_n", "_contact_n_outside", names(outside_contacts))

d_all_wide <- merge(d_all_wide, hh_contacts, by=c("new_id", "wave"), all.x=T)
if(nrow(d_all_wide) < nrow(d_self_all)) { message("Less rows than expected!") }
d_all_wide <- merge(d_all_wide, outside_contacts, by=c("new_id", "wave"), all.x=T)
if(nrow(d_all_wide) < nrow(d_self_all)) { message("Less rows than expected!") }

# any NA in _contact_n means zero contacts in that setting
for(current_variable in names(d_all_wide)[grep("contact_n", names(d_all_wide))]) {
  d_all_wide[is.na(d_all_wide[, current_variable]), current_variable] <- 0
}


# all contacts
d_all_wide$all_contact_n <- 
  d_all_wide$hh_contact_n + d_all_wide$non_hh_contact_n

d_all_wide$all_contact_n_inside <- 
  d_all_wide$hh_contact_n_inside + d_all_wide$non_hh_contact_n_inside

d_all_wide$all_contact_n_outside <- 
  d_all_wide$hh_contact_n_outside + d_all_wide$non_hh_contact_n_outside


```

#Cleaning d_all_wide data set
##create weekday
The contact is recorded one day before report day. so, the weekday of contact is counted from Tuesday to Saturday next week, and weekend is Sunday and Monday next week.

Notes: consider create this in d_self_all dataset instead of here 

```{r }
d_all_wide$date <- ymd(paste0(d_all_wide$date_YYYY_0, "/", d_all_wide$date_MM_0, "/", d_all_wide$date_DD_0))
d_all_wide$weekday <- lubridate::wday(d_all_wide$date, week_start = 7) # week starts on Sunday
d_all_wide$weekday <- factor(d_all_wide$weekday, labels = c("Sun", "Mon", "Tue", "Wed","Thu", "Fri", "Sat"))
d_all_wide$weekday <- factor(d_all_wide$weekday, levels = c("Mon", "Tue", "Wed","Thu", "Fri", "Sat", "Sun"))

 # table(d_all_wide$date, d_all_wide$weekday)

#weekday for which contacts recorded, i.e. weekday - 1
 d_all_wide$weekday_2[d_all_wide$weekday=="Mon"] <- "Sun"
 d_all_wide$weekday_2[d_all_wide$weekday=="Tue"] <- "Mon"
 d_all_wide$weekday_2[d_all_wide$weekday=="Wed"] <- "Tue"
 d_all_wide$weekday_2[d_all_wide$weekday=="Thu"] <- "Wed"
 d_all_wide$weekday_2[d_all_wide$weekday=="Fri"] <- "Thu"
 d_all_wide$weekday_2[d_all_wide$weekday=="Sat"] <- "Fri"
 d_all_wide$weekday_2[d_all_wide$weekday=="Sun"] <- "Sat"
 d_all_wide$weekday_2 <- factor(d_all_wide$weekday_2, levels=c("Mon","Tue","Wed","Thu", "Fri", "Sat", "Sun"))
 d_all_wide$weekend_weekday[d_all_wide$weekday_2=="Mon" | d_all_wide$weekday_2=="Tue" |  d_all_wide$weekday_2=="Wed" |  d_all_wide$weekday_2=="Thu" | d_all_wide$weekday_2=="Fri"] <- "weekday"
 d_all_wide$weekend_weekday[d_all_wide$weekday_2=="Sat" | d_all_wide$weekday_2=="Sun"] <- "weekend"

 table(d_all_wide$date, d_all_wide$weekend_weekday)

 
```

## add Q75/76 and truncation
 
Q.75 How many people have you had contact with whom you did not specify individually? Please, provide an estimated value as precisely as possible, including age and environment. For the purpose of this question, we are only interested in people with whom there was direct contact and with whom you have exchanged at least a few words OR with whom you have had physical contact (e.g. shaking hands, hugging, contact sports). Please, indicate the number of contacts for each age group and each environment. 

Q.76 Roughly how many people did you have phyiscal contact (body contact) with that you did not specify individually? Please, provide an estimated value as precisely as possible, including age and environment. For the purpose of this question, we are only interested in people who have had direct contact AND with whom you have had physical contact (e.g. shaking hands, hugging, contact sports). Please, indicate the number of contacts for each age group and each environment.

????
The group contact info mainly retrieved from Q75.However, if Q76 > Q75 -> use Q76 

From wave 14 onward, group contact question ( Q79-Q81) is formulated as a matrix table ( location X age group)

The truncate is for a group place (school, work, else) as a whole ( not at age group level)

```{r Add Q75 / Q76 contacts AND truncate Q contacts}
# Please check each category individually. I.e. compare Q75_u18_work with Q76_u18_work and replace if necessary and that just for each category. That's how I did it so far and Victoria took over from me.


# Please indicate the number of contacts for each age group and setting.
# ROWS
# Under 18 years 
# 18 to 64 years
# 65 years and older
# COLUMNS.
# Am Arbeitsplatz -> add to work_contact_n (no info about inside/outside!)
v <- which(d_all_wide$Q76_u18_work > d_all_wide$Q75_u18_work)#index rows that ...bigger, how about smaller => should we use !=????
d_all_wide$Q75_u18_work[v] <- d_all_wide$Q76_u18_work[v]

v <- which(d_all_wide$Q76_1864_work > d_all_wide$Q75_1864_work)
d_all_wide$Q75_1864_work[v] <- d_all_wide$Q76_1864_work[v]

v <- which(d_all_wide$Q76_o64_work > d_all_wide$Q75_o64_work)
d_all_wide$Q75_o64_work[v] <- d_all_wide$Q76_o64_work[v]

#work contact

d_all_wide$Q75_work_sum <- rowSums(d_all_wide[, c("Q75_u18_work",
                                                  "Q75_1864_work",
                                                  "Q75_o64_work")],
                                   na.rm = TRUE)


## < 15 yrs old -> no work contact
d_all_wide$Q75_work_sum[d_all_wide$age_group=="Under 1" | 
                          d_all_wide$age_group=="1-4" |
                          d_all_wide$age_group=="5-9" |
                          d_all_wide$age_group=="10-14"] <- 0


##truncate at "truncate" before adding to work contacts
d_all_wide$Q75_work_sum[d_all_wide$Q75_work_sum > truncate] <- truncate

## add the work Q contacts to the overall work contacts
d_all_wide$work_contact_n_Q75 <- d_all_wide$work_contact_n + d_all_wide$Q75_work_sum



# In der Schule oder einer anderen Lehranstalt -> add to school_contact_n
v <- which(d_all_wide$Q76_u18_school > d_all_wide$Q75_u18_school)
d_all_wide$Q75_u18_school[v] <- d_all_wide$Q76_u18_school[v]

v <- which(d_all_wide$Q76_1864_school > d_all_wide$Q75_1864_school)
d_all_wide$Q75_1864_school[v] <- d_all_wide$Q76_1864_school[v]

v <- which(d_all_wide$Q76_o64_school > d_all_wide$Q75_o64_school)
d_all_wide$Q75_o64_school[v] <- d_all_wide$Q76_o64_school[v]

d_all_wide$Q75_school_sum <- rowSums(d_all_wide[, c("Q75_u18_school",
                                                    "Q75_1864_school",
                                                    "Q75_o64_school")],
                                     na.rm = TRUE)

## truncate at "truncate" before adding to school contacts
d_all_wide$Q75_school_sum[d_all_wide$Q75_school_sum>truncate] <- truncate

## add the Q school contacts to the other school contacts
d_all_wide$school_contact_n_Q75 <- d_all_wide$school_contact_n + d_all_wide$Q75_school_sum





# Anderswo -> add to not_specified_contact_n
v <- which(d_all_wide$Q76_u18_else > d_all_wide$Q75_u18_else)
d_all_wide$Q75_u18_else[v] <- d_all_wide$Q76_u18_else[v]

v <- which(d_all_wide$Q76_1864_else > d_all_wide$Q75_1864_else)
d_all_wide$Q75_1864_else[v] <- d_all_wide$Q76_1864_else[v]

v <- which(d_all_wide$Q76_o64_else > d_all_wide$Q75_o64_else)
d_all_wide$Q75_o64_else[v] <- d_all_wide$Q76_o64_else[v]

d_all_wide$Q75_else_sum <- rowSums(d_all_wide[, c("Q75_u18_else",
                                                  "Q75_1864_else",
                                                  "Q75_o64_else")],
                                   na.rm = TRUE)

##add the Q75 work contacts from the below 15 year olds

d_all_wide$dummy_Q75_work_youngage<- 0

d_all_wide$dummy_Q75_work_youngage[d_all_wide$age_group=="Under 1" |
                                     d_all_wide$age_group=="1-4" |
                                     d_all_wide$age_group=="5-9" |
                                     d_all_wide$age_group=="10-14"] <-
d_all_wide$Q75_work_sum[d_all_wide$age_group=="Under 1" |
                            d_all_wide$age_group=="1-4" |
                            d_all_wide$age_group=="5-9" |
                            d_all_wide$age_group=="10-14"]

d_all_wide$Q75_else_sum <-d_all_wide$Q75_else_sum + d_all_wide$dummy_Q75_work_youngage


## truncate at "truncate" before adding to not specified contacts
d_all_wide$Q75_else_sum[d_all_wide$Q75_else_sum>truncate] <- truncate

#add the Q "else" contacts to the not specified contacts
d_all_wide$not_specified_contact_n_Q75 <- d_all_wide$not_specified_contact_n + d_all_wide$Q75_else_sum


```

##add Q75/76 to non-hh
In question Q75/76, do we know the contact is inside or outside

```{r Add Q75 / Q76 contacts to non-hh contacts}

#  add to all non_hh_contact_n
d_all_wide$non_hh_contact_n <- d_all_wide$non_hh_contact_n + 
  d_all_wide$Q75_work_sum + 
  d_all_wide$Q75_school_sum + 
  d_all_wide$Q75_else_sum


#  add to all work_contact_n
d_all_wide$work_contact_n <- d_all_wide$ work_contact_n +
  d_all_wide$Q75_work_sum
  

#  add to all school_contact_n
d_all_wide$school_contact_n <- d_all_wide$school_contact_n +
  d_all_wide$Q75_school_sum


#  add to all not_specified_contact_n
d_all_wide$not_specified_contact_n <- d_all_wide$not_specified_contact_n + 
  d_all_wide$Q75_else_sum

#  add to all_
d_all_wide$all_contact_n <- d_all_wide$all_contact_n + 
  d_all_wide$Q75_work_sum + 
  d_all_wide$Q75_school_sum + 
  d_all_wide$Q75_else_sum


```


## labelling

```{r Some data checks and labelling}

d_all_wide$wave <- as.factor(d_all_wide$wave)
levels(d_all_wide$wave) <- wave_label[as.integer(levels(d_all_wide$wave))] # label wave with dates,etc

d_all_wide$wave_date <- d_all_wide$wave_0
d_all_wide$wave_date <- as.factor(d_all_wide$wave_date)
levels(d_all_wide$wave_date) <- wave_date[as.integer(levels(d_all_wide$wave_date))] # wave with start date
d_all_wide$wave_date <- as.Date(d_all_wide$wave_date, format = "%d.%m.%Y")

summary(d_all_wide$age_0)
# age_0 is never below 18 because it is only known for the respondent
# if age is needed, then use age_group!

d_all_wide <- subset(d_all_wide, !is.na(new_id))

# sum of place_ contacts (incl. oth_contact_n) must not be greater than non_hh_contact_n
# CAVE: multiple sites
d_all_wide$sum_place_contact_n <- rowSums(d_all_wide[, c(CONTACT_N,
                                                       "not_specified_contact_n")])
table(d_all_wide$non_hh_contact_n - d_all_wide$sum_place_contact_n,# no negative value 
      d_all_wide$multiple_contact_n,
      useNA = "ifany")



```


# Summary tables
## Number of participants per wave
All participants  included regardless of number of waves contributed

```{r descriptive_table}

   
min_number_waves=1 # a minimum number of waves a participant join 
#If min_number_waves=1, df is exactly d_all_wide dataset
df <- get_contacts(d_all_wide,waves=c(1:current_wave),min.waves=min_number_waves) # 

# my.render.cat <- function(x) {
#   c("", sapply(stats.default(x), function(y) with(y,
#                                                   sprintf("%d (%0.0f%%)", FREQ, PCTnoNA))))
# }

#table1::table1(~ weekend_weekday + sex2 + age_group_2 + hh_p_incl_0_2| wave, data=df,  render.categorical=my.render.cat,overall=F)


number_part <- df %>% group_by(wave) %>% dplyr::summarise(wave_n=n())
df$wave_0 <- as.numeric(df$wave)

number_of_participants <- ggplot(df, aes(x=wave_0))+
      geom_histogram(binwidth=1, fill="grey", colour="black")+
  ggtitle(" Number of participants in each wave in NRW")+
theme(panel.background = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.line = element_line(colour = "black"), plot.title = element_text(face="bold", size=16, colour = "black"), axis.title = element_text(size=16, face="bold", colour = "black"), axis.text.x = element_text(size = 15, colour = "black", angle = 90, vjust=0.5),  axis.text.y = element_text(size = 15, colour = "black")) + 
  scale_x_continuous(breaks = seq(1, current_wave, 2))
number_of_participants

#Warning: Removed 535 rows containing non-finite values (stat_bin)

# auto save
participants <- paste0(path_figures, "/number_of_participants", ".png")
ggsave(participants, width=10, height=7)


```


## Repeated participants

```{r,results="asis"}

df_dummy <- df %>% group_by(new_id) %>% dplyr::summarise(wave_n=n()) ## add dplyr::, no longer error
df_dummy$num_wave_included<-min_number_waves
df_dummy$wave_n_factor <- as.factor(df_dummy$wave_n)
df_dummy$wave_n_cat <- as.factor(ifelse(df_dummy$wave_n < 2, '1',
                     ifelse(df_dummy$wave_n < 5, '2-4', 
                     ifelse(df_dummy$wave_n < 10, '5-9', 
                     ifelse(df_dummy$wave_n < 15, '10-14', 
                     ifelse(df_dummy$wave_n < 20, '15-19', 
                     ifelse(df_dummy$wave_n < 25, '20-24', 
                            '>=25')))))))
df_dummy$wave_n_cat <- factor(df_dummy$wave_n_cat, levels=c("1", "2-4", "5-9", "10-14", "15-19", "20-24",">=25"))

# lable table
# table1::lable(df_dummy$num_wave_included) <- "wanted name"
table1::table1(~num_wave_included + wave_n + wave_n_factor + wave_n_cat, data=df_dummy)

```

## Age group
```{r results="asis"}
df$age_group[which(df$age_group == "Under 1")] <- "<1"
# age groups
# from wave 14 onwards a category exists 85 years or older => put into 85+
df$age_group[df$age_group=="85 years or older"] <- "85+"
table1::table1(~age_group| wave, data=df)


#groups <- sort(unique(df$age_group))
#groups <- setdiff(groups,c("Don’t know","Prefer not to answer","<1"))
df$age_group_2[df$age_group=="Under 1" | df$age_group=="1-4" | df$age_group=="5-9"| df$age_group=="10-14" | df$age_group=="15-19"] <- "0-19"

df$age_group_2[df$age_group=="20-24" | df$age_group=="25-34" ] <- "20-34"
df$age_group_2[df$age_group=="35-44" | df$age_group=="45-54"] <- "35-54"
df$age_group_2[ df$age_group=="55-64" ] <- "55-64"
df$age_group_2[ df$age_group=="65-69"] <- "65-69"
df$age_group_2[ df$age_group=="70-74" | df$age_group=="75-79" | df$age_group=="80-84" | df$age_group=="85+"] <- "70+"

table1::table1(~age_group_2| wave, data=df)


```

## Sex

```{r results="asis"}

#sex2
# only keep Female and  Male , the rest ( i.e : "In another way", "Prefer not to answer") become NA
df$sex2 [df$sex=="Female"] <- "Female"
df$sex2[df$sex=="Male"] <- "Male"


# table1::table1(~ sex | as.factor(wave), data=df)
table1::table1(~ sex2 | as.factor(wave), data=df)


```

## hh size 

```{r results="asis"}

#####CAVE, CAVE, CAVE - there is still an issue with wave 14. hh_p_incl_0 ranges from 0 to 11 instead of 1 to 12. Email to Sara send.
# household size
#wave 14 onwards already has variable hh_p_incl_0 => must add 1 to hh_p_excl_0 from waves 1 to 13
df <- df %>% mutate(hh_p_incl_0 = ifelse(questionnaire=="old", (hh_p_excl_0+1), hh_p_incl_0))
df <- df %>% mutate(hh_p_incl_0 = ifelse(wave_0 == 14, (hh_p_incl_0+1), hh_p_incl_0))

#hh size
table1::table1(~hh_p_incl_0 + as.factor(hh_p_incl_0) | as.factor(wave), data=df)

df$hh_p_incl_0_2[df$hh_p_incl_0=="1"] <- "1"
df$hh_p_incl_0_2[df$hh_p_incl_0>1 & df$hh_p_incl_0<5] <- "2-4"
df$hh_p_incl_0_2[df$hh_p_incl_0>4 & df$hh_p_incl_0<10] <- "5-9"
df$hh_p_incl_0_2[df$hh_p_incl_0>9] <- "10+"
df$hh_p_incl_0_2 <- factor(df$hh_p_incl_0_2, levels=c("1","2-4","5-9","10+"))

df$hh_p_incl_0_3[df$hh_p_incl_0=="1"] <- "1"
df$hh_p_incl_0_3[df$hh_p_incl_0==2] <- "2"
df$hh_p_incl_0_3[df$hh_p_incl_0>2 & df$hh_p_incl_0<6] <- "3-5"
df$hh_p_incl_0_3[df$hh_p_incl_0>5] <- "6+"
df$hh_p_incl_0_3 <- factor(df$hh_p_incl_0_3, levels=c("6+","3-5","2","1"))

table1::table1(~hh_p_incl_0_2 + as.factor(hh_p_incl_0_2) | as.factor(wave), data=df)
table1::table1(~hh_p_incl_0_3 + as.factor(hh_p_incl_0_2) | as.factor(wave), data=df)

```


## Age, sex, and hh size
```{r results="asis"}
# label for the table
table1::label(df$sex2)<-"Sex"
#label(df$weekend_weekday)<-"Weekday/Weekend"
table1::label(df$age_group_2)<-"Age in years"
table1::label(df$hh_p_incl_0_2)<-"Household size"

table1(~ age_group_2 + sex2 +hh_p_incl_0_2|wave, data=df)

```




## Percent people having non-hh contact
```{r}

df_histo <- df %>% dplyr::select(new_id, wave, non_hh_contact_n)
df_histo$wave_0 <- as.numeric(df_histo$wave)
df_histo$non_hh_contacts_over_0[df_histo$non_hh_contact_n==0] <- "No"
df_histo$non_hh_contacts_over_0[df_histo$non_hh_contact_n>0] <- "Yes"
table1(~ non_hh_contacts_over_0 + as.factor(non_hh_contact_n)|wave, data=df_histo)
df_histo <- df_histo %>% group_by(wave_0, non_hh_contacts_over_0) %>% dplyr::summarise(non_hh_contacts_over_0_n=n())


no_non_hh_contact <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "non_hh_contacts_over_0_n", fill = "non_hh_contacts_over_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#663399", "#028482"),
                      name = "Non household\ncontacts",
                      labels = c("No", "Yes")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

no_non_hh_contact
no_non_hh_contact_name <- paste0(path_figures, "/no_non_hh_contact", ".png")
ggsave(no_non_hh_contact_name, width=10, height=7)



```

## Mean all contacts
```{r ,results="asis"}

#mean contact
table1::table1(~all_contact_n + all_contact_n | wave, data=df)

```

# Summary figures

## Age group
```{r}

#Age Group
df_histo <- df %>% select(new_id, wave, age_group_2, wave_0)
df_histo <- df_histo %>% group_by(wave_0, age_group_2) %>% dplyr::summarise(age_group_2_n=n())

age_per_wave <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "age_group_2_n", fill = "age_group_2")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    labs(fill=" Age in years",x= "Wave",y = "Percentage") + # rename legend title
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
age_per_wave
age_groups_part <- paste0(path_figures, "/age_groups_part", ".png")
ggsave(age_groups_part, width=10, height=7)


```

## Sex
```{r}
#Sex
df_histo <- df %>% select(new_id, wave, sex2, wave_0)
df_histo <- df_histo %>% group_by(wave_0, sex2) %>% dplyr::summarise(sex2_n=n())

sex_per_wave <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "sex2_n", fill = "sex2")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
  labs(fill=" Gender",x= "Wave",y = "Percentage") + # rename legend title
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
sex_per_wave
sex_part <- paste0(path_figures, "/sex_part", ".png")
ggsave(sex_part, width=10, height=7)



```

## hh size
```{r}

#HH Size
df_histo <- df %>% select(new_id, wave_0, hh_p_incl_0_3)
df_histo <- df_histo %>% group_by(wave_0, hh_p_incl_0_3) %>% dplyr::summarise(hh_p_incl_0_3_n=n())

hh_per_wave <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "hh_p_incl_0_3_n", fill = "hh_p_incl_0_3")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
   labs(fill=" Household size",x= "Wave",y = "Percentage") + # rename legend title
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
hh_per_wave
hh_part <- paste0(path_figures, "/hh_part", ".png")
ggsave(hh_part, width=10, height=7)

```


## Mask wearing

```{r}

#Mask 
df_histo <- df %>% select(new_id, wave_0, mask_0)
df_histo <- df_histo %>% group_by(wave_0, mask_0) %>% dplyr::summarise(mask_0_n=n())


                      
mask_per_wave <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "mask_0_n", fill = "mask_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#663399", "#028482"),
                      name = "Mask use",
                      labels = c("No", "Yes")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

mask_per_wave
mask_per_wave_all <- paste0(path_figures, "/mask_all", ".png")
ggsave(mask_per_wave_all, width=10, height=7)




#Mask restricted to those with at least one non-hh contact 
df_histo <- df %>% filter(non_hh_contact_n>0) %>% select(new_id, wave, mask_0)
df_histo$wave_0 <- as.numeric(df_histo$wave)
df_histo <- df_histo %>% group_by(wave_0, mask_0) %>% dplyr::summarise(mask_0_n=n())

mask_per_wave_restricted <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "mask_0_n", fill = "mask_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#663399", "#028482"),
                      name = "Mask use",
                      labels = c("No", "Yes")) + 
    xlab("Wave") +
    ylab("Percentage") +
    ggtitle("Mask restricted to those with at least one non-hh contact")+
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

mask_per_wave_restricted
mask_per_wave_restricted <- paste0(path_figures, "/mask_restricted", ".png")
ggsave(mask_per_wave_restricted, width=10, height=7)

```


## Transport Use

```{r}


#remember No means yes, used public transport ???

df_histo <- df %>% select(new_id, wave, transportno_0)
df_histo$wave_0 <- as.numeric(df_histo$wave)
df_histo <- df_histo %>% group_by(wave_0, transportno_0) %>% dplyr::summarise(transportno_0_n=n())


                      
transport_all <- ggplot(df_histo, 
               aes_string(x = "wave_0", y = "transportno_0_n", fill = "transportno_0")) + 
    geom_bar(position = "fill", stat = "identity") +
    scale_y_continuous(labels = scales::percent_format(),expand = c(0,0)) +
    scale_x_continuous(breaks = seq(1, current_wave, 1))+
    scale_fill_manual(values = c("#990033", "#336699"),
                      name = "Transport use",
                      labels = c("Yes", "No")) + 
    xlab("Wave") +
    ylab("Percentage") +
    theme_bw() +
    theme(axis.text.x = element_text(colour = "black", size = 15, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 16, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          plot.background = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 2, face = "bold",
                                    hjust = 0.5),
          strip.background = element_blank(),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

transport_all
transport_per_wave_all <- paste0(path_figures, "/transport_all", ".png")
ggsave(transport_per_wave_all, width=10, height=7)
```


## Mean contacts over time

```{r}

#method1:
# plot mean contact
all_c <- ggplot(df, aes(x=wave_date, y=all_contact_n))+ 
    stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
                 fun.args=list(conf.int=0.95), fill="lightblue")+
    stat_summary(geom="line", fun=mean, linetype="dashed")+
    stat_summary(geom="point", fun=mean, color="red")+
  coord_cartesian( ylim = c(0, 6))+
   ggtitle("All contact")+
  labs(y="Mean_all_contact",x="Start date of each week ")+
  scale_x_date(breaks = unique(df$wave_date))+ # display all dates on x axis
 theme_classic()+
    theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
                                    hjust = 0),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))

# all_c

# plot mean contact_hh
hh_c <- ggplot(df, aes(x=wave_date, y=hh_contact_n))+ 
  stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
               fun.args=list(conf.int=0.95), fill="lightblue")+
  stat_summary(geom="line", fun=mean, linetype="dashed")+
  stat_summary(geom="point", fun=mean, color="red")+
  # scale_x_continuous(breaks = seq(1,current_wave,2))+
  coord_cartesian( ylim = c(0, 6))+
  labs(y="Mean_contact_hh",x="Start date of each week")+
  ggtitle("Household contact")+
  scale_x_date(breaks = unique(df$wave_date))+ # display all dates on x axis
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                   angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = "right",
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
                                  hjust = 0),
        strip.text = element_text(colour = "black", size = base_size, face = "bold"))
# hh_c 

# plot mean contact_non_hh
non_hh_c <- ggplot(df, aes(x=wave_date, y=non_hh_contact_n))+ 
  stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
               fun.args=list(conf.int=0.95), fill="lightblue")+
  stat_summary(geom="line", fun=mean, linetype="dashed")+
  stat_summary(geom="point", fun=mean, color="red")+
  # scale_x_continuous(breaks = seq(1,current_wave,2))+
  coord_cartesian( ylim = c(0, 6))+
  labs(y="Mean_contact_non_hh", x="Start date of each wave")+
  ggtitle("Non-household contact")+
  scale_x_date(breaks = unique(df$wave_date))+ # display all dates on x axis
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                   angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = "right",
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
                                  hjust = 0),
        strip.text = element_text(colour = "black", size = base_size, face = "bold"))
# non_hh_c

# all contact in one plot
dt <- df %>% select("wave_date","all_contact_n","non_hh_contact_n","hh_contact_n")
dt <- melt(dt,id.vars="wave_date")

panel_covimod <- ggplot(dt, aes( x=wave_date, y=value, colour=variable, fill=variable ))+ 
    stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
                 fun.args=list(conf.int=0.95))+
    stat_summary(geom="line", fun=mean, linetype="dashed")+
    stat_summary(geom="point", fun=mean)+

  scale_fill_manual(values = c("#fee8c8","#e7e1ef","#2b8cbe"),
                    labels =c("all_contact","non_hh_contact", "hh_contact"))+
  scale_color_manual(values = c("red","purple","blue"),
                    labels =c("all_contact","non_hh_contact", "hh_contact"))+ # color for mean points
  
  # scale_x_continuous(breaks = seq(1,current_wave,2))+
  # scale_x_discrete("",labels = c(WAVES))+ #
  labs(y="Mean_contacts",x="Start date of each wave")+
   ggtitle("Mean contacts over time in NRW (COVIMOD)")+
    scale_x_date(breaks = unique(df$wave_date))+ # display all dates on x axis
     coord_cartesian( ylim = c(0,6.5))+
 theme_classic()+
    theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = c(0.28,0.9),
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 8, face = "bold",
                                    hjust = 0),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
rm(dt)
panel_covimod


```

### non_hh_contact

```{r}

# all contact in one plot
# dt <- df %>% select("wave_0",contains("_contact_n"))
dt <- df %>% select("wave_date","non_hh_contact_n","work_contact_n","school_contact_n")

dt <- melt(dt,id.vars="wave_date")

ggplot(dt, aes( x=wave_date, y=value, colour=variable, fill=variable ))+ 
    stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
                 fun.args=list(conf.int=0.95))+
    stat_summary(geom="line", fun=mean, linetype="dashed")+
    stat_summary(geom="point", fun=mean)+

  scale_fill_manual(values = c("#e7e1ef","#fee6ce","#f0f0f0"), # keep 
                    labels =c("non_hh_contact","work_contact","school_contact")
                    )+
  scale_color_manual(values = c("purple","orange","grey"),
                    labels =c("non_hh_contact","work_contact","school_contact")
                    )+ # color for mean points
  
  scale_x_continuous(breaks = seq(1,current_wave,2))+
    coord_cartesian( ylim = c(0, 6))+
  # scale_x_discrete("",labels = c(WAVES))+ #
  labs(y="Mean_contacts",x="Start date of each wave")+
   ggtitle("Mean contacts over time in NRW")+
   scale_x_date(breaks = unique(df$wave_date))+ # display all dates on x axis
 theme_classic()+
    theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = c(0.3,0.8),
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_blank(),
          plot.title = element_text(colour = "black", size = base_size + 8, face = "bold",
                                    hjust = 0),
          strip.text = element_text(colour = "black", size = base_size, face = "bold"))
rm(dt)


```



### Is a person has the same trend of contact?

This is restricted to participant has joined more than 25 times

"When restrictions get lifted, one sits at home and doing a survey becomes far more boring than going to a pub, etc. Finally seeing all the people that you haven't been able to see. So there's a difficulty there with fatigue and actually capturing people that might have the most amount of contacts."

```{r}

# min_number_waves=20
# df_rep <- get_contacts(d_all_wide,waves=c(1:current_wave),min.waves=min_number_waves)
# 
# unique(df_rep$new_id)
# rep_n <- unique(df_rep$new_id) #vector store respondents who attend at least min_number_waves
# # rep_n <- rep_n[22] # to see individual separately
# 
# 
# #method1:
# # plot mean contact
# ggplot(df_rep%>%filter(new_id %in% rep_n), aes(x=wave_0, y=all_contact_n))+ 
#     stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
#                  fun.args=list(conf.int=0.95), fill="lightblue")+
#     stat_summary(geom="line", fun=mean, linetype="dashed")+
#     stat_summary(geom="point", fun=mean, color="red")+
#   scale_x_continuous(breaks = seq(1,current_wave,2))+
#   coord_cartesian( ylim = c(0, 6))+
#   # scale_x_discrete("",labels = c(WAVES))+ #
#   labs(y="Mean_all_contact_n",x="wave")+
#   ggtitle("All contact")+
#    # theme_bw() +
#     theme(axis.text.x = element_text(colour = "black", size = 15, 
#                                      angle = 90, hjust = 0.5, vjust = 0,5),
#           axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
#           axis.title = element_text(colour = "black", size = 16, face = "bold"),
#           legend.background = element_blank(),
#           legend.key = element_blank(),
#           legend.position = "right",
#           legend.text = element_text(colour = "black", size = 15),
#           legend.title = element_text(colour = "black", size = 16, face = "bold"),
#           plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
#                                     hjust = 0),
#           strip.text = element_text(colour = "black", size = base_size, face = "bold"))
# 
# # plot mean contact_hh
# ggplot(df_rep%>%filter(new_id %in% rep_n), aes(x=wave_0, y=hh_contact_n))+ 
#     stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
#                  fun.args=list(conf.int=0.95), fill="lightblue")+
#     stat_summary(geom="line", fun=mean, linetype="dashed")+
#     stat_summary(geom="point", fun=mean, color="red")+
#   scale_x_continuous(breaks = seq(1,current_wave,2))+
#    coord_cartesian( ylim = c(0, 6))+
#   labs(y="Mean_contact_hh",x="Wave")+
#   ggtitle("Household contact")+
#    # theme_bw() +
#     theme(axis.text.x = element_text(colour = "black", size = 15, 
#                                      angle = 90, hjust = 0.5, vjust = 0,5),
#           axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
#           axis.title = element_text(colour = "black", size = 16, face = "bold"),
#           legend.background = element_blank(),
#           legend.key = element_blank(),
#           legend.position = "right",
#           legend.text = element_text(colour = "black", size = 15),
#           legend.title = element_text(colour = "black", size = 16, face = "bold"),
#           plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
#                                     hjust = 0),
#           strip.text = element_text(colour = "black", size = base_size, face = "bold"))
# # plot mean contact_non_hh
# ggplot(df_rep, aes(x=wave_0, y=non_hh_contact_n))+ 
#     stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
#                  fun.args=list(conf.int=0.95), fill="lightblue")+
#     stat_summary(geom="line", fun=mean, linetype="dashed")+
#     stat_summary(geom="point", fun=mean, color="red")+
#   scale_x_continuous(breaks = seq(1,current_wave,2))+
#    coord_cartesian( ylim = c(0, 6))+
#   labs(y="Mean_contact_non_hh_Q75", x="Wave")+
#   ggtitle("Non-household contact")+
#    # theme_bw() +
#     theme(axis.text.x = element_text(colour = "black", size = 15, 
#                                      angle = 90, hjust = 0.5, vjust = 0,5),
#           axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
#           axis.title = element_text(colour = "black", size = 16, face = "bold"),
#           legend.background = element_blank(),
#           legend.key = element_blank(),
#           legend.position = "right",
#           legend.text = element_text(colour = "black", size = 15),
#           legend.title = element_text(colour = "black", size = 16, face = "bold"),
#           plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
#                                     hjust = 0),
#           strip.text = element_text(colour = "black", size = base_size, face = "bold"))
# 
# # all contact in one plot
# dt <- df_rep%>%filter(new_id %in% rep_n) %>% select("wave_0","all_contact_n","non_hh_contact_n","hh_contact_n")
# 
# dt <- melt(dt,id.vars="wave_0")
# 
# ggplot(dt, aes( x=wave_0, y=value, colour=variable, fill=variable ))+ 
#     stat_summary(geom="ribbon", fun.data=mean_cl_normal, 
#                  fun.args=list(conf.int=0.95))+
#     stat_summary(geom="line", fun=mean, linetype="dashed")+
#     stat_summary(geom="point", fun=mean)+
#   # scale_fill_manual(values = c("#fee8c8","#e7e1ef"))+
#   scale_fill_manual(values = c("#fee8c8","#e7e1ef","#2b8cbe"))+
#   
#   scale_x_continuous(breaks = seq(1,current_wave,2))+
#   # scale_x_discrete("",labels = c(WAVES))+ #
#   labs(y="Mean_contacts",x="wave")+
#    ggtitle("Mean contacts over time in NRW")+
#    # theme_bw() +
#     theme(axis.text.x = element_text(colour = "black", size = 15, 
#                                      angle = 90, hjust = 0.5, vjust = 0,5),
#           axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
#           axis.title = element_text(colour = "black", size = 16, face = "bold"),
#           legend.background = element_blank(),
#           legend.key = element_blank(),
#           legend.position = "right",
#           legend.text = element_text(colour = "black", size = 15),
#           legend.title = element_text(colour = "black", size = 16, face = "bold"),
#           
#           plot.title = element_text(colour = "black", size = base_size + 4, face = "bold",
#                                     hjust = 0.5),
#           strip.text = element_text(colour = "black", size = base_size, face = "bold"))
# rm(dt)


```


# Contact matrices
Why age group have the answer "Dont't know" and " Prefer not to answer"
##preparation

```{r preparation}

# truncate group contact

# the truncation done before is for a whole group (school, work,else), not age group separately
# for the contact matrix, the truncation is for specific age group to later combine with individual contacts
# However, should think about truncation in a consistent way ?????

df$Q75_u18_work[df$Q75_u18_work>50] <- 50
df$Q75_1864_work[df$Q75_1864_work>50] <- 50
df$Q75_o64_work[df$Q75_o64_work>50] <- 50

df$Q75_u18_school[df$Q75_u18_school>50] <- 50
df$Q75_1864_school[df$Q75_1864_school>50] <- 50
df$Q75_o64_school[df$Q75_o64_school>50] <- 50

df$Q75_u18_else[df$Q75_u18_else>50] <- 50
df$Q75_1864_else[df$Q75_1864_else>50] <- 50
df$Q75_o64_else[df$Q75_o64_else>50] <- 50

#sampling age for for group contacts
df_work_u18 <- df %>%  
  filter(Q75_u18_work > 0 & Q75_u18_work< 51) %>% # this may not necessary because truncation was done, but still NA
  select(new_id, wave_0,age_group, Q75_u18_work)
group_contacts_work_u18 <- df_work_u18 %>% uncount(Q75_u18_work,.remove = T)
# group_contacts_work_u18$Q75_u18_work <- uncount(df_work_u18,Q75_u18_work, TRUE)
group_contacts_work_u18$age_group <- sample(0:17,dim(group_contacts_work_u18)[1], rep=TRUE)
                   
df_work_1864 <- df %>% 
  filter(Q75_1864_work> 0 & Q75_1864_work< 51) %>%
  select(new_id, wave_0,age_group, Q75_1864_work) 
group_contacts_work_1864 <- df_work_1864 %>% uncount(Q75_1864_work, TRUE)
group_contacts_work_1864$age_group <- sample(18:64,dim(group_contacts_work_1864)[1], rep=TRUE)# sampling

df_work_o64 <- df %>% 
  filter(Q75_o64_work> 0 & Q75_o64_work< 51) %>%
  select(new_id, wave_0,age_group, Q75_o64_work)
group_contacts_work_o64 <- df_work_o64 %>% uncount(Q75_o64_work, TRUE)
group_contacts_work_o64$age_group <- sample(65:90,dim(group_contacts_work_o64)[1], rep=TRUE)

df_school_u18 <- df %>%
  filter(Q75_u18_school  > 0 & Q75_u18_school < 51) %>%
  select(new_id, wave_0,age_group, Q75_u18_school)
group_contacts_school_u18 <- df_school_u18 %>% uncount(Q75_u18_school, TRUE)
group_contacts_school_u18$age_group <- sample(0:17,dim(group_contacts_school_u18[1]), rep=TRUE)

df_school_1864 <- df %>%
  filter(Q75_1864_school  > 0 & Q75_1864_school < 51) %>%
  select(new_id, wave_0,age_group, Q75_1864_school)
group_contacts_school_1864 <- df_school_1864 %>% uncount(Q75_1864_school, TRUE)
group_contacts_school_1864$age_group <- sample(18:64,dim(group_contacts_school_1864)[1], rep=TRUE)

df_school_o64 <- df %>%
  filter(Q75_o64_school  > 0 & Q75_o64_school < 51) %>%
  select(new_id, wave_0,age_group, Q75_o64_school)
group_contacts_school_o64 <- df_school_o64 %>% uncount(Q75_o64_school, TRUE)
group_contacts_school_o64$age_group <- sample(64:90,dim(group_contacts_school_o64)[1], rep=TRUE)


df_else_u18 <- df %>%
  filter(Q75_u18_else > 0 & Q75_u18_else < 51) %>%
  select(new_id, wave_0,age_group, Q75_u18_else)
group_contacts_else_u18 <- df_else_u18 %>% uncount(Q75_u18_else, TRUE)
group_contacts_else_u18$age_group <- sample(0:17,dim(group_contacts_else_u18)[1], rep=TRUE)

df_else_1864 <- df %>%
  filter(Q75_1864_else > 0 & Q75_1864_else < 51) %>%
  select(new_id, wave_0,age_group, Q75_1864_else)
group_contacts_else_1864 <- df_else_1864 %>% uncount(Q75_1864_else, TRUE)
group_contacts_else_1864$age_group <- sample(18:64,dim(group_contacts_else_1864)[1], rep=TRUE)

df_else_o64 <- df %>%
  filter(Q75_o64_else > 0 & Q75_o64_else < 51) %>%
select(new_id, wave_0,age_group, Q75_o64_else)
group_contacts_else_o64 <- df_else_o64 %>% uncount(Q75_o64_else, TRUE)
group_contacts_else_o64$age_group <- sample(64:90,dim(group_contacts_else_o64)[1], rep=TRUE)


group_list <- list(group_contacts_work_u18, group_contacts_work_1864, group_contacts_work_o64, 
     group_contacts_school_u18, group_contacts_school_1864, group_contacts_school_o64,
     group_contacts_else_u18, group_contacts_else_1864, group_contacts_else_o64)

group_contacts_all <- bind_rows(group_list)


#after sampling age for group contacts, age will be group in certain group as the same with part age group

group_contacts_all$age_group[group_contacts_all$age_group == 0] <- "<1"

group_contacts_all$age_group[group_contacts_all$age_group== 1 | group_contacts_all$age_group == 2 |
                           group_contacts_all$age_group== 3 | group_contacts_all$age_group== 4] <- "1-4"
# group_contacts_all$age_group[group_contacts_all$age_group >= 1 & group_contacts_all$age_group <= 4] <- "1-4"
# group_contacts_all$age_group[group_contacts_all$age_group >=5 & group_contacts_all$age_group <= 14] <- "5-14"

group_contacts_all$age_group[group_contacts_all$age_group== 5 |group_contacts_all$age_group== 6 |
                             group_contacts_all$age_group== 7 |group_contacts_all$age_group== 8 |
                             group_contacts_all$age_group== 9 ] <- "5-9"


group_contacts_all$age_group[group_contacts_all$age_group== 10 | group_contacts_all$age_group== 11 |
                             group_contacts_all$age_group== 12 | group_contacts_all$age_group== 13 |
                             group_contacts_all$age_group== 14] <- "10-14"

group_contacts_all$age_group[group_contacts_all$age_group== 15 | group_contacts_all$age_group== 16 |
                             group_contacts_all$age_group== 17 | group_contacts_all$age_group== 18 |
                             group_contacts_all$age_group== 19 ] <- "15-19"

group_contacts_all$age_group[group_contacts_all$age_group== 20 | group_contacts_all$age_group== 21 |
                             group_contacts_all$age_group== 22 | group_contacts_all$age_group== 23 |
                             group_contacts_all$age_group== 24 ] <- "20-24"

group_contacts_all$age_group[group_contacts_all$age_group== 25 | group_contacts_all$age_group== 26 |
                             group_contacts_all$age_group== 27 | group_contacts_all$age_group== 28 |
                             group_contacts_all$age_group== 29 | group_contacts_all$age_group== 30 |
                             group_contacts_all$age_group== 31 | group_contacts_all$age_group== 32 |
                             group_contacts_all$age_group== 33 | group_contacts_all$age_group== 34]  <- "25-34"

group_contacts_all$age_group[group_contacts_all$age_group== 35 | group_contacts_all$age_group== 36 |
                             group_contacts_all$age_group== 37 | group_contacts_all$age_group== 38 |
                             group_contacts_all$age_group== 39 | group_contacts_all$age_group== 40 |
                             group_contacts_all$age_group== 41 | group_contacts_all$age_group== 42 |
                             group_contacts_all$age_group== 43 | group_contacts_all$age_group== 44 ] <- "35-44"

group_contacts_all$age_group[group_contacts_all$age_group== 45 | group_contacts_all$age_group== 46 |
                             group_contacts_all$age_group== 47 |group_contacts_all$age_group== 48 |
                             group_contacts_all$age_group== 49 | group_contacts_all$age_group== 50 |
                             group_contacts_all$age_group== 51 | group_contacts_all$age_group== 52 |
                             group_contacts_all$age_group== 53 | group_contacts_all$age_group== 54 ] <- "45-54"

group_contacts_all$age_group[group_contacts_all$age_group== 55 | group_contacts_all$age_group== 56 |
                             group_contacts_all$age_group== 57 | group_contacts_all$age_group== 58 |
                             group_contacts_all$age_group== 59 | group_contacts_all$age_group== 60 |
                             group_contacts_all$age_group== 61 | group_contacts_all$age_group== 62 |
                             group_contacts_all$age_group== 63 | group_contacts_all$age_group== 64 ] <- "55-64"

group_contacts_all$age_group[group_contacts_all$age_group== 65 | group_contacts_all$age_group== 66 |
                             group_contacts_all$age_group== 67 | group_contacts_all$age_group== 68 |
                             group_contacts_all$age_group== 69] <- "65-69"



group_contacts_all$age_group[group_contacts_all$age_group== 70 | group_contacts_all$age_group== 71 | group_contacts_all$age_group== 72 |
                             group_contacts_all$age_group== 73 | group_contacts_all$age_group== 74 ] <- "70-74"

group_contacts_all$age_group[group_contacts_all$age_group== 75 | group_contacts_all$age_group== 76 |
                             group_contacts_all$age_group== 77 | group_contacts_all$age_group== 78 |
                             group_contacts_all$age_group== 79 ] <- "75-79"

group_contacts_all$age_group[group_contacts_all$age_group== 80 |group_contacts_all$age_group== 81 | group_contacts_all$age_group== 82 |
                           group_contacts_all$age_group== 83 | group_contacts_all$age_group== 84] <- "80-84"

group_contacts_all$age_group[group_contacts_all$age_group== 85 | group_contacts_all$age_group== 86 |
                             group_contacts_all$age_group== 87 | group_contacts_all$age_group== 88 |
                             group_contacts_all$age_group== 89 | group_contacts_all$age_group== 90] <- "85+"


# combine group contact (individualizied) into non_hh contact
keeps <- c("new_id","wave", "age_group")
dt_outside_all_c <- dt_outside_all[ , keeps, drop = FALSE]
colnames(dt_outside_all_c) <- c("new_id","wave_0", "age_group") # rename wave to wave_0 to be in line with supsequent codes

dt_outside_all_c <- rbind(dt_outside_all_c, group_contacts_all) 

# add hh_contact
dt_hh_all_c <- dt_hh_all %>% 
  select(new_id, wave, age_group)
colnames(dt_hh_all_c ) <- c("new_id","wave_0", "age_group") # rename wave to wave_0 to be in line with following codes


dt_all_c <- rbind(dt_outside_all_c, dt_hh_all_c)

dt_all_c$age_group[dt_all_c$age_group=="85 years or older"] <- "85+" 
dt_all_c$age_group[dt_all_c$age_group == "Under 1"] <- "<1" 

#check
unique(dt_all_c$age_group) 
table1::table1(~age_group  |wave_0, dt_all_c, caption = "Check")


```


## matrices
 wave 17: strange pattern

```{r contact matrix for wave 1 densely}

plot_list <- list()

wave<- current_wave

for ( wave_n in 1: wave ){
  
# participant dataset 
part_matrix <- d_self_all %>% 
  select(new_id, wave_0, age_group)%>%
  # filter(qmktsize_16_0=="Densely populated area" & wave == 1)
  filter(wave_0 == wave_n)

# contacts dataset
contact_matrix <-dt_all_c %>% 
  select(new_id, wave_0,age_group,contains("contact_5")) %>%
  filter(wave_0 == wave_n) 

# Assign age group as a single value
part_matrix <- part_matrix %>% mutate(part_age =
                                                  case_when(age_group == "Under 1" ~ 2,
                                                            age_group == "1-4" ~ 2, 
                                                            age_group == "5-9" ~ 2,
                                                            age_group == "10-14" ~ 2,
                                                            age_group == "15-19" ~ 17,
                                                            age_group == "20-24" ~ 22,
                                                            age_group == "25-34" ~ 30,
                                                            age_group == "35-44" ~ 40,
                                                            age_group == "45-54" ~ 50,
                                                            age_group == "55-64" ~ 60,
                                                            age_group == "65-69" ~ 67,
                                                            age_group == "70-74" ~ 67,
                                                            age_group == "75-79" ~ 82,
                                                            age_group == "80-84" ~ 82,
                                                            age_group == "85 years or older" ~ 82))

contact_matrix <- contact_matrix %>% mutate(cnt_age =
                                                    case_when(age_group == "Under 1" ~ 2,
                                                              age_group == "1-4" ~ 2, 
                                                              age_group == "5-9" ~ 2,
                                                              age_group == "10-14" ~ 2,
                                                              age_group == "15-19" ~ 17,
                                                              age_group == "20-24" ~ 22,
                                                              age_group == "25-34" ~ 30,
                                                              age_group == "35-44" ~ 40,
                                                              age_group == "45-54" ~ 50,
                                                              age_group == "55-64" ~ 60,
                                                              age_group == "65-69" ~ 67,
                                                              age_group == "70-74" ~ 67,
                                                              age_group == "75-79" ~ 82,
                                                              age_group == "80-84" ~ 82,
                                                              age_group == "85 years or older" ~ 82))


# for socialmixR change variable to part_id, create survey_object
# part_id and survey_object are required for the contact matrix 
colnames(part_matrix)[1] <- "part_id"
colnames(contact_matrix)[1] <- "part_id" #out_contacts = non_hh-contacts
survey_object  <- survey(part_matrix, contact_matrix)

# contact matrix
cm <- contact_matrix(survey_object, age.limits = c(0, 14, 19, 24, 34, 44, 54, 64, 75),  missing.participant.age = c("remove"),
                          missing.contact.age = c("remove"), symmetric = TRUE)

# output gespeichert, data_cm wird für heatmap benötigt
data_cm <- cm$matrix

#Plot
melt_cm <- reshape2::melt(data_cm)

melt_cm$Var1[melt_cm$Var1 ==  1] <- "0-14"
melt_cm$Var1[melt_cm$Var1 ==  2] <- "15-19"
melt_cm$Var1[melt_cm$Var1 ==  3] <- "20-24"
melt_cm$Var1[melt_cm$Var1 ==  4] <- "25-34"
melt_cm$Var1[melt_cm$Var1 ==  5] <- "35-44"
melt_cm$Var1[melt_cm$Var1 ==  6] <- "45-54"
melt_cm$Var1[melt_cm$Var1 ==  7] <- "55-64"
melt_cm$Var1[melt_cm$Var1 ==  8] <- "65-74"
melt_cm$Var1[melt_cm$Var1 ==  9] <- "75+"


levels(melt_cm$contact.age.group) <- list("0-14" = "[0,14)", "15-19" = "[14,19)", 
                                               "20-24" = "[19,24)", "25-34" = "[24,34)", 
                                               "35-44" = "[34,44)", "45-54" = "[44,54)",
                                                "55-64" = "[54,64)", "65-74" = "[64,75)",
                                               "75+" = "75+")



# plot 
p<- ggplot(melt_cm, aes(contact.age.group, Var1)) +
  geom_tile(aes(fill = value)) +
  coord_equal() +
  ggtitle(paste0("Wave ", wave_n)) +
  geom_text(aes(label=sprintf("%0.1f", round(value, digits = 2))), size = 2) +
  scale_fill_gradient2(low = "#fff5f0",
                       # mid = "white",
                       high = "#e31a1c", limits = c(0,6), midpoint = 0.1) +
  guides(fill = guide_colourbar(barwidth = 0.5,
                                barheight = 5, title = "Contacts")) +
  theme(legend.position = "right")+
  theme(plot.title = element_text(size = 10, face = "bold",hjust = 0.5),
        axis.title = element_blank(),
        axis.text.x = element_text(size = 8, face = "bold",angle = 90, vjust = 0.5),
        axis.text.y = element_text(size = 8, face = "bold"),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm"), # reduce space for combination plot later
        panel.background = element_blank())
  
plot_list[[wave_n]] = p # store plots in the list

}


# plot from the plot_list
do.call(grid.arrange,plot_list[1:4])
do.call(grid.arrange,plot_list[5:8])
do.call(grid.arrange,plot_list[9:12])
do.call(grid.arrange,plot_list[13:16])
do.call(grid.arrange,plot_list[17:20])
do.call(grid.arrange,plot_list[21:24])
do.call(grid.arrange,plot_list[25:28])
do.call(grid.arrange,plot_list[29:32])
do.call(grid.arrange,plot_list[33:current_wave])


# current.mode <- tmap_mode("plot")
# do.call(tmap_arrange(plot_list[10:18], widths = c(0.5, 0.5)))
# tmap_mode(current.mode)


```

# Mobility
## Net check

```{r}

mobi <- read.csv(paste0(path_mobility,"/cx_by_state_2022-01-31_Nordrhein-Westfalen.csv"))
colnames(mobi)
names(mobi) <- c("date","k","CI95.k","cx", "CI95.cx") # rename variables
mobi$date <- as.Date(mobi$date, format = "%d/%m/%Y")
# add week
mobi$week <- as.integer((as.Date(mobi$date)-as.Date("2020-01-01"))/7+1) # 1-1-2020 is on Wednesday
mobi$week_date <-lubridate::ymd("2020-01-01" ) + lubridate::weeks(mobi$week-1)# A week starts on Wednesday

# #calculate lower and upper limit from 95%CI
# mobi$lower_k <- mobi$k - mobi$CI95_k
# mobi$upper_k <- mobi$k + mobi$CI95_k
# mobi$lower_cx <- mobi$cx - mobi$CI95_cx
# mobi$upper_cx <- mobi$cx + mobi$CI95_cx

# rolling average
 mobi <- mobi %>%mutate(
      cx_mean7da = zoo::rollmean(cx, k = 7, fill = NA),
      k_mean7da = zoo::rollmean(k, k = 7, fill = NA))


# data: from 27.02.2020 to 26.01.2022. However, for comparison with COVIMOD data, only data from 30.04.2020 to 31.12.2021 is used
# mobi1 <- mobi %>% filter(date >= as.Date("2020-04-30")& date <= as.Date("2021-12-31")) # cut early date to be ib line with COVIMOD
mobi1 <- mobi # as original data
                

```

### contact number

```{r}
# Number of contact 
## origin data
ggplot(mobi1,aes( x = date)) +
   geom_line( aes(y = k,color = "k"), size = 1)+
   geom_line( aes(y = k_mean7da,color = "k_mean7da"), size = 1)+
   labs(y="Number of contact",x="")+
   ylim (0,30)+
   ggtitle("Number of contacts over time in NRW (Netcheck data) " )+
   scale_x_date(breaks = "21 days")+ # display all dates on x axis
  # scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
  #              limits = c(as.Date("2020-01-15"),as.Date("2021-12-31")),
  #              expand = c(0, 0)) +
  scale_color_manual(name = "", values = c("k"="blue","k_mean7da"="red"),
                     labels = c("Daily contacts",
                          "Rolling ave.7days"))+
   theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position = c( 0.5,0.8),
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))
 



```

### contact index

```{r}
# Number of contact 
## original data
ggplot(mobi1,aes( x = date)) +
  geom_line( aes(y = cx,color = "cx"), size = 1)+
   geom_line( aes(y = cx_mean7da,color = "cx_mean7da"), size = 1)+
  labs(y="Contact index(CX)",x="", fill = "")+
  ylim(0,1500)+
  scale_x_date(breaks = "21 days")+ # display all dates on x axis
  # scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
  #              limits = c(as.Date("2020-01-15"),as.Date("2021-12-31")),
  #              expand = c(0, 0)) +
  scale_color_manual(name = "", values = c("cx"="blue","cx_mean7da"="red"),
                     labels = c("Daily contact index(cx)",
                          "Rolling ave.7days"))+
   theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position = c( 0.5,0.8),
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))

```

## Google mobility

```{r}
google_2020 <- read.csv(paste0(path_mobility,"/google/2020_DE_Region_Mobility_Report.csv"))
google_2021 <- read.csv(paste0(path_mobility,"/google/2021_DE_Region_Mobility_Report.csv"))
# check if the cols names is the same
colnames(google_2020)
colnames(google_2021)
# combine data from 2 years
google <- rbind(google_2020,google_2021)
rm(google_2020,google_2021 )# remove unused data
# subset to NRW level
unique(google$sub_region_1)# check if NRW label is unique before subset
google <- google %>% filter (sub_region_1=="North Rhine-Westphalia")
google <- google[, -c(1:8)]# remove unused cols
colnames(google)
colnames(google)<- c("date","retail_recreation","grocery_pharmac","parks","transit_stations","workplaces","residential" ) # shorter col names
google$date <- as.Date(google$date, format = "%Y-%m-%d")

colnames(google)
google <- google %>%
  mutate(ave_allplace = (retail_recreation+grocery_pharmac+transit_stations+workplaces+residential+parks)/6)
google <- google %>%
  mutate(ave_allplace_nopark = (retail_recreation+grocery_pharmac+transit_stations+workplaces+residential)/5)


# Rolling average of 7 days 
google<- google %>%mutate(
  retail_recreation_mean7da   = zoo::rollmean(retail_recreation, k = 7, fill = NA),
  grocery_pharmac_mean7da     = zoo::rollmean(grocery_pharmac, k = 7, fill = NA),
  grocery_pharmac_mean7da     = zoo::rollmean(grocery_pharmac, k = 7, fill = NA),
  parks_mean7da               = zoo::rollmean(parks, k = 7, fill = NA),
  transit_stations_mean7da    = zoo::rollmean(transit_stations, k = 7, fill = NA),
  workplaces_mean7da          = zoo::rollmean(workplaces, k = 7, fill = NA),
  residential_mean7da         = zoo::rollmean(residential, k = 7, fill = NA),
  ave_allplace_mean7da        = zoo::rollmean(ave_allplace, k = 7, fill = NA),
  ave_allplace_nopark_mean7da = zoo::rollmean(ave_allplace_nopark, k = 7, fill = NA)
)


```

###Average change 

The movement to parks is more likely relevant to seasonal, so it will be excluded from general trend of movement 

```{r}


ggplot(google,aes( x = date)) +
  geom_line( aes(y = ave_allplace_nopark,color = "ave_allplace_nopark"), size = 1)+
   geom_line( aes(y = ave_allplace_nopark_mean7da,color = "ave_allplace_nopark_mean7da"), size = 1)+
   geom_hline(yintercept=0, linetype="dashed", 
                color = "black", size=1)+
   labs(y="",x="", color = "")+
   ggtitle("Movement trends in NRW in Gernal [google data] " )+
   scale_y_continuous(limits = c(-100,100),breaks = seq(-100,100, by = 50),
                      labels = c("-100%","-50%","Baseline\n(Jan-mid.Feb)","50%","100%"))+ #labels = unit_format(unit ="%")
  scale_x_date(breaks = "21 days")+ # display all dates on x axis
  # scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
  #              limits = c(as.Date("2020-01-15"),as.Date("2021-12-31")),
  #              expand = c(0, 0)) +
  scale_color_manual(name = "", values = c("ave_allplace_nopark"="blue","ave_allplace_nopark_mean7da"="red"),
                     labels = c("Daily contact index(cx)",
                          "Rolling ave.7days"))+
   theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position = c( 0.2,0.8),
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))


```

### Specific places

```{r}

google_melt <- google %>%select(-contains("parks"))%>% select(date,contains("_mean7da")) # keep rolling average variables only
google_melt <- melt(google_melt,id.vars = "date") # id.vars is variable that you don't want to melt
ggplot(google_melt%>%filter(variable !="ave_allplace_mean7da"&variable !="ave_allplace_nopark_mean7da"),
       aes( x = date, y = value, color = variable)) +
  geom_line(size =1)+
  geom_hline(yintercept=0, linetype="dashed", 
             color = "black", size=1)+
  labs(y="",x="", color = " ")+
  ggtitle("Movement trends in NRW [google data] " )+
  scale_x_date(breaks = "21 days")+ # display all dates on x axis
  scale_color_manual(values = c("red","#de77ae","blue","grey","orange"),
                     labels = c("Retail_recreation",
                                "Grocery_pharmac",
                                "Transit_stations",
                                "Workplaces",
                                "Residential"))+
  scale_y_continuous(limits = c(-100,100),
                     labels = c("-100%","-50%","Baseline\n(Jan-mid.Feb)","50%","100%"))+#labels = unit_format(unit ="%")
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
           legend.position = c( 0.2,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



```

## Facebook

**Change in Movement:** is to understand how much less people are moving around since
the onset of the coronavirus epidemic. People move around were quantified  by counting the number of level-16 Bing tiles ( 600 x 600 meter).

**Stay single place:** the percentage of eligible people (above) who are only observed in a single level-16 Bing tile during the course of a day. 


```{r}

#https://research.facebook.com/blog/2020/06/protecting-privacy-in-facebook-mobility-data-during-the-covid-19-response/

facebook1 <- read_delim(paste0(path_mobility,"/facebook/movement-range-data-2020-03-01--2020-12-31.txt")) # 2020 data
facebook2 <- read_delim(paste0(path_mobility,"/facebook/movement-range-2022-02-08.txt")) # 2021 data
facebook <- rbind( facebook1, facebook2)
dim(facebook)[1] == dim(facebook1)[1] +dim(facebook2)[1] # check if TRUE
rm(facebook1, facebook2) # remove incomplete data

facebook <- facebook %>% filter(country == "DEU" & polygon_name == "Nordrhein-Westfalen")

facebook <- facebook %>% select(ds, contains("all_"))
colnames(facebook) <- c("date","movement_change","prop_one_location")


# Rolling average of 7 days 
facebook <-  facebook%>%mutate(
  movement_change_mean7da   = zoo::rollmean(movement_change, k = 7, fill = NA),
  prop_one_location_mean7da  = zoo::rollmean(prop_one_location, k = 7, fill = NA)
)

```

###Movement trend

```{r}


facebook_melt <- facebook %>% select("date",contains("_mean7da")) #
facebook_melt <- melt(facebook_melt,id.vars = "date") # id.vars is variable that you don't want to melt
ggplot(facebook_melt,
       aes( x = date, y = value, color = variable)) +
  geom_line(size =1)+
  geom_hline(yintercept=0, linetype="dashed", 
             color = "black", size=1)+
  labs(y="",x="", color = " ")+
  ggtitle("Movement trends in NRW Germany [facebook data_mean7day] " )+
  scale_x_date(breaks = "21 days")+ # display all dates on x axis
  scale_color_manual(values = c("Green","blue","orange"),
                     labels = c("Change in movement",
                                "Stay a single place"))+
  scale_y_continuous(limits = c(-0.4,0.8),breaks = seq(-0.4,0.8, by = 0.2),# not yet scale 100%
                     labels = c("-40%","-20%","Baseline \n   (Feb.20)","20%","40%","60%","80%"))+#labels = unit_format(unit ="%")
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.2,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


```

## Apple 

**This only at country level**

```{r}

apple <- read.csv(paste0(path_mobility,"/applemobilitytrends-2022-02-10.csv"))
apple <- apple%>%filter( region =="Germany")
colnames(apple)
apple<- apple %>% select(transportation_type,contains("X"))
#revert cols into rows:
apple <- apple %>% 
  rownames_to_column() %>% 
  gather(variable, value, -rowname) %>% 
  spread(rowname, value)
colnames(apple) <- c("date", "driving","transit","walking") # add col names
apple <- apple [-1,] # remove 1st with names
apple$date <- substring(apple$date,2) # remove 1st letter of a string
apple$date <- as.Date(apple$date, format = "%Y.%m.%d")
apple <- apple %>% 
     mutate_at(c(2:4), as.numeric) # covert cols 2:4 to numeric
table(duplicated(apple$date)) # check if there is duplicated date

# calculate changes: Baseline: January 13th, 2020 ( value = 100)
apple$driving <- apple$driving  - 100
apple$transit <- apple$transit  - 100
apple$walking <- apple$walking  - 100

apple <- apple[-1,] # remove baseline row

# Rolling average of 7 days 
apple <-  apple %>%mutate(
  driving_mean7da   = zoo::rollmean(driving, k = 7, fill = NA),
  transit_mean7da   = zoo::rollmean(transit, k = 7, fill = NA),
  walking_mean7da   = zoo::rollmean(walking, k = 7, fill = NA)
)



```

###Movement trend

```{r}

apple_melt <- apple %>% select("date",contains("_mean7da")) # 
apple_melt <- melt(apple_melt,id.vars = "date") # id.vars is variable that you don't want to melt
ggplot(apple_melt,
       aes( x = date, y = value, color = variable)) +
  geom_line(size =1)+
  geom_hline(yintercept=0, linetype="dashed", 
             color = "black", size=1)+
  labs(y="",x="", color = " ")+
  ggtitle("Movement trends in Germany [apple data] " )+
  scale_x_date(breaks = "21 days")+ # display all dates on x axis
  scale_color_manual(values = c("Green","blue","orange"),
                     labels = c("Driving",
                                "Transit",
                                "Waking"))+
  scale_y_continuous(limits = c(-100,200), breaks = seq(-100,200, by = 50),
                     labels = c("-100%","-50%","Baseline \n (13.01.20)","50%","100%","150%","200%"))+#labels = unit_format(unit ="%")
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.2,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


```

 

