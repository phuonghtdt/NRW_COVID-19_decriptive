---
title: "COVID-19 in NRW"
author: "Thi Phuong Huynh"
date: "2/7/2022"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true # able of contents to the left, visible even when the document is scrolled
---

# Set up

Date: <b>`r format(Sys.Date(), "%B %d, %Y")`</b>

All computations were performed with `r R.Version()$version.string`.

To be commit:


```{r setup, include=FALSE}

rm(list = ls())
knitr::opts_chunk$set(fig.retina = 1, fig.height = 7, fig.width = 14,
                      echo = FALSE, message = FALSE, warning = FALSE,
                      results='hide')
Sys.setlocale("LC_TIME", "C")
BEGIN_RMD <- Sys.time() # Keeping track of running time
options(warn = 1) # If warn is one, warnings are printed as they occur.

#Loading package
library(reshape2, ggplot2)
library('ggplot2')
library('scales')
library(tidyverse)
library(surveillance)
library(lubridate)
library(broom)
library(runjags)
# library(rjags) check !
library(EpiEstim)
library(incidence)
library(epitools)
library(zoo) # rolling average
library(readxl)
library(ggpubr) # ggarrange
library(grid)

library(extrafont) 


library(sf) # for reading shape files into R
library(tmap)#for creating the map
library(dplyr)
library(ggpubr) #ggarrange
library(pheatmap)

path_data <- paste0("C:/Users/huynh/sciebo/NRW_descriptive/data")
path_result <- paste0("C:/Users/huynh/sciebo/NRW_descriptive/results")

```

#changeable variable

```{r}

#pop
NRW_pop <- 17925570
NRW_under12 <- 2014762
NRW_pop_vacc <- NRW_pop - NRW_under12
DE_pop <- 83155031 # ref: 2020#https://www-genesis.destatis.de# code: 12411


start_day <- as.Date("2020-02-27")# data before this day won't be counted
current_date <-as.Date("2021-12-29") # data is available up to this date

#Under report ??
u_report_w1 <- 0.78
u_report_w2 <- 0.25
# pop(https://www.destatis.de/DE/Home/_inhalt.html)
#ref map: https://www.mags.nrw/matchingberater-karte
#NRW pop. by county: http://www.citypopulation.de/en/germany/cities/nordrheinwestfalen/
#NRW pop. by county( original from destatis): https://www-genesis.destatis.de/genesis/online?sequenz=statistikTabellen&selectionname=12411&language=en#abreadcrumb

colfunc <- colorRampPalette(c("black", "white"))
colfunc(19)
palette <- c("red","#003366", "olivedrab3","#336699", "#CCFFFF", "#028482", "#663399", "#990033", "#FF3333", "royalblue1","#FF9900", 
             "#266A2E", "#55D43F", "#404040", "#C87533", "#DCDCDC", "#FFDE00", "#F1B2E1", "#FF717E", "maroon3")
# print(palette)
# scales::show_col(palette)

# sequencial palette
palette1 <- c("#8e0152","#c51b7d", "#de77ae","#f1b6da", "#fde0ef",
              "#276419", "#4d9221", "#7fbc41","#b8e186","#e6f5d0",
              "#67001f", "#b2182b", "#d6604d", "#f4a582", "#fddbc7",
              "#e0e0e0", "#bababa", "#878787", "#4d4d4d", "#1a1a1a")



# print(palette1)
# scales::show_col(palette1)


```

# Data

Data from RKI: description of data can be read [here:](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/a99afefd4258435f8af660b6cbed9bf7_0/about)

Census data from [Federal Statistical Office of Germany](https://www.destatis.de/EN/Home/_node.html)


```{r read in}
#(1) Linelist_COVID-19 in NRW
dat = read.csv(paste0(path_data,"/211229_Fall-Liste.csv"), sep=";", encoding="UTF-8")# encoding="UTF-8" : umlaut character
colnames(dat)
dat <- dat %>% dplyr::select(-contains("InterneRef")) #rm
names(dat) <- c("rep_date","county", "disease_start", "age",'hosp')   #rename
dat$hosp <- as.factor(dat$hosp)
#(1.1) rki data:https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/a99afefd4258435f8af660b6cbed9bf7_0/about

dat_rki  <- read.csv(paste0(path_data,"/RKI_COVID19_Nordrhein-Westfalen.csv"), encoding="UTF-8")# encoding="UTF-8" : umlaut character

dat_rki <- dat_rki%>%
  dplyr::select(Landkreis,Geschlecht,Altersgruppe,Meldedatum,Refdatum,IstErkrankungsbeginn,NeuerFall,NeuerTodesfall,NeuGenesen,AnzahlFall,AnzahlTodesfall,AnzahlGenesen)
colnames(dat_rki) <- c("kreis","gender","agegroup","rep_date","ref_date","disease_onset","newcase","newdeath","newrecover","case","death","recover")
dat_rki$rep_date <- as.Date(dat_rki$rep_date)
dat_rki <- dat_rki %>% filter(rep_date <= as.Date("2021-12-29")) # the same as dat
dat_rki$rep_week <- as.integer((as.Date(dat_rki$rep_date)-as.Date("2020-01-01"))/7+1) #wednessday starts a week
dat_rki$maxrepweek <- max(dat_rki$rep_week) 
# remove rep week 8 because of insufficient data 
dat_rki <- dat_rki %>% filter(rep_week >=10)# data from rki is avaible from week 1 and become more consistent since week 9
#revert week to date: 
#check which day is starting of a week : Wednesday
dat_rki$rep_week_date <- lubridate::ymd( "2020-01-01" ) + lubridate::weeks(dat_rki$rep_week-1)
dat_rki$rep_week_date <- as.Date(dat_rki$rep_week_date)

#0: Case is included in the publication for the current day and in the one for the previous day.
#1: case is only included in the current publication
#-1: case is only contained in the publication of the previous day
# why the number in 2022 is all negative? shall it be corrected later.

#(2) age distribution in NRW
## age: 90 mean 90 and older
pop_age = read.csv(paste0(path_data,"/NRW_population_by age.csv"))

pop_county <- read.csv(paste0(path_data,"/NRW_cencus/NRW_pop_bycounty_NUTS_ID.csv"),row.names = 1, encoding="UTF-8")
pop_county <- pop_county%>% dplyr::select(c("pop_n", "NUTS_ID")) #county name has error ->rm it
area <- read.csv(paste0(path_data,"/Size_territory_de.csv"), encoding="UTF-8")
area <- area %>% select(area_sq_km,NUTS_ID)

#(3) hospitalization
hosp <- read_excel(paste0(path_data,"/211229 NRW dateninput modellierungen wwu.xlsx"), sheet = 2)

#(4)Whole Germany_JHU data # up to date data
# download.file("https://raw.githubusercontent.com/covid19-forecast-hub-europe/covid19-forecast-hub-europe/main/data-truth/JHU/truth_JHU-Incident%20Cases.csv", destfile = paste0(path_data,"/truth_JHU-Incident_Cases.csv")) # download data from Github## check update version
germany <- read.csv(paste0(path_data,"/truth_JHU-Incident_Cases.csv"))

# (5) NUTS_3##############################
nuts3 <- read_sf(paste0(path_data,"/NUTS/NUTS_RG_20M_2021_3035.shp")) #Eurostat
# nuts3 <- read_sf(paste0(path_data,"/NUTS/nuts1000_12-31.gk3.shape/nuts1000_1231_3")) # RKI
nuts3 <- nuts3 %>% dplyr::filter(CNTR_CODE == "DE") # chose only Germany
nuts3$NAME_LATN <- gsub(",.*", "",nuts3$NAME_LATN) #rm string after comma
colnames(nuts3)[which(names(nuts3) == "NAME_LATN")] <- "county"  # rename a col
nuts3 <- nuts3 %>% dplyr::filter(nuts3$NUTS_ID %in% pop_county$NUTS_ID) # choose only NRW
nuts3 <- merge(nuts3,pop_county, by = "NUTS_ID") # add population
nuts3 <- merge(nuts3,area, by = "NUTS_ID") # add area


#(6) Deprivation upto 2015
# download.file("https://raw.githubusercontent.com/lekroll/GISD/master/Revisions/2019/Bund/Kreis/Kreis.csv", destfile = paste0(path_data,"/GISD/GISD_upto2015.csv")) # download data from Github## check update version

gisd <- read.csv(paste0(path_data,"/GISD/GISD_upto2015.csv"), sep = ",",row.names = 1)
colnames(gisd) <- c("county_id","county","year","pop","GISD_Score","GISD_5","GISD_10","GISD_k")
gisd <- gisd %>%filter(year == 2015) # the most recent data
gisd$county <- gsub(",.*", "", gisd$county) #rm string after comma
gisd <- merge(nuts3,gisd, by = "county")    # add NUTS info
# gisd$GISD_5 <- as.factor(gisd$GISD_5)

#(7) Regulations

## Bundesland level
reg_bund <- read.csv(paste0(path_data,"/bl_massnahmen_oberkategorien.csv"),row.names = 1, encoding="UTF-8")# encoding="UTF-8" : umlaut character)
reg_bund <- reg_bund %>% filter(bundesland == "Nordrhein-Westfalen")
reg_bund <- reg_bund %>% dplyr::select(-c(ags2, bundesland))

reg_bund <- pivot_longer(reg_bund, cols=2:dim(reg_bund)[2], names_to = "date", values_to = "measure_imp") # transpose from cols to rows
reg_bund$date <- gsub("^.{0,1}", "", reg_bund$date)# Replace first character () with empty string ""
reg_bund$date <- as.Date(reg_bund$date , format="%Y%m%d")
reg_bund$measure_imp <- as.factor(reg_bund$measure_imp)


## Landkreis level
reg_lk <- read.csv(paste0(path_data,"/kr_massnahmen_oberkategorien.csv"),row.names = 1, encoding="UTF-8")# encoding="UTF-8" : umlaut character)
reg_lk <- reg_lk %>% filter(bundesland == "Nordrhein-Westfalen")
reg_lk <- reg_lk %>% filter(m_code != "M22"&m_code != "M23"&m_code != "M24")# these measures were not applied

#(8) vaccinations in NRW
# Bundesland level
vacc_BUND<- read_csv(paste0(path_data,"/Aktuell_Deutschland_Bundeslaender_COVID-19-Impfungen.csv"))
vacc_BUND <- vacc_BUND %>% filter(BundeslandId_Impfort=="05")
colnames(vacc_BUND) <- c("rep_date",'state_code',"vac_type",'dose',"vac_n")
# County (lankreis) level
vacc_LK<- read_csv(paste0(path_data,"/Aktuell_Deutschland_Landkreise_COVID-19-Impfungen.csv"))
vacc_LK<- vacc_LK%>% filter(str_sub(LandkreisId_Impfort,1,2)=='05') # or is code of NRW
colnames(vacc_LK) <- c("rep_date",'county_code',"age group",'dose',"vac_n")


```

## cleaning data

```{r}

#(1) Linelist_covid-19 in NRW
dat$county[dat$county == "StadtRegion Aachen"] <- "SK StadtRegion Aachen" #change to the same format with other counties
dat$county <- gsub("^.{0,3}", "", dat$county)# Replace first 3 characters (SK ) with empty string ""
dat$rep_date<- as.Date(dat$rep_date, "%Y-%m-%d")
dat$disease_start<- as.Date(dat$disease_start, "%Y-%m-%d")
dat$county <- as.factor(dat$county)
dat$rep_week <- as.integer((as.Date(dat$rep_date)-as.Date("2020-01-01"))/7+1) #wednessday starts a week
dat$maxrepweek <- max(dat$rep_week) 
# remove rep week 8 because of insufficient data 
dat <- dat %>% filter(rep_week >=10)#
#revert week to date: 
#check which day is starting of a week : Wednesday
dat$rep_week_date <- lubridate::ymd( "2020-01-01" ) + lubridate::weeks(dat$rep_week-1)
dat$rep_week_date <- as.Date(dat$rep_week_date)
# age group:19
dat$agegroup<- dat$age
dat$agegroup <- cut(dat$agegroup, breaks=c(-Inf, 4, 9,14, 19,24,29,34,39,44,49,54,59,64,69,74,79,84,89, Inf))
dat$agegroup <- factor(dat$agegroup, levels=c("(-Inf,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]",  "(89, Inf]"),
                       labels=c("0-4","5-9","10-14", "15-19", "20-24", "25-29", "30-34", "35-39",
                                "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74",
                                "75-79", "80-84", "85-89", ">90"), ordered=T)
# agegroup2: 6
dat$agegroup2<- dat$age
dat$agegroup2 <- cut(dat$agegroup2, breaks=c(-Inf,4,14,34,59,79, Inf))
dat$agegroup2 <- factor(dat$agegroup2, levels=c("(-Inf,4]", "(4,14]", "(14,34]", "(34,59]", "(59,79]",  "(79, Inf]"),
                       labels=c("0-4","5-14","15-34", "35-59", "60-79",">80"), ordered=T)


# These two counties:  "Mülheim an der Ruhr", "Städteregion Aachen" (nuts3) is different from dat ("Mülheim a.d.Ruhr", "StadtRegion Aachen" )
##rename it to be inline with other dataset

dat$county <- gsub("Mülheim a.d.Ruhr", "Mülheim an der Ruhr", dat$county)
dat$county <- gsub("StadtRegion Aachen", "Städteregion Aachen", dat$county)


# dat_county <- merge(dat_county , pop, by = c("NUTS_ID"), all = T) #
# nuts3 <- merge(nuts3,dat_county, by = "NUTS_ID")


#(2) age distribution in NRW ##########

pop_age$agegroup<- pop_age$age
pop_age$agegroup <- cut(pop_age$agegroup, breaks=c(-Inf, 4, 9,14, 19,24,29,34,39,44,49,54,59,64,69,74,79,84,89, Inf))
pop_age$agegroup <- factor(pop_age$agegroup, levels=c("(-Inf,4]", "(4,9]", "(9,14]", "(14,19]", "(19,24]", "(24,29]", "(29,34]", "(34,39]", "(39,44]", "(44,49]", "(49,54]", "(54,59]", "(59,64]", "(64,69]", "(69,74]", "(74,79]", "(79,84]", "(84,89]",  "(89, Inf]"),
                       labels=c("0-4","5-9","10-14", "15-19", "20-24", "25-29", "30-34", "35-39",
                                "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74",
                                "75-79", "80-84", "85-89", ">90"), ordered=T)
# agegroup2: 6
pop_age$agegroup2<- pop_age$age
pop_age$agegroup2 <- cut(pop_age$agegroup2, breaks=c(-Inf,4,14,34,59,79, Inf))
pop_age$agegroup2 <- factor(pop_age$agegroup2, levels=c("(-Inf,4]", "(4,14]", "(14,34]", "(34,59]", "(59,79]",  "(79, Inf]"),
                       labels=c("0-4","5-14","15-34", "35-59", "60-79",">80"), ordered=T)



# remove rep week 8 because of insufficient data 
dat <- dat %>% filter(rep_week >=10)#

#(3) hospitalization
colnames(hosp)
colnames(hosp) <- c("rep_date","total","normal","intensive","ventilation")

hosp$rep_date<- as.Date(hosp$rep_date)
hosp$rep_week <- as.integer((as.Date(hosp$rep_date)-as.Date("2020-01-01"))/7+1)
hosp$maxrepweek <- max(hosp$rep_week) 

#revert week (number) to start hospe of a week: 1/1/2020 is on Wednesday 
## So Wednesday is start of a week
hosp$rep_week_date <- lubridate::ymd( "2020-01-01" ) + lubridate::weeks(hosp$rep_week-1)# indicated date starts week 2 of the year
hosp$rep_week_date <- as.Date(hosp$rep_week_date)

#(4) whole Germany data##################

germany <- germany%>%filter(location=="DE") #Germany only
germany$value[germany$value == -554] <-(17248+11315)/2 # replace negative value=ave of 2 nearby days
germany <- germany[,-(1:2)]                            # remove location and location_name
names(germany) <- c("rep_date", "case_n")                     #rename
germany$rep_date <- as.Date(germany$rep_date)          #date format
germany<- germany %>%
  mutate(avg_inf = rollapply(case_n,7,function(x) sum(x)/7,fill=NA, align="right") )#Ave. 7days ago

#(8) vaccination
###Bundeslank level
vacc_BUND$vac_type <- as.factor(vacc_BUND$vac_type)
vacc_BUND$dose <- as.factor(vacc_BUND$dose)
levels(vacc_BUND$dose) <- c("1", "2","booster") # label dose 3 as booster
vacc_BUND$rep_date <- as.Date(vacc_BUND$rep_date)
vacc_BUND$maxvacdate <- max(vacc_BUND$rep_date)
vacc_BUND$vac_week <- as.integer((as.Date(vacc_BUND$rep_date)-as.Date("2020-01-01"))/7+1)

#revert week to date: . ##Wed (1/1/2020), Wed is the start of a week
vacc_BUND$vac_week_date <- lubridate::ymd( "2020-01-01" ) + lubridate::weeks(vacc_BUND$vac_week-1)# start at week 1 of the year

# County (lankreis) level
vacc_LK$dose <- as.factor(vacc_LK$dose)
levels(vacc_LK$dose) <- c("1", "2","booster") # label dose 3 as booster
vacc_LK$rep_date <- as.Date(vacc_LK$rep_date)
vacc_LK$maxvacdate <- max(vacc_LK$rep_date)
vacc_LK$vac_week <- as.integer((as.Date(vacc_LK$rep_date)-as.Date("2020-01-01"))/7+1)
#revert week to date: . ##Wed (1/1/2020), Wed is the start of a week
vacc_LK$vac_week_date <- lubridate::ymd( "2020-01-01" ) + lubridate::weeks(vacc_LK$vac_week-1)# start at week 1 of the year



```

## Underreporting

Ref: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8583384/
Seroprevalence study per wave:
 MUSPAD:5 study cite:
 - seroprevalence (<3%) until Mid-December 2020 in all regions.
 - 5.4% in February 2021
 - show proportions of infections detected by notifications to be 20 - 40% ( till 11/20)
 - infections detected by notifications increased to 40-50% (wave2)




```{r eval= FALSE, echo=FALSE}

#Wave1:
#MUSPAD study
##Aachen: 09/09-09/10/2020
study_seropos <- 0.023 #(2.3% [1.7-3.1])
wave1 <- dat %>% filter(rep_date <= as.Date("2020-10-09"))
report_ratio <- nrow(wave1)/NRW_pop
1-report_ratio/study_seropos # under report 81%

report_ratio <- 0.005 #0.5% of this this district only
1-report_ratio/study_seropos # under report 78.3%%

# other studies
## Blood sample in NRW: 9/3-3/6/2020
study_seropos <- 0.009 #(0.9% [0.5-1.4])
wave1 <- dat %>% filter(rep_date <= as.Date("2020-06-03"))
report_ratio <- nrow(wave1)/NRW_pop
1-report_ratio/study_seropos # under report 76%

## SeroDUS1, Dusseldorf: 2/11-23/11/2020
study_seropos <- 0.031 #(3.1% [2.4-4.0])
wave1 <- dat %>% filter(rep_date <= as.Date("2020-11-23"))
report_ratio <- nrow(wave1)/NRW_pop
1-report_ratio/study_seropos # under report 57%


#wave 12: Aachen 25/01/2021-27/02/2021:

study_seropos <- 0.054 #(5.4% [4.4-6.5])
wave12 <- dat %>% filter(rep_date <= as.Date("2021-02-27"))
report_ratio <- nrow(wave12)/NRW_pop
1-report_ratio/study_seropos # under report 45%


## Calculate under report in wave 2 only

wave1 <- dat %>% filter(rep_date <= as.Date("2020-10-09"))
wave1 <- nrow(wave1) # total case reported wave 1
wave12 <- dat %>% filter(rep_date <= as.Date("2021-02-27"))
wave12 <- nrow(wave12)# total case reported up to wave 2
wave2 <- wave12 - wave1# total case reported wave 2

report_w1 <- 0.22 # under_report 78%
report_w12 <- 0.55 # under_report45%
report_w2 <- wave2/(wave12/report_w12 - wave1/report_w1)

under_report_w2 <- 1- report_w2 # 25%






```


##add allage (new row)

A long week each agegroup, Allage (new row)is also added.

###date level

```{r}


#agegroup2
dummy <- pop_age %>%group_by(agegroup)%>% # agegroup or agrgroup2
  dplyr::summarise(pop_n =sum(pop_n))

# sum pop of all age
pop_age_all <- dummy %>%dplyr::summarise(pop_n =sum(pop_n))%>%
  ungroup()%>%
  mutate(agegroup = "allAge")
pop_age_all <- pop_age_all[,c(2,1)] #arrange col order for merging data later
pop_age_all <- rbind(dummy, pop_age_all) # add all age pop row

dat<- merge(dat, dummy, by="agegroup", all=T)# add nrw pop distribution by age


##sum cases of each agegroup by date
dat_date <- dat %>%
  group_by(rep_date,rep_week_date,rep_week,agegroup) %>%
  dplyr::summarise(case=n()) %>% #sum cases per date by age groups
  ungroup() 

## sum cases of all age by week
dat_allAge <- dat %>%
  group_by(rep_date,rep_week_date,rep_week) %>%
  dplyr::summarise(case=n()) %>% # sum cases per date in all age groups
  ungroup()%>%
  mutate(agegroup = "allAge")
dat_allAge <- dat_allAge[,c(1:3,5,4)] #arrange col order as in 'dat_date' for merging data later

dat_date <- rbind(dat_date, dat_allAge)# add cases of allAge


dat_date <- merge(dat_date,pop_age_all, by ="agegroup") # add pop to dat_date for weghing

# rolling average

dat_date <- dat_date %>%mutate(
      case_7da = zoo::rollmean(case, k = 7, fill = NA))


dat_date$case_per100k<- dat_date$case/dat_date$pop_n*100000


#division 0
dat_date$case_per100k_grouped <- cut(dat_date$case_per100k, breaks=c(-Inf, 5, 10, 15, 20, 35,50,100,150,200,300,Inf))
dat_date$case_per100k_grouped <- factor(dat_date$case_per100k_grouped, levels=c("(-Inf,5]", "(5,10]", "(10,15]", "(15,20]", "(20,35]", "(35,50]","(50,100]", "(100,150]", "(150,200]", "(200,300]", "(300, Inf]"),
                      labels=c("0-5",">5-10",">10-15", ">15-20", ">20-35", ">35-50", ">50-100", ">100-150",">150-200", ">200-300", ">300"), ordered=T)

##average case of 7 days ago
dat_date_dummy <- dat %>%
  group_by(rep_date,rep_week_date) %>%
  dplyr::summarise(case=n()) %>% # sum cases per date in all age groups
  ungroup()%>%
  mutate(case_ave_7day = rollapply(case,7,function(x) sum(x)/7,fill=NA, align="right"),
         case_7day = rollapply(case,7,function(x) sum(x),fill=NA, align="right"))#Ave. 7days ago

dat_date_dummy$case_per100k <- dat_date_dummy$case/NRW_pop*100000
dat_date_dummy$case_7day_per100k <- dat_date_dummy$case_7day/NRW_pop*100000


```


###week level


```{r}
##sum cases of each agegroup by week
dat_week <- dat %>%
  group_by(rep_week_date,rep_week,agegroup) %>%
  dplyr::summarise(case=n()) %>% #sum cases per week by age groups
  ungroup() 

## sum cases of all age by week
dat_allAge <- dat %>%
  group_by(rep_week_date,rep_week) %>%
  dplyr::summarise(case=n()) %>% # sum cases per week in all age groups
  ungroup()%>%
  mutate(agegroup = "allAge")

dat_allAge <- dat_allAge[,c(1,2,4,3)] #arrange col order as in 'dat_week' for merging data later

dat_week <- rbind(dat_week, dat_allAge)# add cases of allAge

dat_week <- merge(dat_week,pop_age_all, by ="agegroup") # add pop to dat_week for weighing

## hospitalisation
##sum cases of each agegroup by week
hosp_week <- dat %>%filter(hosp=="Ja")%>%
  group_by(rep_week_date,agegroup) %>%
  dplyr::summarise(hosp=n()) %>% #sum cases per week by age groups
  ungroup() 
## sum hosp cases of all age by week
hosp_allAge <- dat %>%filter(hosp=="Ja")%>%
  group_by(rep_week_date) %>%
  dplyr::summarise(hosp=n()) %>% # sum cases per week in all age groups
  ungroup()%>%
  mutate(agegroup = "allAge")

hosp_allAge <- hosp_allAge[,c(1,3,2)] #arrange col order as in 'hosp_week' for merging data later

hosp_week <- rbind(hosp_week, hosp_allAge)# add cases of allAge

dat_week <- merge(dat_week, hosp_week, by = c("rep_week_date", "agegroup"), all= T) # merge with case data



dat_week$case_per100k<- dat_week$case/dat_week$pop_n*100000
dat_week$hosp_per100k<- dat_week$hosp/dat_week$pop_n*100000


#categotise range of reported numbers
## cases
dat_week$case_per100k_grouped <- cut(dat_week$case_per100k, breaks=c(-Inf, 5, 10, 15, 20, 35,50,100,150,200,300,Inf))
dat_week$case_per100k_grouped <- factor(dat_week$case_per100k_grouped, levels=c("(-Inf,5]", "(5,10]", "(10,15]", "(15,20]", "(20,35]", "(35,50]", "(50,100]", "(100,150]", "(150,200]", "(200,300]", "(300, Inf]"),
                            labels=c("0-5",">5-10",">10-15", ">15-20", ">20-35", ">35-50", ">50-100", ">100-150", ">150-200", ">200-300", ">300"), ordered=T)
## hosp
dat_week$hosp_per100k_grouped <- cut(dat_week$hosp_per100k, breaks=c(-Inf, 5, 10, 15, 20, 25,30,35,40,45,50,Inf))
dat_week$hosp_per100k_grouped <- factor(dat_week$hosp_per100k_grouped, levels=c("(-Inf,5]", "(5,10]", "(10,15]", "(15,20]", "(20,25]", "(25,30]","(30,35]", "(35,40]", "(40,45]", "(45,50]", "(50, Inf]"),
                            labels=c("0-5",">5-10",">10-15", ">15-20", ">20-25", ">25-30",">30-35", ">35-40", ">40-45", ">45-50", ">50"), ordered=T)

dat_week$hosp_rate <- dat_week$hosp/dat_week$case

## Under report
dat_week$case_scaled <- NA

dat_week$case_scaled[dat_week$rep_week_date <= as.Date("2020-10-09")] <- ceiling(dat_week$case[dat_week$rep_week_date <= as.Date("2020-10-09")]/(1-u_report_w1))


dat_week$case_scaled[dat_week$rep_week_date > as.Date("2020-10-09")] <- ceiling(dat_week$case[dat_week$rep_week_date > as.Date("2020-10-09")]/(1-u_report_w2))

dat_week_dummy <- dat_week %>%
  filter(agegroup!="allAge")%>% # allAge is sum of all age group # duplicate data
  dplyr::select(rep_week_date,case,case_scaled)%>%
  group_by(rep_week_date)%>%
  summarise_if(is.numeric,sum) %>% #sum cases per week
  ungroup() 

dat_week_dummy$case_per100k <- dat_week_dummy$case/NRW_pop*100000
dat_week_dummy$case_scaled_per100k <- dat_week_dummy$case_scaled/NRW_pop*100000




```


##county level

Variant of concern (earliest sample [place]- designated VOC)

- Alpha (20.09.2020 [UK]-18.12.2020)  -> wave 1,....

- Beta (05.2020[South Africa] - 14.01.2021) -> wave 2,....

- Gamma (11.2020 [Brasil]- 15.01.2021) -> wave 2, ...

- Delta (10.2020 [India]- 6.5.2021) -> wave2, wave 3,...

- Omicron (9.11.2021 [ South Africa] - 26.11.2021) -> wave 3, wave 4...

* Source: https://en.wikipedia.org/wiki/Variants_of_SARS-CoV-2

```{r}


#group data by county and wave
## oJriginal data
dat_county <- dat %>% group_by(county) %>%
  dplyr::summarise(cases=n())%>%
  ungroup() 
dat_county_wave1 <- dat %>%filter(rep_date <= as.Date("2020-09-29")) %>% group_by(county) %>%
  dplyr::summarise(case_wave1=n())%>%
  ungroup() 
dat_county_wave2 <- dat %>%filter(rep_date >= as.Date("2020-09-30")&rep_date <= as.Date("2021-02-16")) %>% group_by(county) %>%
  dplyr::summarise(case_wave2=n())%>%
  ungroup() 
dat_county_wave3 <- dat %>%filter(rep_date >= as.Date("2021-02-24")&rep_date <= as.Date("2021-06-01")) %>% group_by(county) %>%
  dplyr::summarise(case_wave3=n())%>%
  ungroup() 
dat_county_wave4 <- dat %>%filter(rep_date >= as.Date("2021-07-28")&rep_date <= as.Date("2021-09-28")) %>% group_by(county) %>%
  dplyr::summarise(case_wave4=n())%>%
  ungroup()

# dat_county1 <- left_join (dat_county,dat_county_wave1,dat_county_wave2,dat_county_wave3,dat_county_wave4, by="county")
dat_county <- left_join (dat_county,dat_county_wave1)
dat_county <- left_join (dat_county,dat_county_wave2)
dat_county <- left_join (dat_county,dat_county_wave3)
dat_county <- left_join (dat_county,dat_county_wave4)

rm(dat_county_wave1,dat_county_wave2,dat_county_wave3,dat_county_wave4)

# add GISD data
dat_county <- merge(dat_county, gisd %>%dplyr::select(county,GISD_5,pop), by = "county")

# duration each wave
duration_w1<- 30
duration_w2<- 20
duration_w3<- 14
duration_w4<- 09

dat_county <- dat_county%>%
  mutate(case_perwk_100k_w1 = case_wave1/duration_w1/pop*100000,
         case_perwk_100k_w2 = case_wave2/duration_w2/pop*100000,
         case_perwk_100k_w3 = case_wave3/duration_w3/pop*100000,
         case_perwk_100k_w4 = case_wave4/duration_w4/pop*100000)

dat_county <- dat_county %>% dplyr::select (-c("pop"))# avoid duplicated later

dat_county <- merge(dat_county,nuts3, by = "county")



```

# NRW pop distribution {.tabset}

## By age

```{r}
# pop distribution by age 
  
pop_age %>%
  ggplot(aes(x = agegroup, y= pop_n/1000)) +  # unit: thousand
  geom_bar(stat="identity", fill = " dark blue")+
  # facet_grid(row = vars(agegroup))+
  # scale_y_continuous(labels = scales::percent_format()) +
  # scale_fill_manual(values=palette1, name="Age group") +
  labs(y = "Number of inhabitants [thousand]") +
  ggtitle("NRW_ pop distribution")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```
 
## By county

```{r}

# pop distribution by county
nuts3%>%
  ggplot(aes(x = county, y= pop_n/1000)) +  # unit: thousand
  geom_bar(stat="identity", fill = " dark blue")+
  labs(y = "Number of inhabitants [thousand]") +
  ggtitle("NRW_ pop distribution")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))



```

## Pop. density

```{r}
# pop density

nuts3%>%
  ggplot(aes(x = county, y= pop_n/area_sq_km)) +  # unit: thousand
  geom_bar(stat="identity", fill = " dark blue")+
  labs(y = "Number of inhabitants/sq km") +
  ggtitle("NRW_ pop density distribution")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))


```


# COVID-19 over time 

## Heatmap: by age

### Case

There is a shift in age structure among COVID-19 infections, _especially since wave 4._

```{r}
dat_week %>% 
  filter(!is.na(agegroup)) %>%
  ggplot(aes(rep_week_date, agegroup)) +
  geom_tile(aes(fill=case_per100k_grouped), colour = "black")+
  geom_text(aes(label = round(case_per100k)), size = 2, colour = "#585858") + #size of number in each cell
  #division 0
  scale_fill_manual(values=c("#FFF7FC","#EDE7F3", "#D0D1E6", "#A6BDDC", "#74AAD0",
                             "#3691C0", "#0470B0", "#044E7B", "#333F50", "#404040", "#262626")) +
  ## division 1,2,3
  # scale_fill_brewer(palette = "Blues")+ #BuPu, BuGn, Blues, Oranges,Reds,....
  labs(fill = "incidence \n(per 100k)", x="")+
  ggtitle("NRW_ weekly COVID-19 Incidence per 100k 
")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=18, hjust=0.5),
        axis.text.x = element_text(size = 10,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 10, face = "bold")) + 
  scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0)) +
  # scale_x_continuous(expand=c(0,0)) +
  scale_y_discrete(expand=c(0,0))


# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```


###Hosp

```{r}
dat_week %>%
  ggplot(aes(rep_week_date, agegroup)) +
  geom_tile(aes(fill=hosp_per100k_grouped), colour = "black")+
  geom_text(aes(label = round(hosp_per100k)), size = 2, colour = "#585858") + #size of number in each cell
  #division 0
  scale_fill_manual(values=c("#FFF7FC","#EDE7F3", "#D0D1E6", "#A6BDDC", "#74AAD0",
                             "#3691C0", "#0470B0", "#044E7B", "#333F50", "#404040", "#262626")) +
  ## division 1,2,3
  # scale_fill_brewer(palette = "Blues")+ #BuPu, BuGn, Blues, Oranges,Reds,....
  labs(fill = "incidence \n(per 100k)", x="")+
  ggtitle("NRW_ weekly COVID-19 hospitalised incidence per 100k
")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=15, hjust=0.5),
        axis.text.x = element_text(size = 10,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 10, face = "bold")) +
 scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0)) +
  # scale_x_continuous(expand=c(0,0)) +
  scale_y_discrete(expand=c(0,0))

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

## Histogram: by age
### Case

```{r}

#create data structure for histogram
#case prop_all age group################################
# dat_dm<- merge(dat, pop_age, by="agegroup2", all=T)# add nrw pop distribution by age
histo_setup <- dat%>%
  group_by(rep_week,rep_week_date, agegroup2) %>% dplyr::summarise(case_n=n()) 
# histo_setup$maxrepweek <- max(histo_setup$rep_week)


dat%>%
  group_by(rep_week,rep_week_date, agegroup2) %>% dplyr::summarise(case_n=n())%>%
  ggplot(aes(x=rep_week_date, y=case_n, fill=agegroup2)) + 
  geom_bar(position="fill", stat="identity")+
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values=palette, name="Age group") +
   labs(y="Propotion of reported case",x=" ")+
  ggtitle(" Covid-19 Incidence in NRW_ weekly report")+
 scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0)) +
theme(axis.text.x = element_text(colour = "black", size = 10,
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))



# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

### Hosp

```{r}

dat%>%filter(hosp=="Ja")%>%
  group_by(rep_week,rep_week_date, agegroup,pop_n) %>% dplyr::summarise(case_n=n())%>%
  ggplot(aes(x=rep_week_date, y=case_n, fill=agegroup)) + 
  geom_bar(position="fill", stat="identity")+
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values=palette, name="Age group") +
   labs(y="Propotion of reported case",x=" ")+
  ggtitle(" Hospitalisation attributed to COVID-19 in NRW_weekly report")+
 scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0)) +
theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))


# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

### hospitalised rate in each age group

Is there a shift of hospitalisations:


```{r}


# stacked area chart
 dat_week %>%
  filter(agegroup!="allAge")%>% # allAge is sum of all age group # duplicate data
ggplot(aes(x=rep_week_date, y=hosp_rate, color=agegroup, group=agegroup)) + 
  geom_line()+
  # scale_fill_manual(values=c("#d7191c", "#fdae61", "#abdda4", "#2b83ba"), name="Vaccine Type")+
  # scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
  #              limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
  #              expand = c(0, 0)) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0))+
  labs(x = " ", y = " ") +
  ggtitle("Hospitalised rate attributed to Covid-19 in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = "right",
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



```


## Line graph {.tabset}
### Case

```{r}

# each county in NRW

# county_name  = unique(dat$county)
# plot_list <- list()
# 
# ## loop for ploting
# for (i in (1: length(county_name))){
#   i=4
#   kreis = county_name[i]
#   
#   dummy <- dat%>% # summary incidence of a county
#   filter(county == kreis)%>%
#   group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
#   mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))
#   
#   kreis_pop <- dat_county%>% # pop of a county
#          filter(county == kreis)
#   
#   dummy$pop <- kreis_pop$pop
#   
#  p <- dummy%>%
#   ggplot(aes(x=rep_date))+
#   geom_line(aes(y=case_n/pop*100000, colour = "case_n"), size=1) +
#   geom_line(aes(y=case_mean7da/pop*100000,colour = "case_mean7da"), size=1) +
#   scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
#                limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
#                expand = c(0,0)) +
#   labs(x = " ", y = "Confirmed number per 100k") +
#   ylim(0,100)+
#   scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
#                      labels = c("Raw Incidence",
#                                 "Rolling ave.7days"))+
#   # ylim(0,8500)+
#   ggtitle(paste0("COVID-19 Incidence in ",kreis,"_ daily report"))+
#   theme_classic()+
#   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
#         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
#         axis.title = element_text(colour = "black", size = 15, face = "bold"),
#         legend.background = element_blank(),
#         legend.key = element_blank(),
#         legend.position = c(0.12,0.8),
#         legend.text = element_text(colour = "black", size = 15),
#         legend.title = element_text(colour = "black", size = 16, face = "bold"),
#         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
#         strip.text = element_text(colour = "black", size = 10, face = "bold"))
#   
#   plot_list[[i]] = p # store plot into list
#   ggsave(paste0(path_result,"/COVID_19/incidence_pattern_county/incidence_",kreis,".png"),p, width=14, height=7)
# 
# }


## NRW
panel_case <- dat%>%
  group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))%>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case_n/NRW_pop*100000, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da/NRW_pop*100000,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number per 100k") +
  scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                     labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Incidence in NRW_ daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

panel_case 


## visualize reported case in Germany
ger <- germany%>%
  filter(rep_date <= as.Date("2022-01-01"))%>%
  select(rep_date, case_n) %>% 
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))%>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case_n/DE_pop*100000, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da/DE_pop*100000,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
                limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number per 100k") +
  scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                     labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Incidence in Germany_ daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

ger
# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

### Hosp


```{r eval=F,results='hide'}

# Weighing for pop
dummy <- dat%>%filter(hosp=="Ja")%>%
  group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))

dummy %>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case_n, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number.") +
   scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                      labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
   ylim(0,800.0)+
  ggtitle("COVID-19 hospitalisation in NRW_ daily report")+
  theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position = c(0.12,0.8),
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))



# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

### ICU
* This data from **211229 NRW dateninput modellierungen wwu** 

The earliest time is **06.04.2020**  while the line list's **19.02.2020**

Is normal mean non_hospitalization ? 

ICU = intensive + ventilation ??

```{r}
colnames(hosp)

hosp_melt <- melt(hosp, id.vars = c(1,6:8)) # id.vars indicate variables that you don't want to melt

# Hospitalisation (all) 
hosp_melt%>%
  ggplot()+
  geom_line(aes(y=value, x=rep_date,color=variable)) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number", color="") +
  ylim(0,8000)+
  ggtitle("Hospitalisation attributed to COVID-19 in NRW_prevalence")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


#Hospitalisation ( ICU = ventilation +intensive )
hosp_melt <-  hosp%>%
  group_by(rep_date,total, normal,intensive, ventilation) %>% dplyr::summarise(ICU =  sum(intensive,ventilation)) #count case by date
hosp_melt <- melt(hosp_melt, id.vars = "rep_date") # id.vars indicate variables that you don't want to melt
#
panel_hosp <- hosp_melt%>%filter(variable!="intensive" &variable!="ventilation" )%>% # included in ICU
  ggplot()+
  geom_line(aes(y=value, x=rep_date,color=variable)) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number", color="") +
  ylim(0,8000)+
  ggtitle("Hospitalisation attributed to COVID-19 in NRW_daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



#ICU : intensive + ventilation ???
panel_ICU <-  hosp%>%
  group_by(rep_date) %>% dplyr::summarise(ICU= sum(intensive,ventilation))%>% #count case by date
  ggplot()+
  geom_line(aes(y=ICU, x=rep_date), size=1, colour="blue") +
   scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number") +
   ylim(0,2000)+
  ggtitle("Hospitalisation (ICU) attributed to COVID-19 in NRW_daily reportin NRW_ daily")+
  theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position ="right",
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))


  

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

### panel:

These two graphs are generated from two different data sets. The line list has to be calibrated for under-reporting! 

Is there any more reliable incidence report?  

```{r}
# multiple plots in the same page 
panel <- ggarrange(panel_case +rremove("x.text")+rremove("y.title"), 
          panel_hosp +rremove("y.title"),
          labels = c("A", "B"),
          ncol = 1, nrow = 2)

annotate_figure(panel, 
                left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
           

# # 
# panel <- ggarrange(panel_case +rremove("x.text")+rremove("y.title"), 
#           panel_hosp +rremove("x.text")+rremove("y.title"),
#           panel_ICU+rremove("y.title"),
#           labels = c("A", "B", "C"),
#           ncol = 1, nrow = 3)
# 
# annotate_figure(panel, 
#                 left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
               

```
 
### panel2
check the data with other resource: i.e: rki
#### line
 
```{r}
dummy <- dat_week %>%
  # filter(agegroup!="allAge")%>% # rm allAge to avoid duplicated data
  group_by(rep_week_date)%>%
  mutate_each(funs(replace(., is.na(.), 0)))%>% # NAs is aummed 0 cases
  summarise_if(is.numeric,sum)
  
  dummy %>%
  ggplot(aes(x=rep_week_date))+
  geom_line(aes(y=case/NRW_pop*100000, colour = "case"), size=1) +
  geom_line(aes(y=hosp/NRW_pop*1000000, colour = "hosp"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number") +
  scale_color_manual(name = "", values = c("case"="blue","hosp"="red"),
                     labels = c("Case per 100k",
                                "Hospitalised per 1M"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Inc.&hosp in NRW_ weekly report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

# compare with other data sources
dummy <- dat_week %>% 
  filter(agegroup!="allAge")%>% # rm allAge to avoid duplicated data
  group_by(rep_week_date)%>%
  summarise_if(is.numeric,sum,na.rm = T)

# add case/death from rki
dummy_rki <- dat_rki %>% 
  dplyr::select(rep_week_date,case,death,recover)%>% # 
  group_by(rep_week_date)%>%
  summarise_if(is.numeric,sum) # sum by week
colnames(dummy_rki) <- c("rep_week_date","case_rki","death_rki","recover_rki")
  
#add hosp data from another source
dummy_hosp <- hosp%>%group_by(rep_week_date)%>%dplyr::select(-c(rep_week,maxrepweek))%>%
  summarise_if(is.numeric,sum)

dummy <- merge(dummy,dummy_rki, by = c("rep_week_date"), all=T)
dummy <- merge(dummy,dummy_hosp, by = c("rep_week_date"), all=T)

rm(dummy_hosp,dummy_rki)

dummy$ICU <- dummy$intensive +dummy$ventilation # ICU


# sumdata is not new incidence
dummy %>%
 ggplot(aes(x=rep_week_date))+
  geom_line(aes(y=case, colour = "case"), size=1) +
  geom_line(aes(y=case_scaled, colour = "case_scaled"), size=1) +
  geom_line(aes(y=hosp, colour = "hosp"), size=1) +
  geom_line(aes(y=total, colour = "total"), size=1) +
  geom_line(aes(y=ICU, colour = "ICU"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number") +
  scale_color_manual(name = "", values = c("case"="blue","case_scaled" ="grey","hosp"="red", "total"="orange", "ICU" = "pink"),
                     labels = c("Case_linelist",
                                "Case_scaled_linelist",
                                "Hospitalised_linelist",
                               " Hospitalised_sumdataset",
                                "ICU_sumdataset"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 in NRW_ weekly report [linelist vs. sumdata")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.18,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))
 

## linelist data is in line with rki
dummy %>%
 ggplot(aes(x=rep_week_date))+
  geom_line(aes(y=case, colour = "case"), size=1) +
  geom_line(aes(y=hosp, colour = "hosp"), size=1) +
  geom_point(aes(y=case_rki, colour = "case_rki"), size=2) +
  geom_line(aes(y=death_rki, colour = "death_rki"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number") +
  scale_color_manual(name = "", values = c("case"="blue","hosp"="red", "case_rki"="black","death_rki" = "orange"),
                     labels = c("Case_linelist",
                                "Hospitalised_linelist",
                                "case_rki",
                                "death_rki"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 in NRW_ weekly report [linelist vs RKI]")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))
 


```

#### stacked

```{r stacked area chart }
#################################################
# confirm case overtime ##
################################################
dummy <- dat %>%
  group_by(rep_week_date,agegroup2) %>%
  dplyr::summarise(case=n())#sum cases per week by age groups
  
dummy <- merge(dummy,pop_age%>%group_by(agegroup2)%>%dplyr::summarise(pop_n=sum(pop_n)), by = "agegroup2")
palette <- c("#08519c","#3182bd","#6baed6","#9ecae1","#c6dbef","#eff3ff" )

dummy1 <- dat%>% # to add daily report number
  group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))


# dummy %>%  
p1 <- ggplot() + 
  geom_area(data=dummy,aes(x=rep_week_date, y=case/pop_n*100000, fill=agegroup2))+
  geom_line(data=dummy1,aes(x = rep_date,y=case_mean7da/4,color="case_mean7da"), size=1) +
  # geom_line(data=dummy1,aes(x = rep_date,y=case_n/2,color="case_n"), size=1) +

  scale_y_continuous(sec.axis = sec_axis(breaks=seq(0,2000,by= 500),labels = seq(0,8000,by=2000),~ . *1, name = "Dailly confirmed infections"))+
  scale_color_manual(name = "Daily report", values = c("case_mean7da"="red"),
                     labels = c("Rolling ave.7days"))+
  # scale_fill_manual(values=palette, name="Age group",)+
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  # ylim(0,60)+
  labs(x = " ", y = "Weekly confirmed cases per 100k",fill = " Age group") +
  ggtitle("Covid-19 incidence in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.18,0.61),
        legend.text = element_text(colour = "black", size = 8),
        legend.title = element_text(colour = "black", size = 12, face = "bold"),
        plot.title = element_text(colour = "black", size = 20, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


############################################
#hosp and vaccination over time ############
############################################

#cum vac over time 

vac_alltype1 <- vacc_BUND %>%filter(dose==1)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype1 <- vac_alltype1 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype1$vac_n_cum <- cumsum(vac_alltype1$vac_n)
vac_alltype1$dose <- 1

vac_alltype2 <- vacc_BUND %>%filter(dose==2)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype2 <- vac_alltype2 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype2$vac_n_cum <- cumsum(vac_alltype2$vac_n)
vac_alltype2$dose <- 2

vac_alltype3 <- vacc_BUND %>%filter(dose=="booster")%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype3 <- vac_alltype3%>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype3$vac_n_cum <- cumsum(vac_alltype3$vac_n)
vac_alltype3$dose <- "booster"

vac_alltype <- rbind(vac_alltype1,vac_alltype2,vac_alltype3)
rm(vac_alltype1,vac_alltype2,vac_alltype3)

dummy <- melt(hosp, id.vars = c(1:2,6:8)) # 
# dummy %>%  
p2 <- ggplot() + 
  geom_area(data=dummy, aes(x=rep_date, y=value, fill=variable))+
  geom_line(data=vac_alltype,aes(x = rep_date,y=vac_n_cum/NRW_pop_vacc*100*60, color = dose),size=2)+
  scale_y_continuous(sec.axis = sec_axis(breaks=seq(0,600,by= 120),labels = seq(0,100,by=20),~ . *6/60, name = "Accumulative vaccination (%) "))+
    scale_fill_manual(values=c("#084081", "#2b8cbe", "#7bccc4"), name="Hospitalised status")+
     scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  labs(x = " ", y = "Daily numbers") +
  ggtitle("Hospitalised stay attributed to Covid-19 in NRW")+
  # facet_wrap(~ hosp)+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.2,0.61),
        legend.text = element_text(colour = "black", size = 8),
        legend.title = element_text(colour = "black", size = 12, face = "bold"),
        plot.title = element_text(colour = "black", size = 20, face = "bold",hjust = 0.5),
  
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

########################################
# combine 2 plots into panel 
########################################

# multiple plots in the same page 
panel <- ggarrange(p1 +rremove("x.text"), 
          p2 ,
          labels = c("A", "B"),
          ncol = 1, nrow = 2)

annotate_figure(panel, 
                left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
           


```

# SES 

* NRW social economic status
ref: https://github.com/lekroll/GISD

In order to be able to map regional differences in socioeconomic status, the German Index of Social Deprivation is used (Kroll et al. 2018, p. 105).
The index is composed of the three equally weighted dimensions of education, occupation and income.
The data underlying the dimensions are provided by the Indicators and Maps of Spatial and Urban Development (INKAR) database of the Federal Institute for Research on Building, Urban Affairs and Spatial Development (Bundesinstitut für Bau-, Stadt- und Raumforschung 2020 /

https://www.bbsr.bund.de/BBSR/EN/home/_node.html;jsessionid=5D48C9E3CCEE2DF7D9A30B3C58D7986E.live21324).
Indicators were selected which were available as time series from 1998 to 2012 (in the current version of the index used here, until 2014). If this was not the case, the missing values of the respective variables were imputed using regression analyses.

```{r}

#GISD5
legend_label=c("1", "2", "3","4","5")

panel_gisd5 <- tm_shape(gisd) +
  tm_fill("GISD_5", palette = "Blues", legend.show = F) + #
  tm_borders("black") +
  tm_add_legend(title = "Deprivation index", labels = legend_label, col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = "Social econmic status", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# panel_gisd5 

# pop
panel_pop <- tm_shape(gisd) +
  tm_fill("pop", palette = "Blues", legend.show = T) + #
  tm_borders("black") +
  # tm_add_legend(title = "Deprivation index", col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = "Pop distribution \n in NRW", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
 
# multiple plots in the same page 
current.mode <- tmap_mode("plot")
tmap_arrange(panel_gisd5,panel_pop, widths = c(0.5, 0.5))
tmap_mode(current.mode)

```


# Mapping


At the start, the incidences are still small. The incidence grouping should also be small to see the difference among counties. So the color visualization is to compare within the wave. However, from wave two onward, the scale is similar.  

For across waves comparison, please notice the legend!

Testing volumes may have been insufficient early in the pandemic.

Average case per week in each wave may be more comparable due to different length in each wave. 


##Wave1

```{r}
title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"



nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave1","pop_n")%>%
  mutate(incper10k = case_wave1/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,10,15,20,25,30,35,40,45,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")


#copy abow where appropriate
legend_label=c("0-10",">10-15",">15-20", ">20-25", ">25-30", ">30-35", ">35-40", ">40-45",">45")

w1 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Purples", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

# w1

# continuous scale
w1c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave1", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")


```

##Wave 2

```{r}

# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"




nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave2","pop_n")%>%
  mutate(incper10k = case_wave2/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

w2 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w2


# continuous scale
w2c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave2", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

```

##Wave 3 

```{r}
# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"



nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave3","pop_n")%>%
  mutate(incper10k = case_wave3/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

w3 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w3
# continuous scale
w3c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave3", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")


```

##Wave 4 

```{r}
# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
title <-"COVID-19 reported_W4\n 13.07-29.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"

wave <- dat_county %>% select("NUTS_ID", "case_wave4","pop_n")
wave$incper10000<- wave$case_wave4/wave$pop_n*10000





nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave4","pop_n")%>%
  mutate(incper10k = case_wave4/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

w4 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w4
# continuous scale
w4c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave4", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")


```

##entire pandamic and 4 waves

Criteria for defining a wave?

```{r}
# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
title <-"COVID-19 reported_4waves\n 27.02.20-29.12.21"


nuts3_case <- dat_county %>%select("NUTS_ID", "cases","pop_n")%>%
  mutate(incper10k = cases/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,550,600,650,700,750,800,850,900,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c(">450-550", ">550-600",">600-650", ">650-700",">700-750", ">750-800", ">800-850", ">850-900",">900")

w_all <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Oranges", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Oranges")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w_all



# multiple plots in the same page 
current.mode <- tmap_mode("plot")
tmap_arrange(panel_gisd5,w_all, widths = c(0.5, 0.5))
tmap_mode(current.mode)


```


```{r}

# # multiple plots in the same page 
# ggpubr:: ggarrange(tmap_grob(w1), # tmap_grob: convert tmap into grob
#                    tmap_grob(w2),
#                    tmap_grob(w3),
#                    tmap_grob(w4),
#                    # labels = c("A", "B"),
#                    ncol = 2, nrow = 2)

current.mode <- tmap_mode("plot")
tmap_arrange(w1, w2, w3, w4, widths = c(0.5, 0.5))
tmap_mode(current.mode)

# absolute number
current.mode <- tmap_mode("plot")
tmap_arrange(w1c, w2c, w3c, w4c, widths = c(0.5, 0.5))
tmap_mode(current.mode)


```


# Heatmap: by county


## Group scale 

```{r}

# data at week level 
dat_week <- dat %>%group_by(rep_week_date,county)%>% summarise(case =  n())
dat_week <- merge(dat_week, gisd %>%select(county,pop_n, GISD_5), by = "county")
dat_week$case_per100k<- dat_week$case/dat_week$pop_n*100000

#division 0
# dat_week$case_per100k_grouped <- cut(dat_week$case_per100k, breaks=c(-Inf, 5, 10, 15, 20,25,100,200,300,400,Inf))
dat_week$case_per100k_grouped <- cut(dat_week$case_per100k, breaks=c(-Inf, 25, 50, 75, 100,150,200,250,300,350,400,Inf))




# #label
legend_label=c("0-25", ">25-50", ">50-75",">75-100", ">100-150", ">150-200",">200-250", ">250-300",">300-350", ">350-400", ">400")

dat_week %>%
  ggplot(aes(rep_week_date,county)) +
  geom_tile(aes(fill=case_per100k_grouped ), colour = "black")+
  geom_text(aes(label = round(case_per100k )), size = 1, colour = "#585858") + #size of number in each cell
  #division 0
  scale_fill_manual(values=c("#FFF7FC","#EDE7F3", "#D0D1E6", "#A6BDDC", "#74AAD0",
                             "#3691C0", "#0470B0", "#044E7B", "#333F50", "#404040", "#262626"),
                    label = legend_label) +
  ## division 1,2,3
  # scale_fill_brewer(palette = "Blues")+ #BuPu, BuGn, Blues, Oranges,Reds,....
  labs(fill = "incidence \n(per 100k)", x="", y="")+
  ggtitle("NRW_ weekly COVID-19 Incidence per 100k ")+
  # facet_wrap(~GISD_5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=18, hjust=0.5),
        axis.text.x = element_text(size = 8,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 8, face = "bold")) + 
  scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0)) +
  # scale_x_continuous(expand=c(0,0)) +
  scale_y_discrete(expand=c(0,0))



```

## Continuous scale

```{r}


# continues scale
ggplot(dat_week, aes(rep_week_date, county)) +
  geom_tile(aes(fill = case_per100k)) +
  # coord_equal() +
  # ggtitle(paste0("Wave ", wave_n)) +
  # geom_text(aes(label=sprintf("%0.1f", round(case_per100k, digits = 2))), size = 2) +
  scale_fill_gradient2(low = "white",
                       # mid = "white",
                       high = "blue", limits = c(0,600), midpoint = 12) +
  guides(fill = guide_colourbar(barwidth = 0.5,
                                 barheight = 5, title = "Incidence \n(per100k)")) +
 scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0))+
  # scale_x_date(breaks = unique(dat_week$rep_week_date))+ # display all dates on x axis
   ggtitle("NRW_ weekly COVID-19 Incidence per 100k ")+
  theme(legend.position = "right")+
  theme(plot.title = element_text(size = 10, face = "bold",hjust = 0.5),
        axis.title = element_blank(),
        axis.text.x = element_text(size = 6, face = "bold",angle = 30, vjust = 0.5),
        axis.text.y = element_text(size = 8, face = "bold"),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm"), # reduce space for combination plot later

                panel.background = element_blank())


```

## Add SES annotation

COVID-19 incidence in each county over time vs social economic status
### by week

```{r}

# Heat map with deprivation index (GISD) annotation
dat_week_long <- dat_week %>% select(GISD_5,county,rep_week_date,case_per100k)
dat_week_long <- dat_week_long[order(dat_week_long$rep_week_date),] # sort data by time report

dat_week_long <- dat_week_long %>%
  pivot_wider(names_from = rep_week_date, values_from = case_per100k)#Transposing row values to colum
dat_week_long <- dat_week_long[order(dat_week_long$GISD_5),] # sort data by GISD

#annotation set
label_gisd <- dat_week_long %>% select(county,GISD_5)# prepare for anotation heatmap
rownames(label_gisd ) <- label_gisd$county
label_gisd <- as.data.frame(label_gisd)
label_gisd$GISD_5 <- as.character(label_gisd$GISD_5)
label_gisd <- label_gisd[,-1, drop=F] # avoid row name disappear
colnames(label_gisd) <- c("Deprivation_index")

dat_week_long <- dat_week_long[,-1]# rm GISD
rownames(dat_week_long) <- dat_week_long$county # convert county into rownames
dat_week_long <- as.data.frame((dat_week_long )) # matrix for heatmap
dat_week_long <- dat_week_long [,-1, drop=F]  # avoid row name disappear

annotation_colors = list(
 Deprivation_index = c("1"="#9e9ac8","2"="#807dba","3"="#6a51a3","4"="#54278f","5"="#3f007d"))

pheatmap(dat_week_long,cluster_rows = F, cluster_cols = F,RColorBrewer::brewer.pal(name = "Blues", n =9), annotation_row = label_gisd,
         annotation_colors= annotation_colors,annotation_names_row=F,
           fontsize = 10,fontsize_row =7,fontsize_col = 6, legend_breaks = c(100, 200, 300, 400,500),
         main = "NRW_ weekly COVID-19 Incidence per 100k ", legend_labels = c("100", "200", "300", "400","500"), legend = T,)



# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

### by wave

The average number of case per week in each wave

```{r}

# Heat map with deprivation index (GISD) annotation
dat_county_long <- dat_county %>% select(GISD_5,county,contains("perwk"))

dat_county_long <- dat_county_long[order(dat_county_long$GISD_5),] # sort data by GISD index
#annotation set
label_gisd <- dat_county_long %>% select(county,GISD_5)# prepare for anotation heatmap
rownames(label_gisd ) <- label_gisd$county
label_gisd <- as.data.frame(label_gisd)
label_gisd$GISD_5 <- as.character(label_gisd$GISD_5)
label_gisd <- label_gisd[,-1, drop=F] # avoid row name disappear
colnames(label_gisd) <- c("Deprivation_index")

dat_county_long <- dat_county_long[,-1]# rm GISD
rownames(dat_county_long) <- dat_county_long$county # convert county into rownames
dat_county_long <- as.data.frame((dat_county_long )) # matrix for heatmap
dat_county_long <- dat_county_long [,-1, drop=F]  # avoid row name disappear
colnames(dat_county_long) <- c("wave1","wave2", "wave3", "wave4") # rename cols
annotation_colors = list(
 Deprivation_index = c("1"="#9e9ac8","2"="#807dba","3"="#6a51a3","4"="#54278f","5"="#3f007d"))

pheatmap(dat_county_long,cluster_rows = F, cluster_cols = F,RColorBrewer::brewer.pal(name = "Blues", n =9), annotation_row = label_gisd,
         annotation_colors= annotation_colors,annotation_names_row=F,
        fontsize = 10,fontsize_row =7,fontsize_col = 6,
        # legend_breaks = c(100, 200, 300, 400,500),
        main = "Average infections per week per 100k inhatbitants", 
        # legend_labels = c("100", "200", "300", "400","500"), 
        legend = T, angle_col = 0)



# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

# Regulation

## NRW level

```{r}
p <- reg_bund %>%
  ggplot(aes(date,m_code)) +
  geom_tile(aes(fill=measure_imp ))+
  scale_fill_manual(values=c("#ffffbf","#fc8d59"),
                    label = c("No","Yes")) +
  labs(fill = "Measure \n implement", x="", y="Measures")+
  ggtitle("Measures against spreading of COVID-19 in NRW")+
  # facet_wrap(~GISD_5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=18, hjust=0.5),
        axis.text.x = element_text(size = 8,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 8, face = "bold")) + 
  scale_x_date(date_labels="%Y-%m-%m", date_breaks = "21 days",expand = c(0, 0)) +
  scale_y_discrete(expand=c(0,0))

p
ggsave(paste0(path_result,"/regulations/regulation_NRW.png"),p)

```
 
##County level

```{r}

# # for loop measures at 53 counties in NRW
# kreis_ls <- unique(reg_lk$kreis)
# plot_list <- list() # for storing each loop cycle result
# 
# for( i in (1:length(kreis_ls))){
# kreis = kreis_ls[i]
# reg <- reg_lk %>% filter(kreis == kreis_ls[i])
# reg <- reg %>% select(-c(ags2, bundesland, ags5,kreis))
# 
# reg<- pivot_longer(reg, cols=2:dim(reg)[2], names_to = "date", values_to = "measure_imp") # transpose from cols to rows
# reg$date <- gsub("^.{0,1}", "", reg$date)# Replace first character () with empty string ""
# reg$date <- as.Date(reg$date , format="%Y%m%d")
# reg$measure_imp <- as.factor(reg$measure_imp)
# 
#  p <- reg%>%
#   ggplot(aes(date,m_code)) +
#   geom_tile(aes(fill=measure_imp ))+
#   scale_fill_manual(values=c("#ffffbf","#fc8d59"),
#                     label = c("No","Yes")) +
#   labs(fill = "Measure \n implement", x="", y=" Measures")+
#   ggtitle(paste0("Measures against spreading of COVID-19 in ", kreis))+
#   # facet_wrap(~GISD_5)+
#   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#         panel.background = element_blank(), axis.line = element_line(colour = "black"),
#         legend.position="right",
#         legend.title=element_text(size=18, colour = "black", face = "bold") ,
#         legend.text=element_text(size=17, colour = "black"),
#         axis.title = element_text(size=18, face="bold", colour = "black"),
#         plot.title = element_text(face="bold", size=18, hjust=0.5),
#         axis.text.x = element_text(size = 8,  hjust = 1, colour = "black", angle = 30, face = "bold"),
#         axis.text.y = element_text(size = 8, face = "bold")) + 
#   scale_x_date(date_labels="%Y-%m-%m", date_breaks = "21 days",expand = c(0, 0)) +
#   scale_y_discrete(expand=c(0,0))
# 
# plot_list[[i]] <- p # store plots in the list
# ggsave(paste0(path_result,"/regulations/regulation_",kreis,".png"),p)
# }

```

