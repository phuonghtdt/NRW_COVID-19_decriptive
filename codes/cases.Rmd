---
title: "COVID-19 in NRW"
author: "Thi Phuong Huynh"
date: "2/7/2022"
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true # able of contents to the left, visible even when the document is scrolled
---

# Set up

Date: <b>`r format(Sys.Date(), "%B %d, %Y")`</b>

All computations were performed with `r R.Version()$version.string`.

To be commit:


```{r setup, include=FALSE}

rm(list = ls())
knitr::opts_chunk$set(fig.retina = 1, fig.height = 7, fig.width = 14,
                      echo = FALSE, message = FALSE, warning = FALSE,
                      results='hide')
Sys.setlocale("LC_TIME", "C")
BEGIN_RMD <- Sys.time()# Keeping track of running time
options(warn = 1) # If warn is one, warnings are printed as they occur.

#Loading package
library(reshape2, ggplot2)
library('ggplot2')
library('scales')
library(tidyverse)
library(surveillance)
library(lubridate)
library(broom)
library(runjags)
# library(rjags) check !
library(EpiEstim)
library(incidence)
library(epitools)
library(zoo) # rolling average
library(readxl)
library(ggpubr) # ggarrange
library(grid)

library(extrafont) 


library(sf) # for reading shape files into R
library(tmap)#for creating the map
library(dplyr)
library(ggpubr) #ggarrange
library(pheatmap)

library(table1)

path_data <- paste0("C:/Users/huynh/sciebo/NRW_descriptive/data")
path_data_code <- paste0("C:/Users/huynh/sciebo/NRW_descriptive/gitHub/NRW_COVID-19_decriptive/codes/data_codes")
path_result <- paste0("C:/Users/huynh/sciebo/NRW_descriptive/results")

```

#changeable variable

```{r}

#pop
NRW_pop <- 17925570
NRW_under12 <- 2014762
NRW_pop_vacc <- NRW_pop - NRW_under12
DE_pop <- 83155031 # ref: 2020#https://www-genesis.destatis.de# code: 12411


start_day <- as.Date("2020-02-27")# data before this day won't be counted
current_date <-as.Date("2021-12-29") # data is available up to this date

#Under report ??
u_report_w1 <- 0.75
u_report_w2 <- 0.25
cutoff_day <- as.Date("2020-10-09") # cutoff day bwt 2 scale
# pop(https://www.destatis.de/DE/Home/_inhalt.html)
#ref map: https://www.mags.nrw/matchingberater-karte
#NRW pop. by county: http://www.citypopulation.de/en/germany/cities/nordrheinwestfalen/
#NRW pop. by county( original from destatis): https://www-genesis.destatis.de/genesis/online?sequenz=statistikTabellen&selectionname=12411&language=en#abreadcrumb

colfunc <- colorRampPalette(c("black", "white"))
colfunc(19)
palette <- c("red","#003366", "olivedrab3","#336699", "#CCFFFF", "#028482", "#663399", "#990033", "#FF3333", "royalblue1","#FF9900", 
             "#266A2E", "#55D43F", "#404040", "#C87533", "#DCDCDC", "#FFDE00", "#F1B2E1", "#FF717E", "maroon3")
# print(palette)
# scales::show_col(palette)

# sequencial palette
palette1 <- c("#8e0152","#c51b7d", "#de77ae","#f1b6da", "#fde0ef",
              "#276419", "#4d9221", "#7fbc41","#b8e186","#e6f5d0",
              "#67001f", "#b2182b", "#d6604d", "#f4a582", "#fddbc7",
              "#e0e0e0", "#bababa", "#878787", "#4d4d4d", "#1a1a1a")



# print(palette1)
# scales::show_col(palette1)


```

# Data

Data from RKI: description of data can be read [here:](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/a99afefd4258435f8af660b6cbed9bf7_0/about)

Census data from [Federal Statistical Office of Germany](https://www.destatis.de/EN/Home/_node.html)


```{r read in}
#(1) Linelist_COVID-19 in NRW
source(paste0(path_data_code,"/linelist.R"))
#(1.1) rki data:https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/a99afefd425843
source(paste0(path_data_code,"/covid19_rki.R"))

#(2) age distribution in NRW
source(paste0(path_data_code,"/population.R"))

#(3) hospitalization
source(paste0(path_data_code,"/hospitalisation.R"))

#(4)Whole Germany_JHU data # up to date data
source(paste0(path_data_code,"/covid19_jhu.R"))

# (5) NUTS_3##############################
source(paste0(path_data_code,"/nuts3.R"))

#(6) Deprivation upto 2015
source(paste0(path_data_code,"/gisd.R"))

#(7) Regulations
source(paste0(path_data_code,"/regulation.R"))
 
#(8) vaccinations in NRW
source(paste0(path_data_code,"/vaccination.R"))

```

## Underreporting

[Ref:] (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8583384/)
Seroprevalence study per wave:
 MUSPAD:5 study cite:
 - seroprevalence (<3%) until Mid-December 2020 in all regions.
 - 5.4% in February 2021
 - show proportions of infections detected by notifications to be 20 - 40% ( till 11/20)
 - infections detected by notifications increased to 40-50% (wave2)


```{r eval= FALSE, echo=FALSE}

#Wave1:
#MUSPAD study
##Aachen: 09/09-09/10/2020
study_seropos <- 0.023 #(2.3% [1.7-3.1])
wave1 <- dat %>% filter(rep_date <= as.Date("2020-10-09"))
report_ratio <- nrow(wave1)/NRW_pop
1-report_ratio/study_seropos # under report 81%

report_ratio <- 0.005 #0.5% of this this district only
1-report_ratio/study_seropos # under report 78.3%%

# other studies
## Blood sample in NRW: 9/3-3/6/2020
study_seropos <- 0.009 #(0.9% [0.5-1.4])
wave1 <- dat %>% filter(rep_date <= as.Date("2020-06-03"))
report_ratio <- nrow(wave1)/NRW_pop
1-report_ratio/study_seropos # under report 76%

## SeroDUS1, Dusseldorf: 2/11-23/11/2020
study_seropos <- 0.031 #(3.1% [2.4-4.0])
wave1 <- dat %>% filter(rep_date <= as.Date("2020-11-23"))
report_ratio <- nrow(wave1)/NRW_pop
1-report_ratio/study_seropos # under report 57%


#wave 12: Aachen 25/01/2021-27/02/2021:

study_seropos <- 0.054 #(5.4% [4.4-6.5])
wave12 <- dat %>% filter(rep_date <= as.Date("2021-02-27"))
report_ratio <- nrow(wave12)/NRW_pop
1-report_ratio/study_seropos # under report 45%


## Calculate under report in wave 2 only

wave1 <- dat %>% filter(rep_date <= as.Date("2020-10-09"))
wave1 <- nrow(wave1) # total case reported wave 1
wave1
wave12 <- dat %>% filter(rep_date <= as.Date("2021-02-27"))
wave12 <- nrow(wave12)# total case reported up to wave 2
wave12
wave2 <- wave12 - wave1# total case reported wave 2
wave2

report_w1 <- 0.22 # under_report 78%
report_w12 <- 0.55 # under_report45%
report_w2 <- wave2/(wave12/report_w12 - wave1/report_w1)

under_report_w2 <- 1- report_w2 # 25%
under_report_w2


```


##add allage (new row)

A long week each agegroup, Allage (new row)is also added. Be care when using this data set 

###date level

A long week each agegroup, Allage (new row)is also added. Be care when using this data set 

```{r}


#agegroup2
dummy <- pop_age %>%group_by(agegroup2)%>% # agegroup or agrgroup2
  dplyr::summarise(pop_n =sum(pop_n))

# sum pop of all age
pop_age_all <- dummy %>%dplyr::summarise(pop_n =sum(pop_n))%>%
  ungroup()%>%
  mutate(agegroup2 = "allAge")
pop_age_all <- pop_age_all[,c(2,1)] #arrange col order for merging data later
pop_age_all <- rbind(dummy, pop_age_all) # add all age pop row

dat<- merge(dat, dummy, by="agegroup2", all=T)# add nrw pop distribution by age


##sum cases of each agegroup by date
dat_date <- dat %>%
  group_by(rep_date,rep_week_date,rep_week,agegroup2) %>%
  dplyr::summarise(case=n()) %>% #sum cases per date by age groups
  ungroup() 

## sum cases of all age by week
dat_allAge <- dat %>%
  group_by(rep_date,rep_week_date,rep_week) %>%
  dplyr::summarise(case=n()) %>% # sum cases per date in all age groups
  ungroup()%>%
  mutate(agegroup2 = "allAge")
dat_allAge <- dat_allAge[,c(1:3,5,4)] #arrange col order as in 'dat_date' for merging data later

dat_date <- rbind(dat_date, dat_allAge)# add cases of allAge


dat_date <- merge(dat_date,pop_age_all, by ="agegroup2") # add pop to dat_date for weghing

# rolling average

dat_date <- dat_date %>%mutate(
      case_7da = zoo::rollmean(case, k = 7, fill = NA))


dat_date$case_per100k<- dat_date$case/dat_date$pop_n*100000


#division 0
dat_date$case_per100k_grouped <- cut(dat_date$case_per100k, breaks=c(-Inf, 5, 10, 15, 20, 35,50,100,150,200,300,Inf))
dat_date$case_per100k_grouped <- factor(dat_date$case_per100k_grouped, levels=c("(-Inf,5]", "(5,10]", "(10,15]", "(15,20]", "(20,35]", "(35,50]","(50,100]", "(100,150]", "(150,200]", "(200,300]", "(300, Inf]"),
                      labels=c("0-5",">5-10",">10-15", ">15-20", ">20-35", ">35-50", ">50-100", ">100-150",">150-200", ">200-300", ">300"), ordered=T)

## Under report
dat_date$case_scaled <- NA

dat_date$case_scaled[dat_date$rep_week_date <= cutoff_day] <- ceiling(dat_date$case[dat_date$rep_week_date <= cutoff_day]/(1-u_report_w1))


dat_date$case_scaled[dat_date$rep_week_date > cutoff_day] <- ceiling(dat_date$case[dat_date$rep_week_date > cutoff_day]/(1-u_report_w2))


##average case of 7 days ago
dat_date_dummy <- dat_date %>%
  group_by(rep_date,rep_week_date) %>%
  dplyr::summarise(case=sum(case), case_scaled=sum(case_scaled)) %>% # sum cases per date in all age groups
  ungroup()%>%
  mutate(case_ave_7day = rollapply(case,7,function(x) sum(x)/7,fill=NA, align="right"),
         case_7day = rollapply(case,7,function(x) sum(x),fill=NA, align="right"),
         case_scaled_ave_7day = rollapply(case_scaled,7,function(x) sum(x)/7,fill=NA, align="right"),
         case_scaled_7day = rollapply(case,7,function(x) sum(x),fill=NA, align="right"))#Ave. 7days ago

dat_date_dummy$case_per100k <- dat_date_dummy$case/NRW_pop*100000
dat_date_dummy$case_7day_per100k <- dat_date_dummy$case_7day/NRW_pop*100000


# reported case to calculate under-reporting

dummy <- dat_date %>% dplyr::filter(rep_date > as.Date("2020-10-09")&rep_date <= as.Date("2021-02-27"))
sum(dummy$case)

```


###week level
A long week each agegroup, Allage (new row)is also added. Be care when using this data set

```{r}
##sum cases of each agegroup by week
dat_week <- dat %>%
  group_by(rep_week_date,rep_week,agegroup2) %>%
  dplyr::summarise(case=n()) %>% #sum cases per week by age groups
  ungroup() 

## sum cases of all age by week
dat_allAge <- dat %>%
  group_by(rep_week_date,rep_week) %>%
  dplyr::summarise(case=n()) %>% # sum cases per week in all age groups
  ungroup()%>%
  mutate(agegroup2 = "allAge")

dat_allAge <- dat_allAge[,c(1,2,4,3)] #arrange col order as in 'dat_week' for merging data later

dat_week <- rbind(dat_week, dat_allAge)# add cases of allAge

dat_week <- merge(dat_week,pop_age_all, by ="agegroup2") # add pop to dat_week for weighing

## hospitalisation
##sum cases of each agegroup by week
hosp_week <- dat %>%filter(hosp=="Ja")%>%
  group_by(rep_week_date,agegroup2) %>%
  dplyr::summarise(hosp=n()) %>% #sum cases per week by age groups
  ungroup() 
## sum hosp cases of all age by week
hosp_allAge <- dat %>%filter(hosp=="Ja")%>%
  group_by(rep_week_date) %>%
  dplyr::summarise(hosp=n()) %>% # sum cases per week in all age groups
  ungroup()%>%
  mutate(agegroup2 = "allAge")

hosp_allAge <- hosp_allAge[,c(1,3,2)] #arrange col order as in 'hosp_week' for merging data later

hosp_week <- rbind(hosp_week, hosp_allAge)# add cases of allAge

dat_week <- merge(dat_week, hosp_week, by = c("rep_week_date", "agegroup2"), all= T) # merge with case data



dat_week$case_per100k<- dat_week$case/dat_week$pop_n*100000
dat_week$hosp_per100k<- dat_week$hosp/dat_week$pop_n*100000


#categotise range of reported numbers
## cases
dat_week$case_per100k_grouped <- cut(dat_week$case_per100k, breaks=c(-Inf, 5, 10, 15, 20, 35,50,100,150,200,300,Inf))
dat_week$case_per100k_grouped <- factor(dat_week$case_per100k_grouped, levels=c("(-Inf,5]", "(5,10]", "(10,15]", "(15,20]", "(20,35]", "(35,50]", "(50,100]", "(100,150]", "(150,200]", "(200,300]", "(300, Inf]"),
                            labels=c("0-5",">5-10",">10-15", ">15-20", ">20-35", ">35-50", ">50-100", ">100-150", ">150-200", ">200-300", ">300"), ordered=T)
## hosp
dat_week$hosp_per100k_grouped <- cut(dat_week$hosp_per100k, breaks=c(-Inf, 5, 10, 15, 20, 25,30,35,40,45,50,Inf))
dat_week$hosp_per100k_grouped <- factor(dat_week$hosp_per100k_grouped, levels=c("(-Inf,5]", "(5,10]", "(10,15]", "(15,20]", "(20,25]", "(25,30]","(30,35]", "(35,40]", "(40,45]", "(45,50]", "(50, Inf]"),
                            labels=c("0-5",">5-10",">10-15", ">15-20", ">20-25", ">25-30",">30-35", ">35-40", ">40-45", ">45-50", ">50"), ordered=T)

dat_week$hosp_rate <- dat_week$hosp/dat_week$case

## Under report
dat_week$case_scaled <- NA

dat_week$case_scaled[dat_week$rep_week_date <= cutoff_day] <- ceiling(dat_week$case[dat_week$rep_week_date <= cutoff_day]/(1-u_report_w1))


dat_week$case_scaled[dat_week$rep_week_date > cutoff_day] <- ceiling(dat_week$case[dat_week$rep_week_date > cutoff_day]/(1-u_report_w2))

dat_week_dummy <- dat_week %>%
  filter(agegroup2!="allAge")%>% # allAge is sum of all age group # duplicate data
  dplyr::select(rep_week_date,case,case_scaled)%>%
  group_by(rep_week_date)%>%
  summarise_if(is.numeric,sum) %>% #sum cases per week
  ungroup() 

dat_week_dummy$case_per100k <- dat_week_dummy$case/NRW_pop*100000
dat_week_dummy$case_scaled_per100k <- dat_week_dummy$case_scaled/NRW_pop*100000


```


##county level

Variant of concern (earliest sample [place]- designated VOC)

- Alpha (20.09.2020 [UK]-18.12.2020)  -> wave 1,....

- Beta (05.2020[South Africa] - 14.01.2021) -> wave 2,....

- Gamma (11.2020 [Brasil]- 15.01.2021) -> wave 2, ...

- Delta (10.2020 [India]- 6.5.2021) -> wave2, wave 3,...

- Omicron (9.11.2021 [ South Africa] - 26.11.2021) -> wave 3, wave 4...

* Source: https://en.wikipedia.org/wiki/Variants_of_SARS-CoV-2



### defining wave 1:
The evolution of the pandemic might be different among countries and between geographical regions. So it is important to clearly communicate and define the so-called waves in the studied regions or countries for avoiding confusion (Ayala A, et al.,). In this work, we stratified the study period into 2 phases:(1) the initial phase (wave1) when the spread of infections depends on how the virus first entered a country/region, (2) the second phase with multiple waves when individuals start taking precautionary measures. A wave of the second phase (wave 2 to wave 4) was defined based on a threshold of 70/100000 cases per week. For each wave, the starting week (since the end of the previous wave) is when the weekly incidence rate is higher than the threshold and positive growth incidence rate in at least one week. The end of a wave is when the weekly incidence rate is lower than the threshold and negative growth incidence rate for at least two consecutive weeks.
**phase 1:**
 Wave 1: start -  < 30/09/2020
**Phase 2:**
 Wave 2: >= 30/09/2020 - <16/02/2021
 Wave 3: >=16/02/2021- <=16/06/20211
 Wave 4: >=28/07/2021- end 2021(29/12/2021)

**Notes:**The break between wave 2 and 3 is violated the rule.

```{r}
# 
dummy <- dat_week%>%
  group_by(rep_week_date)%>%
  dplyr::summarise(case = sum(case), case_scaled =sum(case_scaled))%>%
  mutate(case_per100k = case/NRW_pop*100000,
         case_scaled_per100k = case_scaled/NRW_pop*100000)


#group data by county and wave
## oJriginal data
dat_county <- dat %>% group_by(county) %>%
  dplyr::summarise(cases=n())%>%
  ungroup() 
dat_county_wave1 <- dat %>%filter(rep_date < as.Date("2020-05-13")) %>% group_by(county) %>%
  dplyr::summarise(case_wave1=n())%>%
  ungroup() 
dat_county_wave2 <- dat %>%filter(rep_date >= as.Date("2020-09-30")&rep_date < as.Date("2021-02-17")) %>% group_by(county) %>%
  dplyr::summarise(case_wave2=n())%>%
  ungroup() 
dat_county_wave3 <- dat %>%filter(rep_date >= as.Date("2021-02-17")&rep_date < as.Date("2021-06-16")) %>% group_by(county) %>%
  dplyr::summarise(case_wave3=n())%>%
  ungroup() 
dat_county_wave4 <- dat %>%filter(rep_date >= as.Date("2021-07-28")&rep_date <= as.Date("2021-12-31")) %>% group_by(county) %>%
  dplyr::summarise(case_wave4=n())%>%
  ungroup()

# dat_county1 <- left_join (dat_county,dat_county_wave1,dat_county_wave2,dat_county_wave3,dat_county_wave4, by="county")
dat_county <- left_join (dat_county,dat_county_wave1)
dat_county <- left_join (dat_county,dat_county_wave2)
dat_county <- left_join (dat_county,dat_county_wave3)
dat_county <- left_join (dat_county,dat_county_wave4)

rm(dat_county_wave1,dat_county_wave2,dat_county_wave3,dat_county_wave4)

# add GISD data
dat_county <- merge(dat_county, gisd %>%dplyr::select(county,GISD_5), by = "county")

# # duration each wave
# duration_w1<- 30
# duration_w2<- 20
# duration_w3<- 14
# duration_w4<- 09
# 
# dat_county <- dat_county%>%
#   mutate(case_perwk_100k_w1 = case_wave1/duration_w1/pop*100000,
#          case_perwk_100k_w2 = case_wave2/duration_w2/pop*100000,
#          case_perwk_100k_w3 = case_wave3/duration_w3/pop*100000,
#          case_perwk_100k_w4 = case_wave4/duration_w4/pop*100000)

# dat_county <- dat_county %>% dplyr::select (-c("pop"))# avoid duplicated later

dat_county <- merge(dat_county,nuts3, by = "county")



```

# NRW pop distribution {.tabset}

## By age

```{r}
# pop distribution by age 
  
pop_age %>%
  ggplot(aes(x = agegroup, y= pop_n/1000)) +  # unit: thousand
  geom_bar(stat="identity", fill = " dark blue")+
  # facet_grid(row = vars(agegroup))+
  # scale_y_continuous(labels = scales::percent_format()) +
  # scale_fill_manual(values=palette1, name="Age group") +
  labs(y = "Number of inhabitants [thousand]") +
  ggtitle("NRW_ pop distribution")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

# sumary table 
dummy <- pop_age%>%group_by(agegroup)%>%summarise(pop_n = sum(pop_n)) %>% mutate(pop_percent = pop_n*100/(sum(pop_n)))


```
 
## By county

```{r}

# pop distribution by county
nuts3%>%
  ggplot(aes(x = county, y= pop_n/1000)) +  # unit: thousand
  geom_bar(stat="identity", fill = " dark blue")+
  labs(y = "Number of inhabitants [thousand]") +
  ggtitle("NRW_ pop distribution")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))



```

## Pop. density

```{r}
# pop density

nut3d <- nuts3
nut3d$density <- nut3d$pop_n/nut3d$area_sq_km
nut3d<- nut3d[order(nut3d$density),]
nut3d%>%
  ggplot(aes(x = reorder(county,density), y= density)) +  # unit: thousand
  geom_bar(stat="identity", fill = " dark blue")+
  labs(y = "Number of inhabitants/sq km", x= "") +
  ggtitle("NRW_ pop density distribution")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))


```


# COVID-19 over time 

## Barchart

```{r}

dummy <- dat_county
dummy$density <- dummy$pop_n/dummy$area_sq_km
dummy<- dummy[order(dummy$density),]
dummy <- dummy%>% select(county,GISD_5, density,case_wave1,case_wave2, case_wave3,case_wave4)

dummy <- melt(dummy, id.vars = c(1:3)) # id.vars indicate variables that you don't want to melt

dummy%>%
  ggplot(aes(x = reorder(county,density), y= value)) + 
  geom_bar(stat="identity", fill = " dark blue")+
  labs(y = "") +
  facet_wrap(~variable, ncol =1)+
  ggtitle("Number of iCovid-19 infections")+
  theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
          axis.title = element_text(colour = "black", size = 15, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))



```


## Heatmap: by age

### Case

There is a shift in age structure among COVID-19 infections, _especially since wave 4._

```{r}
heatmap_case <- dat_week %>% 
  dplyr::filter(!is.na(agegroup2)) %>%
  ggplot(aes(rep_week_date, agegroup2)) +
  geom_tile(aes(fill=case_per100k_grouped), colour = "black")+
  geom_text(aes(label = round(case_per100k)), size = 2, colour = "#585858") + #size of number in each cell
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  #division 0
  scale_fill_manual(values=c("#FFF7FC","#EDE7F3", "#D0D1E6", "#A6BDDC", "#74AAD0",
                             "#3691C0", "#0470B0", "#044E7B", "#333F50", "#404040", "#262626")) +
  ## division 1,2,3
  # scale_fill_brewer(palette = "Blues")+ #BuPu, BuGn, Blues, Oranges,Reds,....
  labs(fill = "incidence \n(per 100k)", x="")+
  ggtitle("NRW_ weekly COVID-19 Incidence per 100k 
")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=18, hjust=0.5),
        axis.text.x = element_text(size = 10,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 10, face = "bold")) + 
  scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0)) +
  # scale_x_continuous(expand=c(0,0)) +
  scale_y_discrete(expand=c(0,0))

heatmap_case 
# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```


###Hosp

```{r}
dat_week %>%
  ggplot(aes(rep_week_date, agegroup2)) +
  geom_tile(aes(fill=hosp_per100k_grouped), colour = "black")+
  geom_text(aes(label = round(hosp_per100k)), size = 2, colour = "#585858") + #size of number in each cell
  #division 0
  scale_fill_manual(values=c("#FFF7FC","#EDE7F3", "#D0D1E6", "#A6BDDC", "#74AAD0",
                             "#3691C0", "#0470B0", "#044E7B", "#333F50", "#404040", "#262626")) +
  ## division 1,2,3
  # scale_fill_brewer(palette = "Blues")+ #BuPu, BuGn, Blues, Oranges,Reds,....
  labs(fill = "incidence \n(per 100k)", x="")+
  ggtitle("NRW_ weekly COVID-19 hospitalised incidence per 100k
")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=15, hjust=0.5),
        axis.text.x = element_text(size = 10,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 10, face = "bold")) +
 scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0)) +
  # scale_x_continuous(expand=c(0,0)) +
  scale_y_discrete(expand=c(0,0))

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

## Histogram: by age
### Case

```{r}

#create data structure for histogram
#case prop_all age group################################
# dat_dm<- merge(dat, pop_age, by="agegroup2", all=T)# add nrw pop distribution by age
histo_setup <- dat%>%
  group_by(rep_week,rep_week_date, agegroup2) %>% dplyr::summarise(case_n=n()) 

# histo_setup$maxrepweek <- max(histo_setup$rep_week)


his_case <- dat%>%
  group_by(rep_week,rep_week_date, agegroup2) %>% dplyr::summarise(case_n=n())%>%
  ggplot(aes(x=rep_week_date, y=case_n, fill=agegroup2)) + 
  geom_bar(position="fill", stat="identity")+
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values=palette, name="Age group") +
   labs(y="Propotion of reported case",x=" ")+
  ggtitle(" Covid-19 Incidence in NRW_ weekly report")+
 scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0)) +
theme(axis.text.x = element_text(colour = "black", size = 10,
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
          axis.title = element_text(colour = "black", size = 12, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))

his_case

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

### Hosp

```{r}

his_hosp <- dat%>%filter(hosp=="Ja")%>%
  group_by(rep_week,rep_week_date, agegroup2,pop_n) %>% dplyr::summarise(case_n=n())%>%
  ggplot(aes(x=rep_week_date, y=case_n, fill=agegroup2)) + 
  geom_bar(position="fill", stat="identity")+
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values=palette, name="Age group") +
   labs(y="Propotion of reported case",x=" ")+
  ggtitle(" Hospitalisation attributed to COVID-19 in NRW_weekly report")+
 scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0)) +
theme(axis.text.x = element_text(colour = "black", size = 10, 
                                     angle = 90, hjust = 0.5, vjust = 0,5),
          axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
          axis.title = element_text(colour = "black", size = 12, face = "bold"),
          legend.background = element_blank(),
          legend.key = element_blank(),
          legend.position = "right",
          legend.text = element_text(colour = "black", size = 15),
          legend.title = element_text(colour = "black", size = 16, face = "bold"),
          plot.title = element_text(colour = "black", size = 18, face = "bold",
                                    hjust = 0.5),
          strip.text = element_text(colour = "black", size = 12, face = "bold"))


his_hosp 
# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)



```

### Panel
 
```{r}

# multiple plots in the same page 
panel <- ggarrange(heatmap_case  +rremove("x.text"), 
          his_case+rremove("x.text"),
         his_hosp,
         labels = c("A", "B", "C"),
          ncol = 1, nrow = 3)

annotate_figure(panel, 
                left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))

```

### hospitalised rate in each age group

Is there a shift of hospitalizations:


```{r}


# stacked area chart
 dat_week %>%
  filter(agegroup2!="allAge")%>% # allAge is sum of all age group # duplicate data
ggplot(aes(x=rep_week_date, y=hosp_rate, color=agegroup2, group=agegroup2)) + 
  geom_line()+
  # scale_fill_manual(values=c("#d7191c", "#fdae61", "#abdda4", "#2b83ba"), name="Vaccine Type")+
  # scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
  #              limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
  #              expand = c(0, 0)) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0))+
  labs(x = " ", y = " ") +
  ggtitle("Hospitalised rate attributed to Covid-19 in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = "right",
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



```


## Line graph {.tabset}
### Case

```{r}

# each county in NRW

# county_name  = unique(dat$county)
# plot_list <- list()
# 
# ## loop for ploting
# for (i in (1: length(county_name))){
#   i=4
#   kreis = county_name[i]
#   
#   dummy <- dat%>% # summary incidence of a county
#   filter(county == kreis)%>%
#   group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
#   mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))
#   
#   kreis_pop <- dat_county%>% # pop of a county
#          filter(county == kreis)
#   
#   dummy$pop <- kreis_pop$pop
#   
#  p <- dummy%>%
#   ggplot(aes(x=rep_date))+
#   geom_line(aes(y=case_n/pop*100000, colour = "case_n"), size=1) +
#   geom_line(aes(y=case_mean7da/pop*100000,colour = "case_mean7da"), size=1) +
#   scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
#                limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
#                expand = c(0,0)) +
#   labs(x = " ", y = "Confirmed number per 100k") +
#   ylim(0,100)+
#   scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
#                      labels = c("Raw Incidence",
#                                 "Rolling ave.7days"))+
#   # ylim(0,8500)+
#   ggtitle(paste0("COVID-19 Incidence in ",kreis,"_ daily report"))+
#   theme_classic()+
#   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
#         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
#         axis.title = element_text(colour = "black", size = 15, face = "bold"),
#         legend.background = element_blank(),
#         legend.key = element_blank(),
#         legend.position = c(0.12,0.8),
#         legend.text = element_text(colour = "black", size = 15),
#         legend.title = element_text(colour = "black", size = 16, face = "bold"),
#         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
#         strip.text = element_text(colour = "black", size = 10, face = "bold"))
#   
#   plot_list[[i]] = p # store plot into list
#   ggsave(paste0(path_result,"/COVID_19/incidence_pattern_county/incidence_",kreis,".png"),p, width=14, height=7)
# 
# }


## NRW
panel_case <- dat%>%
  group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))%>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case_n/NRW_pop*100000, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da/NRW_pop*100000,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number per 100k") +
  scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                     labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Incidence in NRW_ daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

panel_case 

#rki data
dat_rki%>%
  group_by(rep_date) %>% dplyr::summarise_if(is.numeric,sum)%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case, k = 7, fill = NA))%>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case/NRW_pop*100000, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da/NRW_pop*100000,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number per 100k") +
  scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                     labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Incidence in NRW_ RKI daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


## visualize reported case in Germany
ger <- germany%>%
  filter(rep_date <= as.Date("2022-01-01"))%>%
  select(rep_date, case_n) %>% 
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))%>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case_n/DE_pop*100000, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da/DE_pop*100000,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
                limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number per 100k") +
  scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                     labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Incidence in Germany_ daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

ger
# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

### Hosp


```{r eval=F,results='hide'}

# Weighing for pop
dummy <- dat%>%filter(hosp=="Ja")%>%
  group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))

dummy %>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case_n, colour = "case_n"), size=1) +
  geom_line(aes(y=case_mean7da,colour = "case_mean7da"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number.") +
   scale_color_manual(name = "", values = c("case_n"="blue","case_mean7da"="red"),
                      labels = c("Raw Incidence",
                                "Rolling ave.7days"))+
   ylim(0,800.0)+
  ggtitle("COVID-19 hospitalisation in NRW_ daily report")+
  theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position = c(0.12,0.8),
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))



# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

### ICU
* This data from **211229 NRW dateninput modellierungen wwu** 

The earliest time is **06.04.2020**  while the line list's **19.02.2020**

Is normal mean non_hospitalization ? 

ICU = intensive + ventilation ??

```{r}
colnames(hosp)

hosp_melt <- melt(hosp, id.vars = c(1,6:8)) # id.vars indicate variables that you don't want to melt

# Hospitalisation (all) 
hosp_melt%>%
  ggplot()+
  geom_line(aes(y=value, x=rep_date,color=variable)) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number", color="") +
  ylim(0,8000)+
  ggtitle("Hospitalisation attributed to COVID-19 in NRW_prevalence")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


#Hospitalisation ( ICU = ventilation +intensive )
hosp_melt <-  hosp%>%
  group_by(rep_date,total, normal,intensive, ventilation) %>% dplyr::summarise(ICU =  sum(intensive,ventilation)) #count case by date
hosp_melt <- melt(hosp_melt, id.vars = "rep_date") # id.vars indicate variables that you don't want to melt
#
panel_hosp <- hosp_melt%>%filter(variable!="intensive" &variable!="ventilation" )%>% # included in ICU
  ggplot()+
  geom_line(aes(y=value, x=rep_date,color=variable)) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number", color="") +
  ylim(0,8000)+
  ggtitle("Hospitalisation attributed to COVID-19 in NRW_daily report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



#ICU : intensive + ventilation ???
panel_ICU <-  hosp%>%
  group_by(rep_date) %>% dplyr::summarise(ICU= sum(intensive,ventilation))%>% #count case by date
  ggplot()+
  geom_line(aes(y=ICU, x=rep_date), size=1, colour="blue") +
   scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days",
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0, 0)) +
  labs(x = " ", y = "Reported number") +
   ylim(0,2000)+
  ggtitle("Hospitalisation (ICU) attributed to COVID-19 in NRW_daily reportin NRW_ daily")+
  theme_classic()+
   theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
         axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
         axis.title = element_text(colour = "black", size = 15, face = "bold"),
         legend.background = element_blank(),
         legend.key = element_blank(),
         legend.position ="right",
         legend.text = element_text(colour = "black", size = 15),
         legend.title = element_text(colour = "black", size = 16, face = "bold"),
         plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
         strip.text = element_text(colour = "black", size = 10, face = "bold"))


  

# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)

```

### panel:

These two graphs are generated from two different data sets. The line list has to be calibrated for under-reporting! 

Is there any more reliable incidence report?  

```{r}
# multiple plots in the same page 
panel <- ggarrange(panel_case +rremove("x.text")+rremove("y.title"), 
          panel_hosp +rremove("y.title"),
          labels = c("A", "B"),
          ncol = 1, nrow = 2)

annotate_figure(panel, 
                left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
           

# # 
# panel <- ggarrange(panel_case +rremove("x.text")+rremove("y.title"), 
#           panel_hosp +rremove("x.text")+rremove("y.title"),
#           panel_ICU+rremove("y.title"),
#           labels = c("A", "B", "C"),
#           ncol = 1, nrow = 3)
# 
# annotate_figure(panel, 
#                 left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
               

```
 
### panel2
check the data with other resource: i.e: rki
#### line
 
```{r}
dummy <- dat_week %>%
  # filter(agegroup!="allAge")%>% # rm allAge to avoid duplicated data
  group_by(rep_week_date)%>%
  mutate_each(funs(replace(., is.na(.), 0)))%>% # NAs is assummed 0 cases
  summarise_if(is.numeric,sum)
  
  dummy %>%
  ggplot(aes(x=rep_week_date))+
  geom_line(aes(y=case/NRW_pop*100000, colour = "case"), size=1) +
  geom_line(aes(y=hosp/NRW_pop*1000000, colour = "hosp"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number") +
  scale_color_manual(name = "", values = c("case"="blue","hosp"="red"),
                     labels = c("Case per 100k",
                                "Hospitalised per 1M"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 Inc.&hosp in NRW_ weekly report")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

# compare with other data sources
dummy <- dat_week %>% 
  filter(agegroup2!="allAge")%>% # rm allAge to avoid duplicated data
  group_by(rep_week_date)%>%
  summarise_if(is.numeric,sum,na.rm = T)

# add case/death from rki
dummy_rki <- dat_rki %>% 
  dplyr::select(rep_week_date,case,death,recover)%>% # 
  group_by(rep_week_date)%>%
  summarise_if(is.numeric,sum) # sum by week
colnames(dummy_rki) <- c("rep_week_date","case_rki","death_rki","recover_rki")
  
#add hosp data from another source
dummy_hosp <- hosp%>%group_by(rep_week_date)%>%dplyr::select(-c(rep_week,maxrepweek))%>%
  summarise_if(is.numeric,sum)

dummy <- merge(dummy,dummy_rki, by = c("rep_week_date"), all=T)
dummy <- merge(dummy,dummy_hosp, by = c("rep_week_date"), all=T)

rm(dummy_hosp,dummy_rki)

dummy$ICU <- dummy$intensive +dummy$ventilation # ICU


# sumdata is not new incidence
dummy %>%
 ggplot(aes(x=rep_week_date))+
  geom_line(aes(y=case, colour = "case"), size=1) +
  geom_line(aes(y=case_scaled, colour = "case_scaled"), size=1) +
  geom_line(aes(y=hosp, colour = "hosp"), size=1) +
  geom_line(aes(y=total, colour = "total"), size=1) +
  geom_line(aes(y=ICU, colour = "ICU"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number") +
  scale_color_manual(name = "", values = c("case"="blue","case_scaled" ="grey","hosp"="red", "total"="orange", "ICU" = "pink"),
                     labels = c("Case_linelist",
                                "Case_scaled_linelist",
                                "Hospitalised_linelist",
                               " Hospitalised_sumdataset",
                                "ICU_sumdataset"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 in NRW_ weekly report [linelist vs. sumdata")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.18,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))
 

## linelist data is in line with rki
dummy %>%
 ggplot(aes(x=rep_week_date))+
  geom_line(aes(y=case, colour = "case"), size=1) +
  geom_line(aes(y=hosp, colour = "hosp"), size=1) +
  geom_point(aes(y=case_rki, colour = "case_rki"), size=2) +
  geom_line(aes(y=death_rki, colour = "death_rki"), size=1) +
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = "Reported number") +
  scale_color_manual(name = "", values = c("case"="blue","hosp"="red", "case_rki"="black","death_rki" = "orange"),
                     labels = c("Case_linelist",
                                "Hospitalised_linelist",
                                "case_rki",
                                "death_rki"))+
  # ylim(0,8500)+
  ggtitle("COVID-19 in NRW_ weekly report [linelist vs RKI]")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.12,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))
 


```

#### stacked

```{r stacked area chart }
#################################################
#1 confirm case overtime ##
################################################
dummy <- dat %>%
  group_by(rep_week_date,agegroup2) %>%
  dplyr::summarise(case=n())#sum cases per week by age groups
  
dummy <- merge(dummy,pop_age%>%group_by(agegroup2)%>%
                 dplyr::summarise(pop_n=sum(pop_n)), by = "agegroup2")# add pop

palette <- c("#08519c","#3182bd","#6baed6","#9ecae1","#c6dbef","#eff3ff" )

dummy$pop_NRW <- NRW_pop

dummy1 <- dat%>% # to add daily report number
  group_by(rep_date) %>% dplyr::summarise(case_n=n())%>% #count case by date
  mutate(case_mean7da = zoo::rollmean(case_n, k = 7, fill = NA))
dummy1$pop_NRW <- NRW_pop

# dummy %>%  
p1 <- ggplot() + 
  geom_area(data=dummy,aes(x=rep_week_date, y=case/pop_NRW*100000, fill=agegroup2))+
  # geom_line(data=dummy1,aes(x = rep_date,y=case_mean7da/pop_NRW*100000,color="case_n"), size=1) +
  # 
  # scale_y_continuous(sec.axis = sec_axis(breaks=seq(0,500,by= 100),labels = seq(0,8000,by=2000),~ . *1, name = "Dailly confirmed infections"))+
  scale_color_manual(name = "Daily report", values = c("case_mean7da"="red"),
                     labels = c("Rolling ave.7days"))+
  # scale_fill_manual(values=palette, name="Age group",)+
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  # ylim(0,60)+
  labs(x = " ", y = "Weekly incidence per 100k",fill = " Age group") +
  ggtitle("Covid-19 incidence in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.18,0.61),
        legend.text = element_text(colour = "black", size = 8),
        legend.title = element_text(colour = "black", size = 12, face = "bold"),
        plot.title = element_text(colour = "black", size = 20, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


############################################
#2 hosp and vaccination over time ############
############################################

#cum vac over time 

vac_alltype1 <- vacc_BUND %>%filter(dose==1)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype1 <- vac_alltype1 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype1$vac_n_cum <- cumsum(vac_alltype1$vac_n)
vac_alltype1$dose <- 1

vac_alltype2 <- vacc_BUND %>%filter(dose==2)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype2 <- vac_alltype2 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype2$vac_n_cum <- cumsum(vac_alltype2$vac_n)
vac_alltype2$dose <- 2

vac_alltype3 <- vacc_BUND %>%filter(dose=="booster")%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype3 <- vac_alltype3%>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype3$vac_n_cum <- cumsum(vac_alltype3$vac_n)
vac_alltype3$dose <- "booster"

vac_alltype <- rbind(vac_alltype1,vac_alltype2,vac_alltype3)
rm(vac_alltype1,vac_alltype2,vac_alltype3)

dummy <- melt(hosp, id.vars = c(1:2,6:8)) # 
# dummy %>%  
p2 <- ggplot() + 
  geom_area(data=dummy, aes(x=rep_date, y=value, fill=variable))+
  geom_line(data=vac_alltype,aes(x = rep_date,y=vac_n_cum/NRW_pop_vacc*100*60, color = dose),size=2)+
  scale_y_continuous(sec.axis = sec_axis(breaks=seq(0,600,by= 120),labels = seq(0,100,by=20),~ . *6/60, name = "Accumulative vaccination (%) "))+
    scale_fill_manual(values=c("#084081", "#2b8cbe", "#7bccc4"), name="Hospitalised status")+
     scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  labs(x = " ", y = "Daily numbers") +
  ggtitle("Hospitalised stay attributed to Covid-19 in NRW")+
  # facet_wrap(~ hosp)+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.2,0.61),
        legend.text = element_text(colour = "black", size = 8),
        legend.title = element_text(colour = "black", size = 12, face = "bold"),
        plot.title = element_text(colour = "black", size = 20, face = "bold",hjust = 0.5),
  
              strip.text = element_text(colour = "black", size = 10, face = "bold"))

########################################
# combine 2 plots into panel 
########################################

# multiple plots in the same page 
panel <- ggarrange(p1 +rremove("x.text"), 
          p2 ,
         labels = c("A", "B"),
          ncol = 1, nrow = 2)

annotate_figure(panel, 
                left = textGrob("Reported number ", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
           


```

### case panel:

```{r }
#############################
#1 Daily case
#############################
dummy <- dat_date%>%
  dplyr::filter(agegroup2 != "allAge")%>% #rm to avoid duplicate
  group_by(rep_date,rep_week_date) %>%
  dplyr::summarise(case=sum(case), case_scaled=sum(case_scaled)) %>% # sum cases per date in all age groups
  ungroup()%>%
  mutate(case_ave_7day = rollapply(case,7,function(x) sum(x)/7,fill=NA, align="right"),
         case_7day = rollapply(case,7,function(x) sum(x),fill=NA, align="right"))#Ave. 7days ago

p1<- dummy%>%
  mutate(case_mean7da = zoo::rollmean(case, k = 7, fill = NA))%>%
  mutate(case_scaled_mean7da = zoo::rollmean(case_scaled, k = 7, fill = NA))%>%
  ggplot(aes(x=rep_date))+
  geom_line(aes(y=case/NRW_pop*100000, colour = "case"), size=1) +
  geom_line(aes(y=case_mean7da/NRW_pop*100000,colour = "case_mean7da"), size=1) +
  geom_line(aes(y=case_scaled_mean7da/NRW_pop*100000,colour = "case_scaled_mean7da"), size=1) +
  
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-30")),
               expand = c(0,0)) +
  labs(x = " ", y = " Daily inc. per 100k") +
  scale_color_manual(name = "", values = c("case"="blue","case_mean7da"="red","case_scaled_mean7da"="orange" ),
                     labels = c("Raw Incidence",
                                "Rolling ave.7days",
                                "Rolling ave.7days (scaled)"))+
  # ylim(0,8500)+
  ggtitle(" Confirmed COVID-19 infections in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.15,0.8),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))

####################################
#2 Weekly incidence with age structure
####################################

palette <- c("#253494","#2c7fb8","#41b6c4","#7fcdbb","#c7e9b4","#ffffcc" )

dummy <- dat %>%
  group_by(rep_week_date,agegroup2) %>%
  dplyr::summarise(case=n())#sum cases per week by age groups

dummy$pop_NRW <- NRW_pop

# dummy %>%  
p2 <- ggplot() + 
  geom_area(data=dummy,aes(x=rep_week_date, y=case/pop_NRW*100000, fill=agegroup2))+
  scale_fill_manual(values = palette)+ # col for stack plot
    scale_color_manual(name = "Daily report", values = c("case_mean7da"="red"),
                     labels = c("Rolling ave.7days"))+
  # scale_fill_manual(values=palette, name="Age group",)+
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  # ylim(0,60)+
  labs(x = " ", y = "Weekly inc. per 100k",fill = " Age group") +
  ggtitle(" Confirmed Covid-19 by age group in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.15,0.61),
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))





########################################
# combine 2 plots into panel 
########################################

# multiple plots in the same page 
panel <- ggarrange(p1 +rremove("x.text"), 
          p2,
         labels = c("A", "B"),
          ncol = 1, nrow = 2)

annotate_figure(panel, 
                left = textGrob("", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5))) # " Y axis name "
           


```

### hosp panel

```{r}

###########################
#1 Prop_reported hospitalisation
###########################

dummy <- dat%>%filter(hosp=="Ja")%>%
  group_by(rep_week,rep_week_date, agegroup2,pop_n) %>% dplyr::summarise(case_n=n())

palette <- c("#253494","#2c7fb8","#41b6c4","#7fcdbb","#c7e9b4","#ffffcc" )  

p1 <- dummy %>%
  ggplot(aes(x=rep_week_date, y=case_n, fill=agegroup2))+
  geom_bar(position="fill", stat="identity")+
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values=palette, name="Age group") +
   labs(y="",x=" ")+
  ggtitle(" Hospitalisation attributed to COVID-19 in NRW_weekly report")+
 scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0)) +
theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = "right",
        legend.text = element_text(colour = "black", size = 15),
        legend.title = element_text(colour = "black", size = 16, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



############################################
#2 hosp and vaccination over time ############
############################################

#cum vac over time 

vac_alltype1 <- vacc_BUND %>%filter(dose==1)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype1 <- vac_alltype1 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype1$vac_n_cum <- cumsum(vac_alltype1$vac_n)
vac_alltype1$dose <- 1

vac_alltype2 <- vacc_BUND %>%filter(dose==2)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype2 <- vac_alltype2 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype2$vac_n_cum <- cumsum(vac_alltype2$vac_n)
vac_alltype2$dose <- 2

vac_alltype3 <- vacc_BUND %>%filter(dose=="booster")%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype3 <- vac_alltype3%>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype3$vac_n_cum <- cumsum(vac_alltype3$vac_n)
vac_alltype3$dose <- "booster"

vac_alltype <- rbind(vac_alltype1,vac_alltype2,vac_alltype3)
rm(vac_alltype1,vac_alltype2,vac_alltype3)

dummy <- melt(hosp, id.vars = c(1:2,6:8)) # 
# dummy %>%  
p2 <- ggplot() + 
  geom_area(data=dummy, aes(x=rep_date, y=value, fill=variable))+
  geom_line(data=vac_alltype,aes(x = rep_date,y=vac_n_cum/NRW_pop_vacc*100*60, color = dose),size=2)+
  scale_y_continuous(sec.axis = sec_axis(breaks=seq(0,600,by= 120),labels = seq(0,100,by=20),~ . *6/60, name = "Accumulative vaccination (%) "))+
    scale_fill_manual(values=c("#084081", "#2b8cbe", "#7bccc4"), name="Hospitalised status")+
     scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  labs(x = " ", y = "Daily prevalence") +
  ggtitle("Hospitalised stay attributed to Covid-19 in NRW")+
  # facet_wrap(~ hosp)+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 15, face = "bold"),
        axis.title = element_text(colour = "black", size = 15, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.23,0.61),
        legend.text = element_text(colour = "black", size = 12),
        legend.title = element_text(colour = "black", size = 14, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))


########################################
# combine 2 plots into panel 
########################################

# multiple plots in the same page 
panel <- ggarrange(p1 , 
          p2 ,
         labels = c("A", "B"),
         align = "v",
          ncol = 1, nrow = 2)

annotate_figure(panel, 
                left = textGrob("", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
           

```

### case& hosp panel

```{r}

####################################
#1 Weekly incidence with age structure
# and under-report scaled inc.
####################################
palette <- c("#253494","#2c7fb8","#41b6c4","#7fcdbb","#c7e9b4","#ffffcc" )

dummy <- dat_date%>%
  dplyr::filter(agegroup2 != "allAge")%>% #rm to avoid duplicate
  group_by(rep_week_date,agegroup2) %>%
  dplyr::summarise(case=sum(case), case_scaled=sum(case_scaled)) # sum cases per week 
  
dummy$pop_NRW <- NRW_pop

dummy1 <- dummy%>%
  group_by(rep_week_date,pop_NRW) %>%
  dplyr::summarise(case=sum(case), case_scaled=sum(case_scaled)) # sum cases per week in all age groups

 p1 <- ggplot() + 
  geom_area(data=dummy,aes(x=rep_week_date, y=case/pop_NRW*100000, fill=agegroup2))+
  geom_line(data=dummy1,aes(x=rep_week_date, y=case_scaled/pop_NRW*100000,color="case_scaled"), size=1)+
  scale_fill_manual(values = palette)+ # col for stack plot
    scale_color_manual(name = "", values = c("case_scaled"="Orange"),
                     labels = c("Scaled incidence"))+
  # scale_fill_manual(values=palette, name="Age group",)+
  scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  # ylim(0,60)+
  labs(x = " ", y = "Weekly inc. per 100k",fill = " Age group") +
  ggtitle(" Confirmed Covid-19 by age group in NRW")+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.18,0.62),
        legend.text = element_text(colour = "black", size = 10),
        legend.title = element_text(colour = "black", size = 11, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))



############################################
#2 hosp and vaccination over time ############
############################################

#cum vac over time 

vac_alltype1 <- vacc_BUND %>%filter(dose==1)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype1 <- vac_alltype1 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype1$vac_n_cum <- cumsum(vac_alltype1$vac_n)
vac_alltype1$dose <- 1

vac_alltype2 <- vacc_BUND %>%filter(dose==2)%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype2 <- vac_alltype2 %>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype2$vac_n_cum <- cumsum(vac_alltype2$vac_n)
vac_alltype2$dose <- 2

vac_alltype3 <- vacc_BUND %>%filter(dose=="booster")%>% group_by(rep_date) %>%
  summarise_if(is.numeric, sum)
vac_alltype3 <- vac_alltype3%>% dplyr::select(-c("vac_week"))# delete vac_week as it's wrong due to previous step
vac_alltype3$vac_n_cum <- cumsum(vac_alltype3$vac_n)
vac_alltype3$dose <- "booster"

vac_alltype <- rbind(vac_alltype1,vac_alltype2,vac_alltype3)
rm(vac_alltype1,vac_alltype2,vac_alltype3)

dummy <- melt(hosp, id.vars = c(1:2,6:8)) # 
# dummy %>%  
p2 <- ggplot() + 
  geom_area(data=dummy, aes(x=rep_date, y=value, fill=variable))+
  # geom_line(data=vac_alltype,aes(x = rep_date,y=vac_n_cum/NRW_pop_vacc*100*60, color = dose),size=2)+
  # scale_y_continuous(sec.axis = sec_axis(breaks=seq(0,600,by= 120),labels = seq(0,100,by=20),~ . *6/60, name = "Accumulative vaccination (%) "))+
    scale_fill_manual(values=c("#084081", "#2b8cbe", "#7bccc4"), name="Hospitalised status")+
     scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", 
               limits = c(as.Date("2020-03-01"),as.Date("2021-12-31")),
               expand = c(0, 0))+
  labs(x = " ", y = "Daily prevalence") +
  ggtitle("Hospitalised stay attributed to Covid-19 in NRW")+
  # facet_wrap(~ hosp)+
  theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        legend.background = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.18,0.62),
        legend.text = element_text(colour = "black", size = 10),
        legend.title = element_text(colour = "black", size = 11, face = "bold"),
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))




###########################
#3 Prop_reported hospitalisation
###########################

dummy <- dat%>%filter(hosp=="Ja")%>%
  group_by(rep_week,rep_week_date, agegroup2,pop_n) %>% dplyr::summarise(case_n=n())

palette <- c("#253494","#2c7fb8","#41b6c4","#7fcdbb","#c7e9b4","#ffffcc" )  

p3 <- dummy %>%
  ggplot(aes(x=rep_week_date, y=case_n, fill=agegroup2))+
  geom_bar(position="fill", stat="identity")+
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values=palette, name="Age group") +
   labs(y="",x=" ")+
  ggtitle(" Hospitalisation attributed to COVID-19 in NRW_weekly report")+
 scale_x_date(date_labels="%Y-%m-%d", date_breaks = "14 days", expand = c(0, 0)) +
theme_classic()+
  theme(axis.text.x = element_text(colour = "black", size = 10, angle = 90, hjust = 0.5, vjust = 0,5),
        axis.text.y = element_text(colour = "black", size = 12, face = "bold"),
        axis.title = element_text(colour = "black", size = 12, face = "bold"),
        # legend.background = element_blank(),
        # legend.key = element_blank(),
        # legend.position = c(0.18,0.62),
        # legend.text = element_text(colour = "black", size = 10),
        # legend.title = element_text(colour = "black", size = 11, face = "bold"),
        legend.position = "none",
        plot.title = element_text(colour = "black", size = 14, face = "bold",hjust = 0.5),
        strip.text = element_text(colour = "black", size = 10, face = "bold"))




########################################
# combine plots into panel 
########################################

# multiple plots in the same page 
panel <- ggarrange(p1 +rremove("x.text") , 
          p2 +rremove("x.text"),
          p3,
         labels = c("A", "B","C"),
         align = "v",
        ncol = 1, nrow = 3)

annotate_figure(panel, 
                left = textGrob("", rot = 90, vjust = 0.5, gp = gpar(cex = 1.5)))
           

```


# SES 

* NRW social economic status
ref: https://github.com/lekroll/GISD

In order to be able to map regional differences in socioeconomic status, the German Index of Social Deprivation is used (Kroll et al. 2018, p. 105).
The index is composed of the three equally weighted dimensions of education, occupation and income.
The data underlying the dimensions are provided by the Indicators and Maps of Spatial and Urban Development (INKAR) database of the Federal Institute for Research on Building, Urban Affairs and Spatial Development (Bundesinstitut fr Bau-, Stadt- und Raumforschung 2020 /

https://www.bbsr.bund.de/BBSR/EN/home/_node.html;jsessionid=5D48C9E3CCEE2DF7D9A30B3C58D7986E.live21324).
Indicators were selected which were available as time series from 1998 to 2012 (in the current version of the index used here, until 2014). If this was not the case, the missing values of the respective variables were imputed using regression analyses.

```{r}

#GISD5
legend_label=c("1", "2", "3","4","5")

panel_gisd5  <- tm_shape(gisd) +
  tm_fill("GISD_Score", palette = "Blues", legend.show = F) + #
  tm_borders("black") +
  tm_add_legend(title = "Deprivation index", labels = legend_label, col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = "Social econmic status", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# panel_gisd5 

# pop
panel_pop <- tm_shape(gisd) +
  tm_fill("pop.dens", palette = "Blues", legend.show = T) + #
  tm_borders("black") +
  # tm_add_legend(title = "Deprivation index", col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = "Pop density \n per km sq", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
 
#panel_pop
# multiple plots in the same page 
current.mode <- tmap_mode("plot")
tmap_arrange(panel_gisd5,panel_pop, widths = c(0.5, 0.5))
tmap_mode(current.mode)

```


# Mapping


At the start, the incidences are still small. The incidence grouping should also be small to see the difference among counties. So the color visualization is to compare within the wave. However, from wave two onward, the scale is similar.  

For across waves comparison, please notice the legend!

Testing volumes may have been insufficient early in the pandemic.

Average case per week in each wave may be more comparable due to different length in each wave. 


##Wave1

```{r}
title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"



nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave1","pop_n")%>%
  mutate(incper10k = case_wave1/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,10,15,20,25,30,35,40,45,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID") #by = "NUTS_ID"


#copy abow where appropriate
legend_label=c("0-10",">10-15",">15-20", ">20-25", ">25-30", ">30-35", ">35-40", ">40-45",">45")

w1 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Purples", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

# w1

# continuous scale
w1c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave1", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")


```

##Wave 2

```{r}

# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"




nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave2","pop_n")%>%
  mutate(incper10k = case_wave2/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

w2 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w2


# continuous scale
w2c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave2", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

```

##Wave 3 

```{r}
# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"



nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave3","pop_n")%>%
  mutate(incper10k = case_wave3/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

w3 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w3
# continuous scale
w3c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave3", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")


```

##Wave 4 

```{r}
# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
title <-"COVID-19 reported_W4\n 13.07-29.12.2021"
# titlel<-"COVID-19 reported\n 27.02.20-30.12.21"

wave <- dat_county %>% select("NUTS_ID", "case_wave4","pop_n")
wave$incper10000<- wave$case_wave4/wave$pop_n*10000





nuts3_case <- dat_county %>%select("NUTS_ID", "case_wave4","pop_n")%>%
  mutate(incper10k = case_wave4/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

w4 <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w4
# continuous scale
w4c <- tm_shape(nuts3_case) +
  # tm_fill("incper10k", palette = "Purples", legend.show = T) + #Blues
  tm_fill("case_wave4", palette = "Purples", legend.show = T) + #Blues
  tm_borders("black") +
  # tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")


```

##entire pandamic and 4 waves

Criteria for defining a wave?

```{r}
# title <-"COVID-19 reported_W1\n 27.02-30.06.2020"
# title <-"COVID-19 reported_W2\n 01.07-22.02.2021"
# title <-"COVID-19 reported_W3\n 23.02-12.07.2021"
# title <-"COVID-19 reported_W4\n 13.07-30.12.2021"
title <-"COVID-19 reported_4waves\n 27.02.20-29.12.21"


nuts3_case <- dat_county %>%select("NUTS_ID", "cases","pop_n")%>%
  mutate(incper10k = cases/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,550,600,650,700,750,800,850,900,Inf)))

nuts3_case <-merge(nuts3, nuts3_case , by = "NUTS_ID")

#label
legend_label=c(">450-550", ">550-600",">600-650", ">650-700",">700-750", ">750-800", ">800-850", ">850-900",">900")

w_all <- tm_shape(nuts3_case) +
  tm_fill("incper10k_group", palette = "Oranges", legend.show = F) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Oranges")) +
  # \n : line down
  tm_layout(title = paste0(title), title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.85,0.0), legend.width = 1,
            legend.title.size = 1.5, legend.text.size= 1.2,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# w_all



# multiple plots in the same page 
current.mode <- tmap_mode("plot")
tmap_arrange(panel_gisd5,w_all, widths = c(0.5, 0.5))
tmap_mode(current.mode)


```


```{r}

# # multiple plots in the same page 
# ggpubr:: ggarrange(tmap_grob(w1), # tmap_grob: convert tmap into grob
#                    tmap_grob(w2),
#                    tmap_grob(w3),
#                    tmap_grob(w4),
#                    # labels = c("A", "B"),
#                    ncol = 2, nrow = 2)

current.mode <- tmap_mode("plot")
tmap_arrange(w1, w2, w3, w4, widths = c(0.5, 0.5))
tmap_mode(current.mode)

# absolute number
current.mode <- tmap_mode("plot")
tmap_arrange(w1c, w2c, w3c, w4c, widths = c(0.5, 0.5))
tmap_mode(current.mode)


```

## panel
define wave option 1

```{r}


#####################################
#1 SES
####################################
legend_label=c("1", "2", "3","4","5")

p1 <- tm_shape(gisd) +
  tm_fill("GISD_5", palette = "Blues", legend.show = T,
          title = "Deprivation index",
          legend.is.portrait = FALSE) + #
  tm_borders("black") +
  # tm_add_legend(title = "Deprivation index", labels = legend_label, col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.6)+ # add name of each county
  # \n : line down
  tm_layout(title = "SES", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.09,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.7,0.05), legend.width = 10,
            legend.title.size = 1, legend.text.size= 1,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

######################################
#2pop density 
#####################################

p2 <- tm_shape(gisd) +
  tm_fill("pop.dens", palette = "Blues", legend.show = T) + #
  tm_borders("black") +
  # tm_add_legend(title = "Deprivation index", col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  # tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = "Pop density \n per km sq", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")




##################################
#3 Wave1
#################################

dummy <- dat_county %>%select("NUTS_ID", "case_wave1","pop_n")%>%
  mutate(incper10k = case_wave1/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,10,15,20,25,30,35,40,45,Inf)))

dummy <-merge(nuts3, dummy , by = "NUTS_ID") #by = "NUTS_ID"


#copy abow where appropriate
legend_label=c("0-10",">10-15",">15-20", ">20-25", ">25-30", ">30-35", ">35-40", ">40-45",">45")

p3 <- tm_shape(dummy) +
  tm_fill("incper10k_group", palette = "Purples", legend.show = F,
          legend.is.portrait = FALSE) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  # \n : line down
  tm_layout(title = "Wave1", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

##################################
#4 Wave2
#################################

dummy<- dat_county %>%select("NUTS_ID", "case_wave2","pop_n")%>%
  mutate(incper10k = case_wave2/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

dummy<-merge(nuts3, dummy, by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

p4 <- tm_shape(dummy) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F,legend.is.portrait = FALSE) + #Blues
    tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = "Wave2", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

##################################
#5 Wave3
#################################

dummy<- dat_county %>%select("NUTS_ID", "case_wave3","pop_n")%>%
  mutate(incper10k = case_wave3/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

dummy<-merge(nuts3, dummy, by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

p5 <- tm_shape(dummy) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F,legend.is.portrait = FALSE) + #Blues
    tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = "Wave3", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

##################################
#6 Wave4
#################################

dummy<- dat_county %>%select("NUTS_ID", "case_wave4","pop_n")%>%
  mutate(incper10k = case_wave4/pop_n*10000)%>%
  mutate(incper10k_group = cut(incper10k, breaks=c(-Inf,150,175,200,225,250,275,300,350,Inf)))

dummy<-merge(nuts3, dummy, by = "NUTS_ID")

#label
legend_label=c("0-150", ">150-175", ">175-200",">200-225", ">225-250", ">250-275", ">275-300", ">300-350", ">350")

p6 <- tm_shape(dummy) +
  tm_fill("incper10k_group", palette = "Blues", legend.show = F,legend.is.portrait = FALSE) + #Blues
    tm_borders("black") +
  tm_add_legend(title = "Incidence \n (per 10k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = "Wave4", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

# multiple plots in the same page 
current.mode <- tmap_mode("plot")
tmap_arrange(p1,p3,p4,p2,p5,p6, widths = c(1/6, 1/6,1/6,1/6,1/6,1/6))
tmap_mode(current.mode)



```

## panel_duration
define wave option 1, take duration of each wave into account
W1: 30
W2: 20
W3: 17
W4: 22

```{r}


#####################################
#1 SES
####################################
legend_label=c("1", "2", "3","4","5")

p1 <- tm_shape(gisd) +
  tm_fill("GISD_5", palette = "Blues", legend.show = T,
          title = "Deprivation index",
          legend.is.portrait = FALSE) + #
  tm_borders("black") +
  # tm_add_legend(title = "Deprivation index", labels = legend_label, col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  tm_text("county", just = "bottom", size = 0.6)+ # add name of each county
  # \n : line down
  tm_layout(title = "SES", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.09,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.7,0.05), legend.width = 10,
            legend.title.size = 1, legend.text.size= 1,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

######################################
#2pop density 
#####################################

p2 <- tm_shape(gisd) +
  tm_fill("pop.dens", palette = "Blues", legend.show = T) + #
  tm_borders("black") +
  # tm_add_legend(title = "Deprivation index", col = RColorBrewer::brewer.pal(5, "Blues")) +
  tm_dots(size = 0.2) +
  # tm_text("county", just = "bottom", size = 0.7)+ # add name of each county
  # \n : line down
  tm_layout(title = "Pop density \n per km sq", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")




##################################
#3 Wave1
#################################

dummy <- dat_county %>%select("NUTS_ID", "case_wave1","pop_n")%>%
  mutate(incper100k = case_wave1/10/pop_n*100000)%>%
  mutate(incper100k_group = cut(incper100k, breaks=c(-Inf,5,10,15,20,25,30,35,40,Inf)))

dummy <-merge(nuts3, dummy , by = "NUTS_ID") #by = "NUTS_ID"


#copy abow where appropriate
legend_label=c("0-5",">5-10",">10-15",">15-20", ">20-25", ">25-30",">30-35",">35-40",">40")

p3<- tm_shape(dummy) +
  tm_fill("incper100k", palette = "Purples", legend.show = F,
          legend.is.portrait = T) + #Blues
  tm_borders("black") +
  tm_add_legend(title = "Ave.Inc.perweek \n (per 100k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Purples")) +
  # # \n : line down
  tm_layout(title = "Wave1", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

##################################
#4 Wave2
#################################

dummy<- dat_county %>%select("NUTS_ID", "case_wave2","pop_n")%>%
  mutate(incper100k = case_wave2/20/pop_n*100000)%>%
  mutate(incper100k_group = cut(incper100k, breaks=c(-Inf,75,90,105,120,135,150,165,170,Inf)))

dummy<-merge(nuts3, dummy, by = "NUTS_ID")

#label
legend_label=c("0-75", "75-90", "90-105","105-125", "125-135", "135-150", "150-165", "165-170",">170")

p4 <- tm_shape(dummy) +
  tm_fill("incper100k_group", palette = "Blues", legend.show = F,legend.is.portrait = FALSE) + #Blues
    tm_borders("black") +
  tm_add_legend(title = "Ave.Inc.perweek \n (per 100k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = "Wave2", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")

##################################
#5 Wave3
#################################

dummy<- dat_county %>%select("NUTS_ID", "case_wave3","pop_n")%>%
  mutate(incper100k = case_wave3/17/pop_n*100000)%>%
  mutate(incper100k_group = cut(incper100k, breaks=c(-Inf,75,90,105,120,135,150,165,170,Inf)))

dummy<-merge(nuts3, dummy, by = "NUTS_ID")

#label
legend_label=c("0-75", "75-90", "90-105","105-125", "125-135", "135-150", "150-165", "165-170",">170")

p5 <- tm_shape(dummy) +
  tm_fill("incper100k_group", palette = "Blues", legend.show = F,legend.is.portrait = FALSE) + #Blues
    tm_borders("black") +
  tm_add_legend(title = "Ave.Inc.perweek \n (per 100k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = "Wave3", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
##################################
#6 Wave4
#################################

dummy<- dat_county %>%select("NUTS_ID", "case_wave4","pop_n")%>%
  mutate(incper100k = case_wave4/22.28/pop_n*100000)%>% # 2 extra day 28,29/12
  mutate(incper100k_group = cut(incper100k, breaks=c(-Inf,75,90,105,120,135,150,165,170,Inf)))

dummy<-merge(nuts3, dummy, by = "NUTS_ID")

#label
legend_label=c("0-75", "75-90", "90-105","105-125", "125-135", "135-150", "150-165", "165-170",">170")

p6 <- tm_shape(dummy) +
  tm_fill("incper100k_group", palette = "Blues", legend.show = F,legend.is.portrait = FALSE) + #Blues
    tm_borders("black") +
  tm_add_legend(title = "Ave.Inc.perweek \n (per 100k)", labels = legend_label, col = RColorBrewer::brewer.pal(9, "Blues")) +
  # \n : line down
  tm_layout(title = "Wave4", title.fontfamily = "sans", title.size = 1.5,
            title.fontface= "bold", title.position= c(0.1,0.9),frame=F,
            legend.outside = F, legend.frame = F,
            legend.position = c(0.8,0.0), legend.width = 1,
            legend.title.size = 1, legend.text.size= 0.8,
            legend.title.fontfamily ="sans",legend.title.fontface ="bold")
# multiple plots in the same page 
current.mode <- tmap_mode("plot")
tmap_arrange(p1,p3,p4,p2,p5,p6, widths = c(1/6, 1/6,1/6,1/6,1/6,1/6))
tmap_mode(current.mode)



```

# Heatmap: by county


## Group scale 

```{r}

# data at week level 
dat_week <- dat %>%group_by(rep_week_date,county)%>% summarise(case =  n())
dat_week <- merge(dat_week, gisd %>%select(county,pop_n, GISD_5), by = "county")
dat_week$case_per100k<- dat_week$case/dat_week$pop_n*100000

#division 0
# dat_week$case_per100k_grouped <- cut(dat_week$case_per100k, breaks=c(-Inf, 5, 10, 15, 20,25,100,200,300,400,Inf))
dat_week$case_per100k_grouped <- cut(dat_week$case_per100k, breaks=c(-Inf, 25, 50, 75, 100,150,200,250,300,350,400,Inf))




# #label
legend_label=c("0-25", ">25-50", ">50-75",">75-100", ">100-150", ">150-200",">200-250", ">250-300",">300-350", ">350-400", ">400")

dat_week %>%
  ggplot(aes(rep_week_date,county)) +
  geom_tile(aes(fill=case_per100k_grouped ), colour = "black")+
  geom_text(aes(label = round(case_per100k )), size = 1, colour = "#585858") + #size of number in each cell
  #division 0
  scale_fill_manual(values=c("#FFF7FC","#EDE7F3", "#D0D1E6", "#A6BDDC", "#74AAD0",
                             "#3691C0", "#0470B0", "#044E7B", "#333F50", "#404040", "#262626"),
                    label = legend_label) +
  ## division 1,2,3
  # scale_fill_brewer(palette = "Blues")+ #BuPu, BuGn, Blues, Oranges,Reds,....
  labs(fill = "incidence \n(per 100k)", x="", y="")+
  ggtitle("NRW_ weekly COVID-19 Incidence per 100k ")+
  # facet_wrap(~GISD_5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position="right",
        legend.title=element_text(size=18, colour = "black", face = "bold") ,
        legend.text=element_text(size=17, colour = "black"),
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=18, hjust=0.5),
        axis.text.x = element_text(size = 8,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 8, face = "bold")) + 
  scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0)) +
  # scale_x_continuous(expand=c(0,0)) +
  scale_y_discrete(expand=c(0,0))



```

## Continuous scale

```{r}


# continues scale
ggplot(dat_week, aes(rep_week_date, county)) +
  geom_tile(aes(fill = case_per100k)) +
  # coord_equal() +
  # ggtitle(paste0("Wave ", wave_n)) +
  # geom_text(aes(label=sprintf("%0.1f", round(case_per100k, digits = 2))), size = 2) +
  scale_fill_gradient2(low = "white",
                       # mid = "white",
                       high = "blue", limits = c(0,600), midpoint = 12) +
  guides(fill = guide_colourbar(barwidth = 0.5,
                                 barheight = 5, title = "Incidence \n(per100k)")) +
 scale_x_date(date_labels="%Y-%m-%m", date_breaks = "30 days", expand = c(0, 0))+
  # scale_x_date(breaks = unique(dat_week$rep_week_date))+ # display all dates on x axis
   ggtitle("NRW_ weekly COVID-19 Incidence per 100k ")+
  theme(legend.position = "right")+
  theme(plot.title = element_text(size = 10, face = "bold",hjust = 0.5),
        axis.title = element_blank(),
        axis.text.x = element_text(size = 6, face = "bold",angle = 30, vjust = 0.5),
        axis.text.y = element_text(size = 8, face = "bold"),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm"), # reduce space for combination plot later
             panel.background = element_blank())


```

## Add SES annotation

COVID-19 incidence in each county over time vs social economic status
### by week

```{r}

# Heat map with deprivation index (GISD) annotation
dat_week_long <- dat_week %>% select(GISD_5,county,rep_week_date,case_per100k)
dat_week_long <- dat_week_long[order(dat_week_long$rep_week_date),] # sort data by time report

dat_week_long <- dat_week_long %>%
  pivot_wider(names_from = rep_week_date, values_from = case_per100k)#Transposing row values to colum
dat_week_long <- dat_week_long[order(dat_week_long$GISD_5),] # sort data by GISD

#annotation set
label_gisd <- dat_week_long %>% select(county,GISD_5)# prepare for anotation heatmap
rownames(label_gisd ) <- label_gisd$county
label_gisd <- as.data.frame(label_gisd)
label_gisd$GISD_5 <- as.character(label_gisd$GISD_5)
label_gisd <- label_gisd[,-1, drop=F] # avoid row name disappear
colnames(label_gisd) <- c("Deprivation_index")

dat_week_long <- dat_week_long[,-1]# rm GISD
rownames(dat_week_long) <- dat_week_long$county # convert county into rownames
dat_week_long <- as.data.frame((dat_week_long )) # matrix for heatmap
dat_week_long <- dat_week_long [,-1, drop=F]  # avoid row name disappear

annotation_colors = list(
 Deprivation_index = c("1"="#9e9ac8","2"="#807dba","3"="#6a51a3","4"="#54278f","5"="#3f007d"))

pheatmap(dat_week_long,cluster_rows = F, cluster_cols = F,RColorBrewer::brewer.pal(name = "Blues", n =9), annotation_row = label_gisd,
         annotation_colors= annotation_colors,annotation_names_row=F,
           fontsize = 10,fontsize_row =7,fontsize_col = 6, legend_breaks = c(100, 200, 300, 400,500),
         main = "NRW_ weekly COVID-19 Incidence per 100k ", legend_labels = c("100", "200", "300", "400","500"), legend = T,)



# ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

### by wave

The average number of case per week in each wave

```{r}

# # Heat map with deprivation index (GISD) annotation
# dat_county_long <- dat_county %>% select(GISD_5,county,contains("perwk"))
# 
# dat_county_long <- dat_county_long[order(dat_county_long$GISD_5),] # sort data by GISD index
# #annotation set
# label_gisd <- dat_county_long %>% select(county,GISD_5)# prepare for anotation heatmap
# rownames(label_gisd ) <- label_gisd$county
# label_gisd <- as.data.frame(label_gisd)
# label_gisd$GISD_5 <- as.character(label_gisd$GISD_5)
# label_gisd <- label_gisd[,-1, drop=F] # avoid row name disappear
# colnames(label_gisd) <- c("Deprivation_index")
# dat_county_long <- dat_county_long[,-1]# rm GISD
# rownames(dat_county_long) <- dat_county_long$county # convert county into rownames
# dat_county_long <- as.data.frame((dat_county_long )) # matrix for heatmap
# dat_county_long <- dat_county_long [,-1, drop= F]  # avoid row name disappear
# colnames(dat_county_long) <- c("wave1","wave2", "wave3", "wave4") # rename cols
# annotation_colors = list(
#  Deprivation_index = c("1"="#9e9ac8","2"="#807dba","3"="#6a51a3","4"="#54278f","5"="#3f007d"))
# 
# pheatmap(dat_county_long,cluster_rows = F, cluster_cols = F,RColorBrewer::brewer.pal(name = "Blues", n =9), annotation_row = label_gisd,
#          annotation_colors= annotation_colors,annotation_names_row=F,
#         fontsize = 10,fontsize_row =7,fontsize_col = 6,
#         # legend_breaks = c(100, 200, 300, 400,500),
#         main = "Average infections per week per 100k inhatbitants", 
#         # legend_labels = c("100", "200", "300", "400","500"), 
#         legend = T, angle_col = 0)
# 
# 
# 
# # ggsave(paste0(path_results,"  ",".png"),com_FIG_1, width=13, height=8)


```

# Regulation

## NRW level

```{r}

dummy <- reg_bund[order(reg_bund$m_code, decreasing = T),] # sort data by m_code
dummy <- reg_bund
dummy$NPI <- dummy$m_code
#label intervention code
dummy$NPI[dummy$NPI=="M01a"] <- "Group gathering_private"
dummy$NPI[dummy$NPI=="M01b"] <- "Group gathering_Public"
dummy$NPI[dummy$NPI=="M02a"] <- "School_Secondary"
dummy$NPI[dummy$NPI=="M02b"] <- "School_Primary "
dummy$NPI[dummy$NPI=="M03"] <- "Schools/daycares_Nursery "
dummy$NPI[dummy$NPI=="M04"] <- "Public events_Indoor "
dummy$NPI[dummy$NPI=="M05"] <- "Public events_Outdoor "
dummy$NPI[dummy$NPI=="M06"] <- "Culteral& educational institution"
dummy$NPI[dummy$NPI=="M07"] <- "Wholesale&retail"
dummy$NPI[dummy$NPI=="M08"] <- "Food service industry"
dummy$NPI[dummy$NPI=="M09"] <- "Service& craftsmanship"
dummy$NPI[dummy$NPI=="M10"] <- "Nightlife facilities"
dummy$NPI[dummy$NPI=="M11"] <- "Accomodation"
dummy$NPI[dummy$NPI=="M12"] <- "Sports_Indoor "
dummy$NPI[dummy$NPI=="M13"] <- "Sports_Outdoor"
dummy$NPI[dummy$NPI=="M14"] <- "Travel_Domestic "
dummy$NPI[dummy$NPI=="M15"] <- "Travel_International"
dummy$NPI[dummy$NPI=="M16"] <- "Mask mandate"
dummy$NPI[dummy$NPI=="M17"] <- "Workplace restriction"
dummy$NPI[dummy$NPI=="M18"] <- "Curfew"
dummy$NPI[dummy$NPI=="M19"] <- "Capacity constraints in public transport"
dummy$NPI[dummy$NPI=="M20"] <- "Distance regulation"
dummy$NPI[dummy$NPI=="M21"] <- "Test measures"


dummy %>%
  ggplot(aes(date,NPI)) +
  geom_tile(aes(fill=measure_imp ))+
  scale_fill_manual(values=c("#f5f5f5","#fc8d59"),
                    label = c("No","Yes")) +
  labs(fill = "Measure \n implement", x="", y="")+
  ggtitle("Measures against spreading of COVID-19 in NRW")+
  # facet_wrap(~GISD_5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        # legend.position="right",
        # legend.title=element_text(size=18, colour = "black", face = "bold") ,
        # legend.text=element_text(size=17, colour = "black"),
        legend.position = "none",
        axis.title = element_text(size=18, face="bold", colour = "black"),
        plot.title = element_text(face="bold", size=18, hjust=0.5),
        axis.text.x = element_text(size = 8,  hjust = 1, colour = "black", angle = 30, face = "bold"),
        axis.text.y = element_text(size = 8, face = "bold")) + 
  scale_x_date(date_labels="%Y-%m-%m", date_breaks = "21 days",expand = c(0, 0)) +
  scale_y_discrete(expand=c(0,0))


# ggsave(paste0(path_result,"/regulations/regulation_NRW.png"),p)

```
 
##County level

```{r}

# # for loop measures at 53 counties in NRW
# kreis_ls <- unique(reg_lk$kreis)
# plot_list <- list() # for storing each loop cycle result
# 
# for( i in (1:length(kreis_ls))){
# kreis = kreis_ls[i]
# reg <- reg_lk %>% filter(kreis == kreis_ls[i])
# reg <- reg %>% select(-c(ags2, bundesland, ags5,kreis))
# 
# reg<- pivot_longer(reg, cols=2:dim(reg)[2], names_to = "date", values_to = "measure_imp") # transpose from cols to rows
# reg$date <- gsub("^.{0,1}", "", reg$date)# Replace first character () with empty string ""
# reg$date <- as.Date(reg$date , format="%Y%m%d")
# reg$measure_imp <- as.factor(reg$measure_imp)
# 
#  p <- reg%>%
#   ggplot(aes(date,m_code)) +
#   geom_tile(aes(fill=measure_imp ))+
#   scale_fill_manual(values=c("#ffffbf","#fc8d59"),
#                     label = c("No","Yes")) +
#   labs(fill = "Measure \n implement", x="", y=" Measures")+
#   ggtitle(paste0("Measures against spreading of COVID-19 in ", kreis))+
#   # facet_wrap(~GISD_5)+
#   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#         panel.background = element_blank(), axis.line = element_line(colour = "black"),
#         legend.position="right",
#         legend.title=element_text(size=18, colour = "black", face = "bold") ,
#         legend.text=element_text(size=17, colour = "black"),
#         axis.title = element_text(size=18, face="bold", colour = "black"),
#         plot.title = element_text(face="bold", size=18, hjust=0.5),
#         axis.text.x = element_text(size = 8,  hjust = 1, colour = "black", angle = 30, face = "bold"),
#         axis.text.y = element_text(size = 8, face = "bold")) + 
#   scale_x_date(date_labels="%Y-%m-%m", date_breaks = "21 days",expand = c(0, 0)) +
#   scale_y_discrete(expand=c(0,0))
# 
# plot_list[[i]] <- p # store plots in the list
# ggsave(paste0(path_result,"/regulations/regulation_",kreis,".png"),p)
# }

```


# statistical analysis

```{r}
# seed(123456789)
# dummy <- dat_county
# dummy$GISD_5 <- as.factor(dummy$GISD_5)
# ggplot(dummy,aes(GISD_5, case_wave4))+
#   geom_boxplot()+
#   ylim(0,10000)+
#   ggtitle("Wave4")N
#   # facet_wrap(~GISD_5)
# 
# hist(dummy$cases, breaks = 20)
# hist(log(dummy$case_wave3), breaks = 5)
# 
# fit <- glm(log(case_wave4) ~ GISD_5, data =dummy)
# summary(fit)
# 
# 
# ggplot(dummy,aes(GISD_5))+
#   geom_boxplot(aes(y = case_wave1, colour = "case_wave1"),position = position_dodge(width = 0.1))+
#   geom_boxplot(aes(y = case_wave2, colour = "case_wave2"),position = position_dodge(width = 0.4))+
#   geom_boxplot(aes(y = case_wave3, colour = "case_wave3"),position = position_dodge(width = 0.7))+
#   geom_boxplot(aes(y = case_wave4, colour = "case_wave4"),position = position_dodge(width = 1))+
#   ylim(0,18000)
  

```

